<!doctype html>
<html lang="pt-br"><head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fiscal Flash ‚Äì Simulador Tribut√°rio Inteligente</title>
  <meta name="theme-color" content="#1E3A8A">
  <!-- Tailwind CDN n√£o √© carregado; utilities necess√°rias est√£o embutidas inline e o tema usa tokens customizados. -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" integrity="sha384-JUh163oCRItcbPme8pYnROHQMC6fNKTBWtRG3I3I0erJkzNgL7uxKlNwcrcFKeqF" crossorigin="anonymous" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="https://7e822546f79b1a7746471be9da62e5ce.cdn.bubble.io/cdn-cgi/image/w=96,h=,f=auto,dpr=0.75,fit=contain/f1710268567887x186266228312094600/01%20%281%29.png">
  <style>
    /*
      Fiscal Flash ‚Äì Tema adaptado (2025)

      Este CSS substitui Tailwind e define tokens de cores inspirados nas tend√™ncias de 2025.
      Paletas mais suaves e aconchegantes no modo claro e tons escuros de azul no modo escuro.
      Consulte design trends (TheeDigital) para cores de conforto digital„Äê931423127781675‚Ä†L152-L160„Äë
      e pr√°ticas de dark mode (DesignModo) para contrastes adequados„Äê906550038208‚Ä†L246-L277„Äë.
    */
    :root{
      /* Light mode tokens */
      --bg:#F9FAFB;                /* fundo geral (AGENTS.md: Fundo Light) */
      --surface:#FFFFFF;           /* cart√µes e pain√©is */
      --surface-soft:#F2F3F7;      /* superf√≠cies secund√°rias */
      --accent:#1E3A8A;            /* Azul Real (primary) */
      --accent-2:#10B981;          /* Verde Lima (secondary) */
      --accent-soft:#EAF2FF;       /* azul claro para destaques */
      --border:#E4E7EE;            /* linha divis√≥ria suave */
      --border-strong:#CBD5E0;     /* linha mais forte */
      --text-strong:#111827;       /* Grafite Escuro (texto principal) */
      --text-muted:#52647A;        /* texto secund√°rio */
      --text-light:#7E8CA5;        /* texto auxiliar */
      --shadow-md:0 10px 24px -12px rgba(17,24,39,.15);
      --shadow-lg:0 24px 48px -20px rgba(17,24,39,.2);
      --focus-ring:0 0 0 3px rgba(47,97,191,.25);
      --space:1.5rem;              /* espa√ßamento base */
    }
    :root[data-theme='dark']{
      /* Dark mode tokens ‚Äì inspirado em dark mode best practices„Äê906550038208‚Ä†L246-L277„Äë */
      /*
        Dark mode tokens (atualizados)

        Inspirado nas melhores pr√°ticas de design de dark mode,
        que recomendam evitar preto puro e cores saturadas„Äê325428528500567‚Ä†L109-L143„Äë, e usar tons de cinza/azul escuro
        com cores de destaque desaturadas e superf√≠cies mais claras para
        indicar eleva√ß√£o„Äê325428528500567‚Ä†L123-L144„Äë. As seguintes cores foram ajustadas para
        fornecer contraste adequado e suavidade.
      */
      --bg:#0E1A2C;               /* fundo base (azul marinho profundo) */
      --surface:#1A2F4A;          /* cart√µes e pain√©is (cinza-azul um pouco mais claro) */
      --surface-soft:#14213D;     /* superf√≠cies secund√°rias (mais escuro) */
      --accent:#3A6BC0;           /* azul prim√°rio desaturado */
      --accent-2:#2BAD77;         /* verde secund√°rio desaturado */
      --accent-soft:#1E2C4C;      /* fundo para se√ß√µes destacadas */
      --border:#253D5C;           /* linhas sutis */
      --border-strong:#2F4569;    /* linhas mais fortes */
      --text-strong:#ECEFF4;      /* texto principal claro */
      --text-muted:#A8B3C4;       /* texto secund√°rio */
      --text-light:#76879F;       /* texto auxiliar (ligeiramente mais claro) */
      --shadow-md:0 10px 24px -12px rgba(0,0,0,.55);
      --shadow-lg:0 24px 48px -20px rgba(0,0,0,.65);
      --focus-ring:0 0 0 3px rgba(58,107,192,.35);
    }
    /* Ajustes de contraste para tema escuro */
    :root[data-theme='dark'] .text-slate-800,
    :root[data-theme='dark'] .text-slate-700{ color:var(--text-strong) !important }
    :root[data-theme='dark'] .text-slate-600,
    :root[data-theme='dark'] .text-slate-500{ color:var(--text-muted) !important }
    :root[data-theme='dark'] .text-slate-400,
    :root[data-theme='dark'] .text-slate-300{ color:var(--text-light) !important }
    :root[data-theme='dark'] .text-indigo-700{ color:var(--accent) !important }
    :root[data-theme='dark'] .bg-slate-50,
    :root[data-theme='dark'] .bg-slate-100{ background:var(--surface-soft) !important }
    :root[data-theme='dark'] .btn-soft:hover{ background:var(--surface-soft) }
    :root[data-theme='dark'] .brand-icon::before{ content:"üåô" !important }
    :root[data-theme='light'] .brand-icon::before{ content:"üßÆ" !important }
    body{
      background:var(--bg);
      color:var(--text-strong);
      font-family:'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      /* Mantemos o color-scheme para que elementos nativos (scrollbars) adaptem-se */
      color-scheme:light dark;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .number-input{text-align:right}
    .card{background:var(--surface);border-radius:1.15rem;box-shadow:var(--shadow-lg);padding:var(--space);border:1px solid var(--border)}
    .card h2{color:var(--text-strong);letter-spacing:-.01em}
    .card p.text-sm,.card label{color:var(--text-muted)}
    .card input[type="text"],.card input[type="number"],.card select,.section-block input[type="text"],.section-block input[type="number"],.section-block select{border:1px solid var(--border);border-radius:.85rem;padding:.68rem .9rem;background:var(--surface);width:100%;transition:border-color .2s ease,box-shadow .2s ease,transform .2s ease;font-size:.95rem}
    .card input[type="text"]:hover,.card input[type="number"]:hover,.card select:hover,.section-block input[type="text"]:hover,.section-block input[type="number"]:hover,.section-block select:hover{border-color:var(--border-strong)}
    .card input[type="text"]:focus,.card input[type="number"]:focus,.card select:focus,.section-block input[type="text"]:focus,.section-block input[type="number"]:focus,.section-block select:focus{outline:none;border-color:var(--accent);box-shadow:var(--focus-ring)}
    .tbl td{padding:.5rem .25rem;border-bottom:1px solid var(--border)}
    .tbl th{padding:.5rem .25rem;text-align:left;border-bottom:2px solid var(--border);color:var(--text-muted);font-weight:600}
    .tbl tfoot td{font-weight:700;border-top:2px solid var(--border);border-bottom:0}
    .tbl col.col-nome{width:42%}
    .tbl col.col-base,.tbl col.col-aliq,.tbl col.col-valor{width:19%;min-width:7rem}
    .tbl td:not(:first-child),.tbl th:not(:first-child){text-align:right}
    .tbl td,.tbl th{vertical-align:middle;white-space:nowrap}
    .tbl td:first-child,.tbl th:first-child{white-space:normal}
    /* Resumo: permitir quebra no cabe√ßalho para cen√°rios longos */
    .tbl.tbl-resumo th{white-space:normal;word-break:break-word;line-height:1.25}
    .tbl.tbl-resumo col.col-tributo{width:28%}
    .tbl.tbl-resumo col.col-bloco{width:24%}
    .cell-stack>div+div{margin-top:.15rem}
    .diff-pos{color:#b91c1c}
    .diff-neg{color:#047857}
    .hidden{display:none}
    /* badges removidos (apenas usados em testes) */
    .diff-card{position:relative;padding:1.15rem;border-radius:1rem;background:var(--surface);border:1px solid var(--border);box-shadow:var(--shadow-md);display:flex;flex-direction:column;gap:.35rem;transition:box-shadow .2s ease, transform .02s ease}
    .diff-card .diff-label{font-size:.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.08em}
    .diff-card .diff-value{font-size:1.15rem;font-weight:600;color:var(--text-strong)}
    .diff-card .diff-icon{position:absolute;top:1rem;right:1rem;font-size:1.1rem;padding:.2rem .45rem;border-radius:.6rem;background:#e2e8f0;color:#0f172a}
    /* Simplified diff styles: keep neutral surfaces; use text colors for state */
    .diff-card.diff-up,.diff-card.diff-down,.diff-card.diff-neutral{background:var(--surface);border-color:var(--border)}
    .diff-card .diff-icon{background:var(--surface-soft);color:var(--text-strong)}
    .diff-card.diff-up .diff-icon{color:#065F46}
    .diff-card.diff-down .diff-icon{color:#991B1B}
    /* Diff text helpers */
    .diff-pos{color:#065F46}
    .diff-neg{color:#991B1B}
    :root[data-theme='dark'] .diff-pos{color:#34D399}
    :root[data-theme='dark'] .diff-neg{color:#FCA5A5}
    /* Chart wrappers */
    /* Chart wrappers */
    .chart-canvas-wrap{position:relative;width:100%;min-height:120px}
    .chart-canvas-wrap canvas{display:block;width:100% !important;height:auto !important}
    .diff-bar{height:.45rem;border-radius:.5rem;background:#e2e8f0;overflow:hidden}
    .diff-bar-fill{height:100%;width:0;transition:width .3s ease}
    .diff-bar-fill.diff-up{background:#ef4444}
    .diff-bar-fill.diff-down{background:#22c55e}
    .diff-bar-fill.diff-neutral{background:#6366f1}
    /* Melhor contraste para cards comparativos em tema escuro */
    :root[data-theme='dark'] .diff-card{background:var(--surface);border-color:var(--border)}
    :root[data-theme='dark'] .diff-card .diff-label{color:var(--text-strong)}
    :root[data-theme='dark'] .diff-card .diff-value{color:var(--text-strong)}
    :root[data-theme='dark'] .diff-card .diff-hint{color:var(--text-strong)}
    :root[data-theme='dark'] .diff-card .diff-icon{background:var(--surface)}
    /* Mobile cards for resumo */
    #resumoCards{display:none}
    /* Mobile list for Atual/Cen√°rio */
    .mobile-list{display:none}
    .ml-row{display:flex;align-items:flex-start;justify-content:space-between;padding:.5rem .25rem;border-bottom:1px dashed var(--border)}
    .ml-row:last-child{border-bottom:0}
    .ml-k{color:var(--text-muted);font-size:.85rem}
    .ml-v{font-weight:600}
    .ml-sub{display:block;color:var(--text-light);font-size:.75rem}
    :root[data-theme='dark'] .diff-bar{background:#2F4569}
    :root[data-theme='dark'] .diff-bar-fill.diff-neutral{background:#A5B4FC}
    :root[data-theme='dark'] .diff-pos{color:#F87171}
    :root[data-theme='dark'] .diff-neg{color:#34D399}
    :root[data-theme='dark'] .diff-text{color:var(--text-strong)}
    .diff-text{font-size:.9rem;color:#475569}
    .diff-hint{font-size:.78rem;color:var(--text-light)}
    .section-block{border-radius:1rem;border:1px solid var(--border);background:var(--surface);box-shadow:var(--shadow-md);padding:1.25rem}
    .section-block--soft{background:var(--surface-soft)}
    .section-block--accent{background:var(--accent-soft);border-color:rgba(30,58,138,.45);box-shadow:0 18px 48px -32px rgba(30,58,138,.35)}
    .section-block__header{display:flex;align-items:flex-start;justify-content:space-between;gap:.75rem}
    .section-block__label{font-size:.72rem;letter-spacing:.18em;text-transform:uppercase;color:var(--text-muted);font-weight:600}
    .section-block__hint{font-size:.72rem;color:var(--text-light)}
    .section-block__content{margin-top:1rem}
    .section-block__content p{color:var(--text-light)}
    .rc-tablist{overflow-x:auto;padding-bottom:.25rem}
    .rc-tab-btn{padding:.45rem 1rem;border-radius:.85rem;border:1px solid var(--border);background:var(--surface-soft);color:var(--text-muted);font-size:.85rem;font-weight:500;transition:all .2s ease}
    .rc-tab-btn:hover{color:var(--text-strong)}
    .rc-tab-btn.is-active{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 10px 24px -15px rgba(13,71,161,.6)}
    .mini-stat{border-radius:1rem;border:1px solid var(--border);background:var(--surface);box-shadow:var(--shadow-md);padding:1.05rem;display:flex;flex-direction:column;gap:.45rem;position:relative;border-left:4px solid var(--border);padding-left:1rem;transition:transform .12s ease}
    .mini-stat:hover{transform:scale(1.02)}
    .mini-stat__label{font-size:.72rem;letter-spacing:.14em;text-transform:uppercase;color:var(--text-light);font-weight:600}
    .mini-stat__value{font-size:1.3rem;font-weight:600;color:var(--text-strong)}
    .mini-stat__hint{font-size:.78rem;color:var(--text-muted)}
    .mini-stat[data-kind="receita"]{border-left-color:var(--accent)}
    .mini-stat[data-kind="compras"]{border-left-color:var(--accent-2)}
    .mini-stat__icon{position:absolute;right:.85rem;top:.85rem;color:var(--text-light)}
    .mini-stat__action{position:absolute;right:2.4rem;top:.65rem}
    .mini-stat__action .icon-btn{width:28px;height:28px}

    /* Icon-only buttons */
    .icon-btn{width:34px;height:34px;border-radius:.65rem;border:1px solid var(--border);background:var(--surface);display:inline-flex;align-items:center;justify-content:center;transition:background-color .2s ease, box-shadow .2s ease, transform .02s ease;color:var(--text-strong)}
    .icon-btn:hover{background:var(--surface-soft)}
    .icon-btn:active{transform:translateY(1px)}
    .icon-btn-danger{border-color:#FECACA;background:#FEF2F2;color:#991B1B}
    .icon-btn-danger:hover{background:#FEE2E2}
    .icon-btn-success{border-color:#A7F3D0;background:#ECFDF5;color:#065F46}
    .icon-btn-warning{border-color:#FDE68A;background:#FEF9C3;color:#92400E}
    /* Acessibilidade: link "pular para o conte√∫do" */
    .skip-link{position:absolute;left:-999px;top:auto;width:1px;height:1px;overflow:hidden}
    .skip-link:focus{left:1rem;top:1rem;width:auto;height:auto;padding:.5rem .75rem;border-radius:.5rem;background:var(--accent);color:#fff;z-index:9999;box-shadow:var(--shadow-md)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    /* Inputs percentuais mais compactos */
    .pct-input{width:7.5rem}
    .input-row{display:flex;flex-direction:column;gap:.25rem}

    /* Abas de Al√≠quotas */
    .alq-tablist{overflow-x:auto;padding-bottom:.25rem;display:flex;gap:.5rem;margin-bottom:.75rem}
    .alq-tab-btn{padding:.4rem .9rem;border-radius:.75rem;border:1px solid var(--border);background:var(--surface-soft);color:var(--text-muted);font-size:.85rem;font-weight:500;transition:all .2s ease}
    .alq-tab-btn:hover{color:var(--text-strong)}
    .alq-tab-btn.is-active{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 10px 24px -15px rgba(13,71,161,.6)}
    /* Chips (legacy removed) */
    

    /* Widget (modelo widget.html adaptado) */
    .w-item{background:var(--surface);border:1px solid var(--border);border-radius:1rem;box-shadow:var(--shadow-md);overflow:hidden}
    .w-head{display:flex;gap:.9rem;align-items:center;justify-content:space-between;padding:.9rem 1rem;background:var(--surface-soft);border-bottom:1px solid var(--border)}
    .w-left{display:flex;flex-direction:column;min-width:0}
    .w-title{font-weight:700;letter-spacing:.2px;color:var(--text-strong);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .w-sub{color:var(--text-muted);font-size:.82rem;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .w-btns{display:flex;gap:.5rem;flex-wrap:wrap}
    .w-btn{appearance:none;border:1px solid var(--border);background:var(--surface);color:var(--text-strong);padding:.5rem .8rem;border-radius:.6rem;font-weight:600;cursor:pointer}
    .w-btn:hover{background:var(--surface-soft)}
    .w-btn--danger{border-color:#FECACA;background:#FEF2F2;color:#991B1B}
    .w-btn--danger:hover{background:#FEE2E2}
    .w-body{padding:1rem}
    /* Hide any second .w-chips-group inside options-only wrappers */
    .opts-only .w-chips-group + .w-chips-group{display:none}
    .w-chips{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:.6rem}
    .w-chips-group{margin-bottom:.6rem}
    .w-chips-head{font-size:.8rem;font-weight:700;color:var(--text-muted);margin-bottom:.35rem} .help-tip{display:inline-block;margin-left:.35rem;width:1rem;height:1rem;line-height:1rem;text-align:center;border-radius:999px;background:var(--surface-soft);border:1px solid var(--border);color:var(--text-muted);font-weight:700;cursor:help;font-size:.72rem} :root[data-theme='dark'] .help-tip{background:var(--surface);border-color:var(--border-strong);color:var(--text-light)}
    .w-chip{background:var(--surface-soft);border:1px solid var(--border);padding:.35rem .6rem;border-radius:999px;font-size:.78rem;color:var(--text-strong)}
    .w-chip--ok{border-color:#A7F3D0;box-shadow:0 0 0 1px rgba(16,185,129,.12) inset}
    .w-chip--warn{border-color:#FDE68A;box-shadow:0 0 0 1px rgba(253,230,138,.2) inset}
    .w-chip--off{opacity:.8}
    .w-grid{display:grid;gap:.9rem}
    /* Dark mode: improve chip contrast */
    :root[data-theme='dark'] .w-chip{background:var(--surface);border-color:var(--border-strong);color:var(--text-strong)}
    :root[data-theme='dark'] .w-chip--ok{border-color:#34D399;box-shadow:0 0 0 1px rgba(52,211,153,.25) inset}
    :root[data-theme='dark'] .w-chip--warn{border-color:#FBBF24;box-shadow:0 0 0 1px rgba(251,191,36,.25) inset}
    :root[data-theme='dark'] .w-chip--off{opacity:1;border-color:var(--border);background:var(--surface-soft);color:var(--text-muted)}
    :root[data-theme='dark'] .w-chips-head{color:var(--text-strong)}
    @media (min-width: 960px){ .w-grid{grid-template-columns:repeat(12,1fr)} }
    .w-card{background:linear-gradient(180deg, rgba(17,24,39,.02), transparent 60%); border:1px solid var(--border);border-radius:.85rem;padding:.85rem}
    .w-card__head{display:flex;align-items:center;justify-content:space-between;margin-bottom:.6rem}
    .w-card__title{font-weight:700}
    .w-card__meta{color:var(--text-light);font-size:.78rem}
    .w-kv{display:grid;grid-template-columns:1.2fr 1fr;gap:.5rem;align-items:center}
    .w-kv .k{color:var(--text-light)}
    .w-kv .v{justify-self:end;font-weight:700}
    .w-aliq-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem}
    @media (min-width:800px){ .w-aliq-grid{grid-template-columns:repeat(6,1fr)} }
    .w-aliq{border:1px solid var(--border);border-radius:.6rem;padding:.6rem;background:var(--surface)}
    .w-aliq .k{color:var(--text-light);font-size:.78rem}
    .w-aliq .v{font-weight:800;margin-top:.25rem}
    .w-aliq.ok{box-shadow:0 0 0 1px rgba(16,185,129,.16) inset}
    .w-aliq.off{opacity:.7}
    .w-input{border:1px solid var(--border);background:var(--surface);border-radius:.5rem;padding:.35rem .5rem;color:var(--text-strong);font-weight:700;width:100%;text-align:right}
    .w-input:focus{border-color:var(--accent);box-shadow:var(--focus-ring);outline:none}
    .w-select{border:1px solid var(--border);background:var(--surface);border-radius:.5rem;padding:.5rem .65rem;color:var(--text-strong);width:100%;font-size:.95rem;font-weight:600}
    .w-select:focus{border-color:var(--accent);box-shadow:var(--focus-ring);outline:none}
    /* Improve dropdown/readability */
    select,.w-select{color:var(--text-strong)}
    select option{color:var(--text-strong);background:var(--surface)}
    :root[data-theme='dark'] select option{background:var(--surface);color:var(--text-strong)}
    /* Disabled controls remain readable */
    .w-select:disabled,.w-input:disabled{opacity:1 !important;color:var(--text-light);background:var(--surface-soft);border-color:var(--border-strong)}
    /* Form look for data entry cards */
    .form-look .w-input,.form-look .w-select{height:38px;padding:.5rem .65rem}
    /* Compact form/table layout */
    .form-table{display:grid;grid-template-columns:1.1fr 1fr;gap:.6rem .75rem;align-items:center}
    .form-table .lbl{color:var(--text-muted);font-size:.9rem}
    .form-table .hint{display:block;font-size:.72rem;color:var(--text-light);margin-top:.1rem}
    .form-table .ctl{justify-self:end}
    .form-table .across{grid-column:1 / -1}
    .form-subgrid{display:grid;grid-template-columns:1.1fr 1fr;gap:.6rem .75rem;align-items:center}
    /* Bot√µes (tema) */
    .btn{padding:.6rem 1rem;border-radius:.85rem;font-weight:500;border:1px solid transparent;transition:background-color .2s ease, box-shadow .2s ease, transform .02s ease;}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--accent);color:#fff;box-shadow:0 10px 24px -15px rgba(30,58,138,.45)}
    .btn-primary:hover{filter:brightness(.95)}
    .btn-soft{background:var(--surface-soft);border-color:var(--border);color:var(--text-strong)}
    .btn-soft:hover{background:#eef2f7}
    .btn-ghost{background:var(--surface);border-color:var(--border);color:var(--text-strong)}
    .btn-ghost:hover{background:var(--surface-soft)}
    /* variante btn-info removida (n√£o utilizada) */
    .btn:focus-visible,.icon-btn:focus-visible{outline:none;box-shadow:var(--focus-ring)}
    body{transition: background-color .15s ease, color .15s ease}
    /* Navbar fixa */
    .navbar{position:fixed;top:0;left:0;right:0;height:56px;background:linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);color:#fff;display:flex;align-items:center;z-index:50;box-shadow:0 2px 8px rgba(0,0,0,.12)}
    .nav-inner{max-width:80rem;margin:0 auto;display:flex;align-items:center;justify-content:space-between;width:100%;padding:0 1.25rem}
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:600;font-size:16px;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand-icon::before{content:"üßÆ"}
    @media (prefers-color-scheme: dark){ .brand-icon::before{content:"üåô"} }
    .brand .brand-icon{display:none}
    .brand-logo{display:inline-block;height:20px;width:auto;border-radius:.25rem}
    .nav-actions{display:flex;gap:14px;align-items:center}
    .nav-actions a,.nav-actions button{color:#fff;text-decoration:none;font-size:14px;background:transparent;border:0;cursor:pointer}
    .nav-actions a:hover,.nav-actions button:hover{opacity:.9}
    #cenario{font-size:.95rem}
    @media (max-width: 420px){ #cenario{font-size:.88rem} }
    /* Layout responsivo m√≠nimo 375x667 */
    @media (max-width: 420px){
      .nav-actions a{display:none}
      .nav-inner{padding:0 .75rem}
      .page-wrap{padding-top:64px}
      .form-table{grid-template-columns:1fr}
      .form-table .ctl{justify-self:stretch}
      .form-subgrid{grid-template-columns:1fr}
      .w-aliq-grid{grid-template-columns:repeat(2,1fr)}
      .alq-tablist{display:flex;gap:.5rem;overflow-x:auto;-webkit-overflow-scrolling:touch;white-space:nowrap;padding-bottom:.25rem;margin-bottom:.25rem}
      .alq-tab-btn{flex:0 0 auto}
      .btn{padding:.55rem .85rem}
      .icon-btn{width:36px;height:36px}
      /* Tables and comparative tweaks for small screens */
      .tbl{font-size:.85rem}
      .tbl col.col-nome{width:52%}
      .tbl col.col-base,.tbl col.col-aliq,.tbl col.col-valor{width:16%;min-width:4.75rem}
      .tbl.tbl-resumo col.col-tributo{width:38%}
      .tbl.tbl-resumo col.col-bloco{width:31%}
      /* Hide less critical details in resumo cells */
      .tbl.tbl-resumo .cell-stack .text-slate-400{display:none}
      /* Switch to card layout for resumo */
      #tblResumo{display:none}
      #resumoCards{display:grid}
      /* Switch tables to list for Atual/Cen√°rio */
      #cardAtual table,#cardNovo table{display:none}
      #listAtual,#listNovo{display:block}
      /* Diff cards compact */
      .diff-card .diff-value{font-size:1.1rem}
      .diff-card .diff-label{font-size:.68rem}
      .diff-card .diff-icon{font-size:.9rem;top:.6rem;right:.6rem}
      /* Charts compact */
      .chart-canvas-wrap{min-height:96px}
    }
    .page-wrap{padding-top:72px}

    /* Floating Action Button */
    .fab{position:fixed;right:calc(1.25rem + env(safe-area-inset-right, 0));bottom:calc(1.25rem + env(safe-area-inset-bottom, 0));background:#10B981;color:#fff;border:0;border-radius:999px;padding:.85rem 1.1rem;font-weight:600;box-shadow:0 18px 48px -20px rgba(16,185,129,.55);cursor:pointer}
    .fab:hover{filter:brightness(.95)}
    .fab:active{transform:translateY(1px)}

    /* Print styles */
    @media print{
      .navbar,.btn,.icon-btn,.fab,.nav-actions,.sidebar{display:none !important}
      .page-wrap{padding-top:0}
      body{background:#fff;color:#000}
      .card{box-shadow:none;border-color:#e5e7eb}
    }
    /* Safe area padding for bottom content (iOS notch) */
    @supports (padding: max(0px)){
      .page-wrap{padding-bottom:max(2.5rem, calc(2rem + env(safe-area-inset-bottom, 0)))}
    }
    /* Reduced motion accessibility */
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important;transition:none !important;scroll-behavior:auto !important}
    }
  </style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border-width:0}.col-span-12{grid-column:span 12 / span 12}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-3{margin-bottom:0.75rem}.mb-4{margin-bottom:1rem}.mb-5{margin-bottom:1.25rem}.mb-6{margin-bottom:1.5rem}.mt-1{margin-top:0.25rem}.mt-2{margin-top:0.5rem}.mt-3{margin-top:0.75rem}.mt-4{margin-top:1rem}.mt-5{margin-top:1.25rem}.mt-6{margin-top:1.5rem}.flex{display:flex}.grid{display:grid}.hidden{display:none}.w-full{width:100%}.min-w-full{min-width:100%}.max-w-7xl{max-width:80rem}.list-disc{list-style-type:disc}.grid-cols-12{grid-template-columns:repeat(12, minmax(0, 1fr))}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-between{justify-content:space-between}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-1 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.25rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.25rem * var(--tw-space-y-reverse))}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-3 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.75rem * var(--tw-space-y-reverse))}.space-y-5 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.25rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.25rem * var(--tw-space-y-reverse))}.overflow-x-auto{overflow-x:auto}.rounded-lg{border-radius:0.5rem}.border{border-width:1px}.bg-slate-50{--tw-bg-opacity:1;background-color:rgb(248 250 252 / var(--tw-bg-opacity, 1))}.bg-slate-100{--tw-bg-opacity:1;background-color:rgb(241 245 249 / var(--tw-bg-opacity, 1))}.p-5{padding:1.25rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.pl-5{padding-left:1.25rem}.text-center{text-align:center}.text-right{text-align:right}.text-2xl{font-size:1.5rem;line-height:2rem}.text-\[11px\]{font-size:11px}.text-\[12px\]{font-size:12px}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-medium{font-weight:500}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.tracking-wide{letter-spacing:0.025em}.text-indigo-500{--tw-text-opacity:1;color:rgb(99 102 241 / var(--tw-text-opacity, 1))}.text-indigo-500\/70{color:rgb(99 102 241 / 0.7)}.text-indigo-700{--tw-text-opacity:1;color:rgb(67 56 202 / var(--tw-text-opacity, 1))}.text-slate-300{--tw-text-opacity:1;color:rgb(203 213 225 / var(--tw-text-opacity, 1))}.text-slate-400{--tw-text-opacity:1;color:rgb(148 163 184 / var(--tw-text-opacity, 1))}.text-slate-500{--tw-text-opacity:1;color:rgb(100 116 139 / var(--tw-text-opacity, 1))}.text-slate-600{--tw-text-opacity:1;color:rgb(71 85 105 / var(--tw-text-opacity, 1))}.text-slate-700{--tw-text-opacity:1;color:rgb(51 65 85 / var(--tw-text-opacity, 1))}.text-slate-800{--tw-text-opacity:1;color:rgb(30 41 59 / var(--tw-text-opacity, 1))}.underline{-webkit-text-decoration-line:underline;text-decoration-line:underline}.accent-slate-700{accent-color:#334155}.opacity-60{opacity:0.6}.hover\:underline:hover{-webkit-text-decoration-line:underline;text-decoration-line:underline}@media (min-width: 640px){.sm\:col-span-6{grid-column:span 6 / span 6}.sm\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}}@media (min-width: 768px){.md\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.md\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.md\:p-8{padding:2rem}.md\:text-3xl{font-size:1.875rem;line-height:2.25rem}.md\:text-base{font-size:1rem;line-height:1.5rem}}@media (min-width: 1024px){.lg\:col-span-4{grid-column:span 4 / span 4}.lg\:col-span-5{grid-column:span 5 / span 5}.lg\:col-span-6{grid-column:span 6 / span 6}.lg\:col-span-7{grid-column:span 7 / span 7}.lg\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.lg\:grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}}</style></head>
<body>
  <a href="#comparativoWrap" class="skip-link">Pular para o conte√∫do</a>
  <nav class="navbar" role="navigation">
    <div class="nav-inner">
      <div class="brand" title="Fiscal Flash ‚Äì Simulador Tribut√°rio Inteligente"><img class="brand-logo" src="https://7e822546f79b1a7746471be9da62e5ce.cdn.bubble.io/cdn-cgi/image/w=96,h=,f=auto,dpr=0.75,fit=contain/f1710268567887x186266228312094600/01%20%281%29.png" alt="Fiscal Flash" width="20" height="20"><span class="brand-text">Fiscal Flash</span></div>
      <div class="nav-actions">
        <a href="#sobre">Sobre</a>
        <a href="#ajuda">Ajuda</a>
        <!-- Bot√£o de altern√¢ncia de tema claro/escuro -->
        <button id="themeToggle" class="icon-btn" aria-label="Alternar tema" title="Alternar modo claro/escuro">üåô</button>
        <button id="btnExport" title="Imprimir/Exportar em PDF">Exportar PDF</button>
      </div>
    </div>
  </nav>
  <main class="page-wrap">
  <div class="mx-auto p-5 md:p-8">
    <!-- Cabe√ßalho e quick stats removidos para ganhar espa√ßo -->

    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
      <div class="card">
        <h2 class="font-medium mb-3">Cen√°rio</h2>
        <select id="cenario" class="w-select w-full" title="Selecione o cen√°rio da transi√ß√£o CBS/IBS">
          <option value="piloto2026" title="Piloto 2026 ‚Äî IBS teste de 1% (compensado)">Piloto 2026 ‚Äî IBS 1% (comp.)</option>
          <option value="cbs2027" title="2027‚Äì2028 ‚Äî CBS + tributos legados">2027‚Äì2028 ‚Äî CBS + legados</option>
          <option value="ibs2029" title="2029 ‚Äì IBS 10% | ICMS/ISS 90%">2029 ‚Äî IBS 10%</option>
          <option value="ibs2030" title="2030 ‚Äì IBS 20% | ICMS/ISS 80%">2030 ‚Äî IBS 20%</option>
          <option value="ibs2031" title="2031 ‚Äì IBS 30% | ICMS/ISS 70%">2031 ‚Äî IBS 30%</option>
          <option value="ibs2032" title="2032 ‚Äì IBS 40% | ICMS/ISS 60%">2032 ‚Äî IBS 40%</option>
          <option value="regime2033" title="2033+ ‚Äî Regime definitivo (CBS/IBS)">2033+ ‚Äî CBS/IBS (def.)</option>
        </select>
        <p class="text-[11px] text-slate-500 mt-2">Al√≠quotas de CBS/IBS s√£o refer√™ncias para estudo e podem mudar conforme lei complementar. N√£o substitui consulta oficial.</p>
      </div>
      <div class="card">
        <h2 class="font-medium mb-3">Regime Tribut√°rio</h2>
        <select id="regimeTrib" class="w-select w-full" title="Selecione o regime tribut√°rio">
          <option value="simples">Simples Nacional</option>
          <option value="presumido">Lucro Presumido</option>
          <option value="real" selected="">Lucro Real</option>
        </select>
      </div>
      <div id="blockPeriodo" class="card">
        <h2 class="font-medium mb-3">Per√≠odo</h2>
        <div class="grid gap-3">
          <div>
            <div class="flex items-center gap-2">
              <input id="meses" type="number" min="1" step="1" class="w-input number-input mt-1 flex-1" value="1" inputmode="numeric" pattern="[0-9]*" aria-label="Meses" placeholder="Ex.: 1 (mensal), 3 (trimestral), 12 (anual)">
              <span class="help-tip" title="Define o limite do adicional de IRPJ proporcional ao n√∫mero de meses. Ex.: 1 (mensal), 3 (trimestral), 12 (anual).">i</span>
            </div>
            <p class="text-[11px] text-slate-500 mt-1">O adicional de IRPJ √© ajustado proporcionalmente ao total de meses informado.</p>
          </div>
        </div>
      </div>
      <div class="card">
        <h2 class="font-medium mb-3">Formata√ß√£o</h2>
        <div class="grid grid-cols-2 gap-3">
          <select id="moeda" class="w-select">
            <option value="BRL">BRL (R$)</option>
            <option value="USD">USD ($)</option>
          </select>
          <select id="casas" class="w-select">
            <option value="2" selected="">2 casas decimais</option>
            <option value="3">3 casas decimais</option>
            <option value="0">0 casas decimais</option>
          </select>
        </div>
        <p class="text-[11px] text-slate-500 mt-2">Aplica-se a todos os valores exibidos na interface e no relat√≥rio.</p>
      </div>
    </section>

    <!-- (remo√ß√£o dos novos quadros; mantendo layout original) -->

    <section class="grid grid-cols-12 gap-6 mb-6">
      <div class="card col-span-12 lg:col-span-4 form-look">
        <h2 class="font-medium mb-4">Dados de Entrada</h2>
        <div class="form-table">
          <div class="lbl">
            <label for="atividadeOper">Segmento/Atividade</label>
            <span class="hint">Define automaticamente o tipo e as presun√ß√µes (Lucro Presumido)</span>
          </div>
          <div class="ctl">
            <select id="atividadeOper" class="w-select w-full">
              <optgroup label="Servi√ßos">
                <option value="servicos_gerais">Servi√ßos</option>
                <option value="servicos_profissionais">Profissionais</option>
                <option value="saude">Sa√∫de</option>
                <option value="ti_software">TI / Software</option>
                <option value="educacao">Educa√ß√£o</option>
                <option value="transporte_cargas">Transp. cargas</option>
                <option value="transporte_passageiros">Transp. passageiros</option>
                <option value="alimentacao_bares_rest">Alimenta√ß√£o</option>
                <option value="construcao_empreitada">Constru√ß√£o</option>
                <option value="locacao_imobiliaria">Loca√ß√£o imob.</option>
                <option value="locacao_moveis">Loca√ß√£o bens</option>
              </optgroup>
              <optgroup label="Com√©rcio e Ind√∫stria">
                <option value="comercio_varejo">Varejo</option>
                <option value="comercio_atacado">Atacado</option>
                <option value="comercio_online">E‚Äëcommerce</option>
                <option value="industria_fabricacao">Ind√∫stria</option>
                <option value="combustiveis_revenda">Combust√≠veis</option>
              </optgroup>
              <optgroup label="Especiais">
                <option value="construcao_ret">Constru√ß√£o ‚Äì RET</option>
                <option value="custom">Personalizado</option>
              </optgroup>
            </select>
          </div>
          <input id="tipoOper" type="hidden" value="servico">

          <div class="lbl">
            <label for="receita">Receita bruta</label>
            <span class="hint">Valor bruto do per√≠odo</span>
          </div>
      <div class="ctl">
        <input id="receita" type="text" class="w-input number-input" value="100.000,00" inputmode="decimal" placeholder="0,00">
      </div>

          <div id="wrapBaseSeletivo" class="across">
            <div class="form-subgrid">
              <div class="lbl">
                <label for="baseSeletivo">Base do Imposto Seletivo</label>
                <span class="hint">Informe apenas se o produto/servi√ßo estiver sujeito ao Imposto Seletivo.</span>
              </div>
              <div class="ctl">
                <input id="baseSeletivo" type="text" class="w-input number-input opacity-60 bg-slate-100" value="0,00" disabled>
              </div>
            </div>
          </div>
        </div>

        <div id="snInlineConfig" class="hidden">
          <div class="form-table">
            <div class="lbl">
              <label for="snAnexo">Enquadramento no Simples</label>
              <span class="hint">Informe a RBT12 e a folha para estimar o DAS</span>
            </div>
            <div class="ctl">
              <select id="snAnexo" data-user-choice="false">
                <option value="I">Anexo I ‚Äì Com√©rcio</option>
                <option value="II">Anexo II ‚Äì Ind√∫stria</option>
                <option value="III">Anexo III ‚Äì Servi√ßos</option>
                <option value="IV">Anexo IV ‚Äì Servi√ßos (CPP fora)</option>
                <option value="V">Anexo V ‚Äì Servi√ßos profissionais</option>
              </select>
            </div>
            <div id="snFatorToggleWrap" class="across hidden">
              <label class="flex items-center gap-2 text-sm">
                <input id="snFatorToggle" type="checkbox" class="accent-slate-700">
                Aplicar Fator R (folha/RBT12 ‚â• 28%)
              </label>
              <p id="snFatorToggleHint" class="hint">Aplique para avaliar a migra√ß√£o do Anexo V para o Anexo III.</p>
            </div>
            <div class="lbl">
              <label for="snRbt12">RBT12 (R$)</label>
              <span class="hint">Receita bruta acumulada nos √∫ltimos 12 meses (RBT12).</span>
            </div>
            <div class="ctl">
              <input id="snRbt12" type="text" class="w-input number-input" value="0,00" inputmode="decimal" placeholder="0,00">
            </div>
            <div class="across">
              <label class="flex items-center gap-2 text-sm">
                <input id="snCompararFora" type="checkbox" class="accent-slate-700">
                Comparar com tributa√ß√£o fora do SN (CBS/IBS por fora)
              </label>
            </div>
            <div class="across"><p id="snFRInfo" class="hint">Fator R n√£o se aplica ao anexo selecionado.</p></div>
          </div>
        </div>
      </div>

      <!-- Compras e Despesas -->
      <div class="card col-span-12 lg:col-span-4 form-look">
        <h2 class="font-medium mb-4">Compras, Despesas e Bases</h2>
        <div id="blockCompras">
          <div class="form-table">
            <div id="wrapComprasNovo" class="across hidden">
              <div class="form-subgrid">
                <div class="lbl"><label for="comprasNovo">Compras ‚Äì CBS/IBS</label><span class="hint">Base para cr√©ditos de CBS/IBS.</span></div>
                <div class="ctl"><input id="comprasNovo" type="text" class="w-input number-input opacity-60 bg-slate-100" value="50.000,00" inputmode="decimal" placeholder="0,00" disabled></div>
              </div>
            </div>
            <div id="wrapComprasAtual" class="across">
              <div class="form-subgrid">
                <div class="lbl"><label for="comprasAtual">Compras ‚Äì PIS/COFINS</label><span class="hint">Base para cr√©ditos de PIS/COFINS.</span></div>
                <div class="ctl"><input id="comprasAtual" type="text" class="w-input number-input" value="50.000,00" inputmode="decimal" placeholder="0,00"></div>
              </div>
            </div>
            <div id="wrapComprasICMS" class="across hidden">
              <div class="form-subgrid">
                <div class="lbl"><label for="comprasICMS">Compras ‚Äì ICMS</label><span class="hint">Exibido para mercadorias e com√©rcio varejista (real/presumido).</span></div>
                <div class="ctl"><input id="comprasICMS" type="text" class="w-input number-input opacity-60 bg-slate-100" value="0,00" inputmode="decimal" placeholder="0,00" disabled></div>
              </div>
            </div>
            <div id="wrapDespesasReal" class="across">
              <div class="form-subgrid">
                <div class="lbl"><label for="despesasLucroReal">Despesas dedut√≠veis (Lucro Real)</label><span class="hint">Apura o lucro tribut√°vel.</span></div>
                <div class="ctl"><input id="despesasLucroReal" type="text" class="w-input number-input" value="80.000,00" inputmode="decimal" placeholder="0,00"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card col-span-12 lg:col-span-4">
        <h2 class="font-medium mb-4">Al√≠quotas e Op√ß√µes de C√°lculo</h2>
        <div class="alq-tablist" role="tablist" aria-label="Al√≠quotas">
          <button type="button" class="alq-tab-btn is-active" data-alq-tab="consumo" role="tab" aria-selected="true" tabindex="0">Consumo</button>
          <button type="button" class="alq-tab-btn" data-alq-tab="lucro" role="tab" aria-selected="false" tabindex="-1">Lucro</button>
          <button type="button" class="alq-tab-btn" data-alq-tab="outros" role="tab" aria-selected="false" tabindex="-1">Outros</button>
          <button type="button" class="alq-tab-btn" data-alq-tab="opcoes" role="tab" aria-selected="false" tabindex="-1">Op√ß√µes</button>
          <button type="button" class="alq-tab-btn" data-alq-tab="tratamentos" role="tab" aria-selected="false" tabindex="-1">Tratamentos</button>
        </div>
        <div class="space-y-5">
          <div id="alqTab-consumo" class="space-y-3" data-alq-panel="consumo" role="tabpanel" aria-hidden="false">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
              <div class="input-row"><label class="text-xs text-slate-500">PIS (%)</label><input id="pis" type="number" min="0" step="0.01" class="w-input number-input pct-input" value="1.65"></div>
              <div class="input-row"><label class="text-xs text-slate-500">COFINS (%)</label><input id="cofins" type="number" min="0" step="0.01" class="w-input number-input pct-input" value="7.6"></div>
              <div id="grupoISS" class="input-row"><label class="text-xs text-slate-500">ISS (%)</label><input id="iss" type="number" min="0" step="0.01" class="w-input number-input pct-input" value="5"></div>
              <div id="grupoICMS" class="input-row hidden"><label class="text-xs text-slate-500">ICMS (%)</label><input id="icms" type="number" min="0" step="0.01" class="w-input number-input pct-input opacity-60 bg-slate-100" value="20" disabled></div>
              <div class="input-row"><label class="text-xs text-slate-500">IPI (%)</label><input id="ipi" type="number" min="0" step="0.01" class="w-input number-input pct-input" value="0"></div>
              <div class="input-row"><label class="text-xs text-slate-500">CBS (%)</label><input id="cbs" type="number" min="0" step="0.01" class="w-input number-input pct-input opacity-60 bg-slate-100" value="12" disabled></div>
              <div class="input-row"><label class="text-xs text-slate-500">IBS (%)</label><input id="ibs" type="number" min="0" step="0.01" class="w-input number-input pct-input opacity-60 bg-slate-100" value="13" disabled></div>
              <div class="input-row"><label class="text-xs text-slate-500">Imp. Seletivo (%)</label><input id="seletivo" type="number" min="0" step="0.01" class="w-input number-input pct-input opacity-60 bg-slate-100" value="0" disabled></div>
            </div>
          </div>
          <div id="alqTab-lucro" class="space-y-3 hidden" data-alq-panel="lucro" role="tabpanel" aria-hidden="true">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
              <div class="input-row"><label class="text-xs text-slate-500">IRPJ (%)</label><input id="irpj" type="number" min="0" step="0.01" class="w-input number-input pct-input" value="15"></div>
              <div class="input-row"><label class="text-xs text-slate-500">CSLL (%)</label><input id="csll" type="number" min="0" step="0.01" class="w-input number-input pct-input" value="9"></div>
              <div class="input-row"><label class="text-xs text-slate-500">CPP (%)</label><input id="cpp" type="number" min="0" step="0.01" class="w-input number-input pct-input" value="0"></div>
              <div class="input-row"><label class="text-xs text-slate-500">Presun√ß√£o IRPJ (%)</label><input id="presAliqIrpj" type="number" min="0" step="0.01" class="w-input number-input pct-input" value="0"></div>
              <div class="input-row"><label class="text-xs text-slate-500">Presun√ß√£o CSLL (%)</label><input id="presAliqCsll" type="number" min="0" step="0.01" class="w-input number-input pct-input" value="0"></div>
            </div>
          </div>
          <div id="alqTab-outros" class="space-y-3 hidden" data-alq-panel="outros" role="tabpanel" aria-hidden="true">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
              <div class="input-row"><label class="text-xs text-slate-500">Outros tributos (%)</label><input id="aliqOutros" type="number" min="0" step="0.01" class="w-input number-input pct-input" value="0"></div>
            </div>
          </div>
          <div id="alqTab-opcoes" class="space-y-3 hidden" data-alq-panel="opcoes" role="tabpanel" aria-hidden="true">
            <div class="section-block section-block--soft">
              <div class="section-block__header">
                <span class="section-block__label">Tributos no c√°lculo</span>
                <div class="flex items-center gap-3 text-[12px] text-slate-600">
                  <button id="btnIncAll" type="button" class="hover:underline">Selecionar tudo</button>
                  <span class="text-slate-300">‚Ä¢</span>
                  <button id="btnIncNone" type="button" class="hover:underline">Nenhum</button>
                </div>
              </div>
              <div class="section-block__content">
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div>
                    <div class="text-[11px] uppercase tracking-wide text-slate-500 mb-1">Consumo</div>
                    <div class="flex flex-col gap-2">
                      <label class="flex items-center gap-2"><input id="incPisCof" type="checkbox" class="accent-slate-700" checked=""> PIS/COFINS</label>
                      <label class="flex items-center gap-2"><input id="incIssIcms" type="checkbox" class="accent-slate-700" checked=""> ISS/ICMS <span class="text-[11px] text-slate-400">(conforme tipo)</span></label>
                      <label class="flex items-center gap-2"><input id="incIpi" type="checkbox" class="accent-slate-700" checked=""> IPI</label>
                      <label class="flex items-center gap-2"><input id="incCbsIbs" type="checkbox" class="accent-slate-700" checked=""> CBS/IBS</label>
                      <label class="flex items-center gap-2"><input id="incSeletivo" type="checkbox" class="accent-slate-700" checked=""> Imp. Seletivo</label>
                    </div>
                  </div>
                  <div>
                    <div class="text-[11px] uppercase tracking-wide text-slate-500 mb-1">Lucro e outros</div>
                    <div class="flex flex-col gap-2">
                      <label class="flex items-center gap-2"><input id="incIrpj" type="checkbox" class="accent-slate-700" checked=""> IRPJ</label>
                      <label class="flex items-center gap-2"><input id="incCsll" type="checkbox" class="accent-slate-700" checked=""> CSLL</label>
                      <label class="flex items-center gap-2"><input id="incOutros" type="checkbox" class="accent-slate-700" checked=""> Outros</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="section-block">
              <div class="section-block__header">
                <span class="section-block__label">Cr√©ditos a considerar</span>
                <span class="section-block__hint">Aplic√°vel aos regimes n√£o cumulativos</span>
              </div>
              <div class="section-block__content">
                <div class="flex flex-col gap-2 text-sm">
                  <label class="flex items-center gap-2"><input id="consideraCredAtual" type="checkbox" class="accent-slate-700" checked=""> Considerar cr√©ditos PIS/COFINS</label>
                  <label class="flex items-center gap-2"><input id="consideraCredICMS" type="checkbox" class="accent-slate-700 opacity-60 bg-slate-100" checked="" disabled=""> Considerar cr√©ditos ICMS</label>
                  <label class="flex items-center gap-2"><input id="consideraCredNovo" type="checkbox" class="accent-slate-700 opacity-60 bg-slate-100" checked="" disabled=""> Considerar cr√©ditos CBS/IBS</label>
                </div>
              </div>
            </div>
          </div>
          <div id="alqTab-tratamentos" class="space-y-3 hidden" data-alq-panel="tratamentos" role="tabpanel" aria-hidden="true">
            <div id="reduzWrap" class="">
              <div id="reduzCampos" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="input-row">
                  <label class="text-xs text-slate-500">PIS/COFINS ‚Äî Redu√ß√£o</label>
                  <select id="optRedPisCof" class="w-select">
                    <option value="0">Sem redu√ß√£o</option>
                    <option value="0.5">Redu√ß√£o 50% (cesta b√°sica, agro)</option>
                    <option value="1">Isen√ß√£o 100% (imunidades/exporta√ß√µes)</option>
                    <option value="custom">Outro percentual‚Ä¶</option>
                  </select>
                  <div id="customWrapRedPisCof" class="hidden mt-1">
                    <label class="text-xs text-slate-500">Percentual personalizado (%)</label>
                    <input id="redPisCof" type="number" min="0" max="100" step="0.01" class="w-input" value="0" disabled>
                  </div>
                </div>
                <div class="input-row">
                  <label class="text-xs text-slate-500"><span id="redISSICMSLabel">ISS</span> ‚Äî Redu√ß√£o</label>
                  <select id="optRedIssIcms" class="w-select">
                    <option value="0">Sem redu√ß√£o</option>
                    <option value="0.5">Redu√ß√£o 50% (regime especial)</option>
                    <option value="1">Isen√ß√£o 100% (exporta√ß√µes)</option>
                    <option value="custom">Outro percentual‚Ä¶</option>
                  </select>
                  <div id="customWrapRedIssIcms" class="hidden mt-1">
                    <label class="text-xs text-slate-500">Percentual personalizado (%)</label>
                    <input id="redISSICMS" type="number" min="0" max="100" step="0.01" class="w-input" value="0" disabled>
                  </div>
                </div>
                <div class="input-row">
                  <label class="text-xs text-slate-500">IPI ‚Äî Redu√ß√£o</label>
                  <select id="optRedIPI" class="w-select">
                    <option value="0">Sem redu√ß√£o</option>
                    <option value="1">Isen√ß√£o 100% (2027-2028 fora ZFM)</option>
                    <option value="custom">Outro percentual‚Ä¶</option>
                  </select>
                  <div id="customWrapRedIPI" class="hidden mt-1">
                    <label class="text-xs text-slate-500">Percentual personalizado (%)</label>
                    <input id="redIPI" type="number" min="0" max="100" step="0.01" class="w-input" value="0" disabled>
                  </div>
                </div>
                <div class="input-row">
                  <label class="text-xs text-slate-500">CBS / IBS ‚Äî Redu√ß√£o</label>
                  <select id="optRedCBSIBS" class="w-select" disabled>
                    <option value="0">Sem redu√ß√£o</option>
                    <option value="0.5">Redu√ß√£o 50% (programas regionais)</option>
                    <option value="1">Isen√ß√£o 100% (zona franca, imunidades)</option>
                    <option value="custom">Outro percentual‚Ä¶</option>
                  </select>
                  <div id="customWrapRedCBSIBS" class="hidden mt-1">
                    <label class="text-xs text-slate-500">Percentual personalizado (%)</label>
                    <input id="redCBSIBS" type="number" min="0" max="100" step="0.01" class="w-input" value="0" disabled>
                  </div>
                </div>
                <div class="input-row">
                  <label class="text-xs text-slate-500">Imposto Seletivo ‚Äî Redu√ß√£o</label>
                  <select id="optRedSeletivo" class="w-select" disabled>
                    <option value="0">Sem redu√ß√£o</option>
                    <option value="0.5">Redu√ß√£o 50% (pol√≠tica ambiental)</option>
                    <option value="1">Isen√ß√£o 100%</option>
                    <option value="custom">Outro percentual‚Ä¶</option>
                  </select>
                  <div id="customWrapRedSeletivo" class="hidden mt-1">
                    <label class="text-xs text-slate-500">Percentual personalizado (%)</label>
                    <input id="redSeletivo" type="number" min="0" max="100" step="0.01" class="w-input" value="0" disabled>
                  </div>
                </div>
                <div class="input-row">
                  <label class="text-xs text-slate-500">IRPJ ‚Äî Redu√ß√£o</label>
                  <select id="optRedIRPJ" class="w-select">
                    <option value="0">Sem redu√ß√£o</option>
                    <option value="0.75">Redu√ß√£o 75% (SUDENE/SUDAM)</option>
                    <option value="0.5">Redu√ß√£o 50%</option>
                    <option value="1">Isen√ß√£o 100%</option>
                    <option value="custom">Outro percentual‚Ä¶</option>
                  </select>
                  <div id="customWrapRedIRPJ" class="hidden mt-1">
                    <label class="text-xs text-slate-500">Percentual personalizado (%)</label>
                    <input id="redIRPJ" type="number" min="0" max="100" step="0.01" class="w-input" value="0" disabled>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="snResumoWrap" class="card mb-6 hidden">
      <h2 class="font-medium mb-4">Resumo Simples Nacional</h2>
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <div class="mini-stat">
          <span class="mini-stat__label">Enquadramento</span>
          <span id="snResumoAnexo" class="mini-stat__value">Anexo I</span>
          <span id="snResumoHint" class="mini-stat__hint">Base RBT12 R$&nbsp;100.000,00</span>
        </div>
        <div class="mini-stat">
          <span class="mini-stat__label">Faixa do Simples</span>
          <span id="snResumoFaixa" class="mini-stat__value">Faixa 1</span>
          <span id="snResumoFaixaHint" class="mini-stat__hint">Al√≠quota nominal 4,00% ‚Ä¢ Parcela dedut√≠vel R$&nbsp;0,00</span>
        </div>
        <div class="mini-stat">
          <span class="mini-stat__label">Al√≠quota efetiva</span>
          <span id="snAliq" class="mini-stat__value">4,00%</span>
          <span class="mini-stat__hint">J√° considera a parcela dedut√≠vel.</span>
        </div>
        <div class="mini-stat">
          <span class="mini-stat__label">DAS estimado</span>
          <span id="snTot" class="mini-stat__value">R$&nbsp;4.000,00</span>
          <span id="snResumoEfet" class="mini-stat__hint">Aplicado sobre R$&nbsp;100.000,00 do per√≠odo</span>
        </div>
      </div>
    </section>

    <div class="flex flex-wrap items-center gap-3 mb-6">
      <button id="btnCalcular" class="btn btn-primary">Simular</button>
      <button id="btnReset" class="btn btn-ghost">Limpar</button>
      <span id="status" class="text-sm text-slate-500" role="status" aria-live="polite">Pronto</span>
    </div>

    <section id="baseDatasetWrap" class="card mb-6">
      <div class="flex items-center justify-between gap-3">
        <h2 class="font-medium">Base de c√°lculo acumulada</h2>
        <span id="baseDatasetInfo" class="text-xs text-slate-500">Itens na base: 0</span>
      </div>
      <div class="mt-3">
        <div id="baseDatasetResumo" class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4 mb-3"></div>
        <div id="baseDatasetLista" class="grid gap-4 grid-cols-1 text-sm text-slate-600"><div class="text-sm text-slate-500">Nenhum item cadastrado.</div></div>
      </div>
    </section>
    
    <!-- Placeholder para relat√≥rios quando n√£o h√° itens simulados -->
    <section id="reportsEmpty" class="card mb-6">
      <div class="flex items-center justify-between gap-3">
        <div>
          <h2 class="font-medium mb-1">Relat√≥rios</h2>
          <p class="text-sm text-slate-600">Adicione dados e clique em <strong>Simular</strong> para visualizar o modelo atual, o cen√°rio e o comparativo.</p>
        </div>
        <button id="btnSimularAgoraAlt" class="btn btn-primary hidden sm:inline-flex">Simular Agora</button>
      </div>
    </section>

    <section id="cardsPadrao" class="grid grid-cols-12 gap-6 hidden">
      <div id="cardAtual" class="card overflow-x-auto col-span-12 lg:col-span-6">
        <h2 id="titleAtual" class="font-medium mb-3">Modelo atual</h2>
        <table class="min-w-full text-sm tbl">
          <colgroup>
            <col class="col-nome">
            <col class="col-base">
            <col class="col-aliq">
            <col class="col-valor">
          </colgroup>
          <thead><tr><th>Tributo</th><th class="text-right">Base</th><th class="text-right">Al√≠quota</th><th class="text-right">Valor</th></tr></thead>
          <tbody id="tAtual"><tr>
          <td class="text-slate-600">PIS</td>
          <td class="text-right">R$&nbsp;50.000,00</td>
          <td class="text-right">1,65%</td>
          <td class="text-right">R$&nbsp;825,00</td>
        </tr><tr>
          <td class="text-slate-600">COFINS</td>
          <td class="text-right">R$&nbsp;50.000,00</td>
          <td class="text-right">7,60%</td>
          <td class="text-right">R$&nbsp;3.800,00</td>
        </tr><tr>
          <td class="text-slate-600">ISS</td>
          <td class="text-right">R$&nbsp;100.000,00</td>
          <td class="text-right">5,00%</td>
          <td class="text-right">R$&nbsp;5.000,00</td>
        </tr><tr>
          <td class="text-slate-600">IRPJ</td>
          <td class="text-right">R$&nbsp;20.000,00</td>
          <td class="text-right">15,00%</td>
          <td class="text-right">R$&nbsp;3.000,00</td>
        </tr><tr>
          <td class="text-slate-600">CSLL</td>
          <td class="text-right">R$&nbsp;20.000,00</td>
          <td class="text-right">9,00%</td>
          <td class="text-right">R$&nbsp;1.800,00</td>
        </tr></tbody>
          <tfoot>
            <tr><td colspan="3">Total (Atual)</td><td id="totAtual" class="text-right">R$&nbsp;14.425,00</td></tr>
            <tr><td colspan="3">Al√≠quota efetiva</td><td id="efetAtual" class="text-right">14,42%</td></tr>
          </tfoot>
        </table>
        <div id="listAtual" class="mobile-list hidden"></div>
      </div>
      <div id="cardNovo" class="card overflow-x-auto col-span-12 lg:col-span-6">
        <h2 class="font-medium mb-3" id="tituloNovo">Cen√°rio (CBS/IBS)</h2>
        <table class="min-w-full text-sm tbl">
          <colgroup>
            <col class="col-nome">
            <col class="col-base">
            <col class="col-aliq">
            <col class="col-valor">
          </colgroup>
          <thead><tr><th>Tributo</th><th class="text-right">Base</th><th class="text-right">Al√≠quota</th><th class="text-right">Valor</th></tr></thead>
          <tbody id="tNovo"><tr>
          <td class="text-slate-600">CBS (0,9%) ‚Äì teste</td>
          <td class="text-right">R$&nbsp;100.000,00</td>
          <td class="text-right">0,90%</td>
          <td class="text-right">R$&nbsp;900,00</td>
        </tr><tr>
          <td class="text-slate-600">IBS (0,1%) ‚Äì teste</td>
          <td class="text-right">R$&nbsp;100.000,00</td>
          <td class="text-right">0,10%</td>
          <td class="text-right">R$&nbsp;100,00</td>
        </tr><tr>
          <td class="text-slate-600">Compensa√ß√£o CBS/IBS √ó PIS/COFINS</td>
          <td class="text-right">‚Äî</td>
          <td class="text-right">‚Äî</td>
          <td class="text-right">-R$&nbsp;1.000,00</td>
        </tr><tr>
          <td class="text-slate-600">PIS+COFINS ap√≥s compensa√ß√£o</td>
          <td class="text-right">R$&nbsp;50.000,00</td>
          <td class="text-right">7,25%</td>
          <td class="text-right">R$&nbsp;3.625,00</td>
        </tr><tr>
          <td class="text-slate-600">ISS</td>
          <td class="text-right">R$&nbsp;100.000,00</td>
          <td class="text-right">5,00%</td>
          <td class="text-right">R$&nbsp;5.000,00</td>
        </tr><tr>
          <td class="text-slate-600">IRPJ</td>
          <td class="text-right">R$&nbsp;20.000,00</td>
          <td class="text-right">15,00%</td>
          <td class="text-right">R$&nbsp;3.000,00</td>
        </tr><tr>
          <td class="text-slate-600">CSLL</td>
          <td class="text-right">R$&nbsp;20.000,00</td>
          <td class="text-right">9,00%</td>
          <td class="text-right">R$&nbsp;1.800,00</td>
        </tr></tbody>
          <tfoot>
            <tr><td id="rotTotNovo" colspan="3">Total (Piloto 2026)</td><td id="totNovo" class="text-right">R$&nbsp;14.425,00</td></tr>
            <tr><td colspan="3">Al√≠quota efetiva</td><td id="efetNovo" class="text-right">14,42%</td></tr>
          </tfoot>
        </table>
        <div id="listNovo" class="mobile-list hidden"></div>
      </div>
    </section>

    <section id="comparativoWrap" class="card mt-5 hidden">
      <h2 class="font-medium mb-3">Comparativo</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <div id="cardDifAbs" class="diff-card diff-neutral">
          <div class="diff-label">Diferen√ßa absoluta</div>
          <div id="difAbsIcon" class="diff-icon">‚ñ†</div>
          <div id="difAbs" class="diff-value">R$&nbsp;0,00</div>
          <div id="difAbsHint" class="diff-hint">Sem varia√ß√£o</div>
        </div>
        <div id="cardDifPct" class="diff-card diff-neutral">
          <div class="diff-label">Varia√ß√£o (%)</div>
          <div id="difPct" class="diff-value">0,00%</div>
          <div class="diff-bar mt-1">
            <div id="difPctBar" class="diff-bar-fill diff-neutral" style="width: 0%;"></div>
          </div>
          <div id="difPctHint" class="diff-hint">Sem varia√ß√£o</div>
        </div>
        <div id="cardTotais" class="diff-card diff-neutral">
          <div class="diff-label">Totais comparados</div>
          <div id="totIcon" class="diff-icon">‚áÜ</div>
          <div class="diff-text space-y-1">
            <div><span class="font-semibold">Atual:</span> <span id="totAtualResumo">R$&nbsp;14.425,00</span></div>
            <div><span class="font-semibold" id="totNovoLabel">Cen√°rio:</span> <span id="totNovoResumo">R$&nbsp;14.425,00</span></div>
          </div>
        </div>
      </div>
      
      <div class="mt-5">
        <h3 class="font-medium mb-2">Relat√≥rio resumido da composi√ß√£o</h3>
        <div class="overflow-x-auto">
          <table id="tblResumo" class="tbl tbl-resumo w-full text-sm">
            <colgroup>
              <col class="col-tributo">
              <col class="col-bloco">
              <col class="col-bloco">
              <col class="col-bloco">
            </colgroup>
            <thead>
              <tr>
                <th>Tributo</th>
                <th id="resHeadAtual">Modelo atual</th>
                <th id="resHeadNovo">Piloto 2026 (IBS 1% compensado)</th>
                <th>Diferen√ßa</th>
              </tr>
            </thead>
            <tbody id="resumoBody"><tr>
            <td>ISS</td>
            <td class="text-right cell-stack"><div class="font-semibold">R$&nbsp;5.000,00</div><div class="text-xs text-slate-500">Participa√ß√£o: 34,66%</div><div class="text-xs text-slate-400">Base: R$&nbsp;100.000,00</div><div class="text-xs text-slate-400">Al√≠quota: 5,00%</div></td>
            <td class="text-right cell-stack"><div class="font-semibold">R$&nbsp;5.000,00</div><div class="text-xs text-slate-500">Participa√ß√£o: 34,66%</div><div class="text-xs text-slate-400">Base: R$&nbsp;100.000,00</div><div class="text-xs text-slate-400">Al√≠quota: 5,00%</div></td>
            <td class="text-right cell-stack "><div class="font-semibold">R$&nbsp;0,00</div><div class="text-xs text-slate-500">Var %: 0,00%</div></td>
          </tr><tr>
            <td>IRPJ</td>
            <td class="text-right cell-stack"><div class="font-semibold">R$&nbsp;3.000,00</div><div class="text-xs text-slate-500">Participa√ß√£o: 20,80%</div><div class="text-xs text-slate-400">Base: R$&nbsp;20.000,00</div><div class="text-xs text-slate-400">Al√≠quota: 15,00%</div></td>
            <td class="text-right cell-stack"><div class="font-semibold">R$&nbsp;3.000,00</div><div class="text-xs text-slate-500">Participa√ß√£o: 20,80%</div><div class="text-xs text-slate-400">Base: R$&nbsp;20.000,00</div><div class="text-xs text-slate-400">Al√≠quota: 15,00%</div></td>
            <td class="text-right cell-stack "><div class="font-semibold">R$&nbsp;0,00</div><div class="text-xs text-slate-500">Var %: 0,00%</div></td>
          </tr><tr>
            <td>COFINS</td>
            <td class="text-right cell-stack"><div class="font-semibold">R$&nbsp;3.800,00</div><div class="text-xs text-slate-500">Participa√ß√£o: 26,34%</div><div class="text-xs text-slate-400">Base: R$&nbsp;50.000,00</div><div class="text-xs text-slate-400">Al√≠quota: 7,60%</div></td>
            <td class="text-right cell-stack"><div class="font-semibold">R$&nbsp;2.978,38</div><div class="text-xs text-slate-500">Participa√ß√£o: 20,65%</div><div class="text-xs text-slate-400">Base: R$&nbsp;50.000,00</div><div class="text-xs text-slate-400">Al√≠quota: 5,96%</div><div class="text-xs text-slate-400">Ap√≥s compensa√ß√£o CBS/IBS</div></td>
            <td class="text-right cell-stack diff-neg"><div class="font-semibold">-R$&nbsp;821,62</div><div class="text-xs text-slate-500">Var %: -21,62%</div></td>
          </tr><tr>
            <td>CSLL</td>
            <td class="text-right cell-stack"><div class="font-semibold">R$&nbsp;1.800,00</div><div class="text-xs text-slate-500">Participa√ß√£o: 12,48%</div><div class="text-xs text-slate-400">Base: R$&nbsp;20.000,00</div><div class="text-xs text-slate-400">Al√≠quota: 9,00%</div></td>
            <td class="text-right cell-stack"><div class="font-semibold">R$&nbsp;1.800,00</div><div class="text-xs text-slate-500">Participa√ß√£o: 12,48%</div><div class="text-xs text-slate-400">Base: R$&nbsp;20.000,00</div><div class="text-xs text-slate-400">Al√≠quota: 9,00%</div></td>
            <td class="text-right cell-stack "><div class="font-semibold">R$&nbsp;0,00</div><div class="text-xs text-slate-500">Var %: 0,00%</div></td>
          </tr><tr>
            <td>CBS (0,9%) ‚Äì teste</td>
            <td class="text-right cell-stack"><div class="text-slate-400">‚Äî</div></td>
            <td class="text-right cell-stack"><div class="font-semibold">R$&nbsp;900,00</div><div class="text-xs text-slate-500">Participa√ß√£o: 6,24%</div><div class="text-xs text-slate-400">Base: R$&nbsp;100.000,00</div><div class="text-xs text-slate-400">Al√≠quota: 0,90%</div><div class="text-xs text-slate-400">Piloto 2026</div></td>
            <td class="text-right cell-stack diff-pos"><div class="font-semibold">R$&nbsp;900,00</div><div class="text-xs text-slate-500">Sem base no modelo atual</div></td>
          </tr><tr>
            <td>PIS</td>
            <td class="text-right cell-stack"><div class="font-semibold">R$&nbsp;825,00</div><div class="text-xs text-slate-500">Participa√ß√£o: 5,72%</div><div class="text-xs text-slate-400">Base: R$&nbsp;50.000,00</div><div class="text-xs text-slate-400">Al√≠quota: 1,65%</div></td>
            <td class="text-right cell-stack"><div class="font-semibold">R$&nbsp;646,62</div><div class="text-xs text-slate-500">Participa√ß√£o: 4,48%</div><div class="text-xs text-slate-400">Base: R$&nbsp;50.000,00</div><div class="text-xs text-slate-400">Al√≠quota: 1,29%</div><div class="text-xs text-slate-400">Ap√≥s compensa√ß√£o CBS/IBS</div></td>
            <td class="text-right cell-stack diff-neg"><div class="font-semibold">-R$&nbsp;178,38</div><div class="text-xs text-slate-500">Var %: -21,62%</div></td>
          </tr><tr>
            <td>IBS (0,1%) ‚Äì teste</td>
            <td class="text-right cell-stack"><div class="text-slate-400">‚Äî</div></td>
            <td class="text-right cell-stack"><div class="font-semibold">R$&nbsp;100,00</div><div class="text-xs text-slate-500">Participa√ß√£o: 0,69%</div><div class="text-xs text-slate-400">Base: R$&nbsp;100.000,00</div><div class="text-xs text-slate-400">Al√≠quota: 0,10%</div><div class="text-xs text-slate-400">Piloto 2026</div></td>
            <td class="text-right cell-stack diff-pos"><div class="font-semibold">R$&nbsp;100,00</div><div class="text-xs text-slate-500">Sem base no modelo atual</div></td>
          </tr><tr>
            <td>Compensa√ß√£o CBS/IBS √ó PIS/COFINS</td>
            <td class="text-right cell-stack"><div class="text-slate-400">‚Äî</div></td>
            <td class="text-right cell-stack"><div class="font-semibold">-R$&nbsp;1.000,00</div><div class="text-xs text-slate-500">Participa√ß√£o: -6,93%</div><div class="text-xs text-slate-400">Base: R$&nbsp;0,00</div><div class="text-xs text-slate-400">Cr√©dito compensat√≥rio</div></td>
            <td class="text-right cell-stack diff-neg"><div class="font-semibold">-R$&nbsp;1.000,00</div><div class="text-xs text-slate-500">Sem base no modelo atual</div></td>
          </tr></tbody>
            <tfoot>
              <tr>
                <td class="font-semibold">Total</td>
                <td id="resTotAtual" class="text-right font-semibold">R$&nbsp;14.425,00</td>
                <td id="resTotNovo" class="text-right font-semibold">R$&nbsp;14.425,00</td>
                <td id="resTotDif" class="text-right font-semibold">R$&nbsp;0,00</td>
              </tr>
            </tfoot>
          </table>
          <!-- Mobile cards for resumo comparativo (shown <=420px) -->
          <div id="resumoCards" class="grid gap-2"></div>
        </div>
      </div>
      <div id="chartWidgets" class="mt-5 grid gap-4 md:grid-cols-3">
        <section class="w-card">
          <div class="w-card__head">
            <div class="w-card__title">Totais</div>
            <div class="w-card__meta">Atual √ó Cen√°rio</div>
          </div>
          <div class="chart-canvas-wrap"><canvas id="chartMiniTotais" aria-label="Mini gr√°fico de totais (Atual √ó Cen√°rio)" role="img"></canvas></div>
        </section>
        <section class="w-card">
          <div class="w-card__head">
            <div class="w-card__title">Distribui√ß√£o (Atual)</div>
            <div class="w-card__meta">Top 4 tributos</div>
          </div>
          <div class="chart-canvas-wrap"><canvas id="chartMiniAtual" aria-label="Mini gr√°fico: distribui√ß√£o do modelo atual (Top 4)" role="img"></canvas></div>
        </section>
        <section class="w-card">
          <div class="w-card__head">
            <div class="w-card__title">Distribui√ß√£o (Cen√°rio)</div>
            <div class="w-card__meta">Top 4 tributos</div>
          </div>
          <div class="chart-canvas-wrap"><canvas id="chartMiniCenario" aria-label="Mini gr√°fico: distribui√ß√£o do cen√°rio (Top 4)" role="img"></canvas></div>
        </section>
      </div>
    </section>

    <section id="sobre" class="card mt-6">
      <h2 class="font-medium mb-2">Sobre a Reforma</h2>
      <p class="text-sm text-slate-600">O Fiscal Flash auxilia na an√°lise da transi√ß√£o para o IVA Dual (CBS/IBS) entre 2026 e 2033+, com par√¢metros simplificados para estudo. As al√≠quotas s√£o refer√™ncias e podem variar conforme lei complementar.</p>
    </section>

    <section id="ajuda" class="card mt-5">
        <h2 class="font-medium mb-2">Ajuda</h2>
      <ul class="list-disc pl-5 text-sm text-slate-600 space-y-1">
        <li>Selecione o <strong>cen√°rio</strong> e o <strong>regime tribut√°rio</strong>.</li>
        <li>Informe <strong>receita</strong> e <strong>compras e cr√©ditos</strong>; ajuste as bases espec√≠ficas quando necess√°rio.</li>
        <li>Clique em <strong>Simular</strong> para calcular. Use <em>Limpar</em> para redefinir os campos.</li>
        <li>Para salvar ou compartilhar, use <strong>Exportar PDF</strong> (impress√£o do relat√≥rio).</li>
      </ul>
      <div class="mt-3">
        <h3 class="font-medium mb-1">Refer√™ncias (legisla√ß√£o)</h3>
        <ul class="list-disc pl-5 text-sm text-slate-600 space-y-1">
          <li><a href="legislacao/tramitacao-plp-68-2024-redacao-final.pdf" target="_blank" rel="noopener noreferrer" class="text-indigo-700 underline">PLP 68/2024 ‚Äì reda√ß√£o final</a></li>
          <li><a href="legislacao/2024-02_ec-132_quadro_comparativo_nunes.pdf" target="_blank" rel="noopener noreferrer" class="text-indigo-700 underline">EC 132/2023 ‚Äì quadro comparativo</a></li>
          <li><a href="legislacao/relatorio-grupodetrabalho-reformatributaria_web-1-1.pdf" target="_blank" rel="noopener noreferrer" class="text-indigo-700 underline">Relat√≥rio GT Reforma Tribut√°ria</a></li>
          <li><a href="legislacao/sumario-executivo-grupodetrabalho-reformatributaria_web.pdf" target="_blank" rel="noopener noreferrer" class="text-indigo-700 underline">Sum√°rio Executivo ‚Äì GT</a></li>
          <li><a href="legislacao/perguntas-e-respostas-reforma-tributaria_.pdf" target="_blank" rel="noopener noreferrer" class="text-indigo-700 underline">Perguntas e Respostas</a></li>
        </ul>
      </div>
    </section>
    
  </div>

  <!-- Floating action button -->
  <button id="btnSimularAgora" class="fab">Simular Agora</button>

  <script>
    const el = id => document.getElementById(id);
    const safe = id => ({ has: !!el(id), add: (c)=>{const n=el(id); if(n) n.classList.add(c)}, remove: (c)=>{const n=el(id); if(n) n.classList.remove(c)}, toggle: (c,on)=>{const n=el(id); if(n) n.classList.toggle(c,on)} });
    const casas = () => +(el('casas')?.value || 2);
    const moedaSel = () => (el('moeda')?.value || 'BRL');
    const parseBR = v => parseFloat((v||'').replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.')) || 0;
    const fmtMon = n => new Intl.NumberFormat(moedaSel()==='USD'?'en-US':'pt-BR', { style:'currency', currency: moedaSel()==='USD'?'USD':'BRL', minimumFractionDigits: casas(), maximumFractionDigits: casas() }).format(n||0);
    const fmtPct = n => (isFinite(n) ? (n).toFixed(2).replace('.', ',')+'%' : '‚Äî');
    const fmtAliq = aliq => { if(aliq===null || aliq===undefined || aliq==='‚Äî') return '‚Äî'; if(typeof aliq === 'string') return aliq; const num=Number(aliq); if(!isFinite(num)) return '‚Äî'; return `${(num*100).toFixed(2).replace('.',',')}%`; };
    const fmtBase = base => { if(base===null || base===undefined || base==='‚Äî') return '‚Äî'; if(typeof base === 'string') return base; if(typeof base === 'number' && isFinite(base)) return fmtMon(base); const num=Number(base); return isFinite(num)?fmtMon(num):'‚Äî'; };
    const isHidden = node => !node || node.classList.contains('hidden');
    const clamp01 = n => Math.min(Math.max(n,0),1);
    const SCENARIO_CONFIG={
      piloto2026:{ title:'Piloto 2026 ‚Äî IBS teste de 1% (compensado)', total:'Total (Piloto 2026)', legacyShare:1, ibsShare:0, auto:{ cbs:0.9, ibs:0.1, seletivo:0 } },
      cbs2027:{ title:'CBS + tributos legados (2027‚Äì2028)', total:'Total (2027‚Äì2028)', legacyShare:1, ibsShare:0, auto:{ cbs:8.7, ibs:0.1, seletivo:0 } },
      ibs2029:{ title:'Transi√ß√£o do IBS (2029 ‚Äî 10%)', total:'Total (2029)', legacyShare:0.9, ibsShare:0.1, auto:{ cbs:8.8, ibs:1.77 } },
      ibs2030:{ title:'Transi√ß√£o do IBS (2030 ‚Äî 20%)', total:'Total (2030)', legacyShare:0.8, ibsShare:0.2, auto:{ cbs:8.8, ibs:3.54 } },
      ibs2031:{ title:'Transi√ß√£o do IBS (2031 ‚Äî 30%)', total:'Total (2031)', legacyShare:0.7, ibsShare:0.3, auto:{ cbs:8.8, ibs:5.31 } },
      ibs2032:{ title:'Transi√ß√£o do IBS (2032 ‚Äî 40%)', total:'Total (2032)', legacyShare:0.6, ibsShare:0.4, auto:{ cbs:8.8, ibs:7.08 } },
      regime2033:{ title:'Regime definitivo (2033+ ‚Äî CBS/IBS)', total:'Total (2033+)', legacyShare:0, ibsShare:1, auto:{ cbs:8.8, ibs:17.7 } }
    };

    // Trava/destrava Cen√°rio e Regime somente com item simulado
    const lockGlobalConfigIfHasItems = () => {
      const has = (hasSimulated === true) && baseDataset.length > 0;
      const cSel = el('cenario'); if(cSel) cSel.disabled = has;
      const rSel = el('regimeTrib'); if(rSel) rSel.disabled = has;
    };
    const currentScenario = () => el('cenario')?.value || 'piloto2026';
    const DEFAULT_ACTIVITY_ID = 'servicos_gerais';
    const OPERATION_ACTIVITIES = {
      // Servi√ßos
      servicos_gerais:{ id:'servicos_gerais', label:'Servi√ßos', tipoOper:'servico', presKey:'servicos', presAliqIrpj:32, presAliqCsll:32, aliqOutros:0 },
      servicos_profissionais:{ id:'servicos_profissionais', label:'Profissionais', tipoOper:'servico', presKey:'servicos', presAliqIrpj:32, presAliqCsll:32, aliqOutros:0 },
      saude:{ id:'saude', label:'Sa√∫de', tipoOper:'servico', presKey:'hospitalar', presAliqIrpj:8, presAliqCsll:12, aliqOutros:0 },
      ti_software:{ id:'ti_software', label:'TI / Software', tipoOper:'servico', presKey:'servicos', presAliqIrpj:32, presAliqCsll:32, aliqOutros:0 },
      educacao:{ id:'educacao', label:'Educa√ß√£o', tipoOper:'servico', presKey:'servicos', presAliqIrpj:32, presAliqCsll:32, aliqOutros:0 },
      transporte_cargas:{ id:'transporte_cargas', label:'Transp. cargas', tipoOper:'servico', presKey:'transportes', presAliqIrpj:8, presAliqCsll:12, aliqOutros:0 },
      transporte_passageiros:{ id:'transporte_passageiros', label:'Transp. passageiros', tipoOper:'servico', presKey:'passageiros', presAliqIrpj:16, presAliqCsll:12, aliqOutros:0 },
      alimentacao_bares_rest:{ id:'alimentacao_bares_rest', label:'Alimenta√ß√£o', tipoOper:'servico', presKey:'servicos', presAliqIrpj:32, presAliqCsll:32, aliqOutros:0 },
      construcao_empreitada:{ id:'construcao_empreitada', label:'Constru√ß√£o', tipoOper:'servico', presKey:'servicos', presAliqIrpj:32, presAliqCsll:32, aliqOutros:0 },
      locacao_imobiliaria:{ id:'locacao_imobiliaria', label:'Loca√ß√£o imob.', tipoOper:'none', presKey:'locacao', presAliqIrpj:32, presAliqCsll:32, aliqOutros:0 },
      locacao_moveis:{ id:'locacao_moveis', label:'Loca√ß√£o bens', tipoOper:'servico', presKey:'servicos', presAliqIrpj:32, presAliqCsll:32, aliqOutros:0 },
      // Com√©rcio e Ind√∫stria
      comercio_varejo:{ id:'comercio_varejo', label:'Varejo', tipoOper:'mercadoria', presKey:'comercio', presAliqIrpj:8, presAliqCsll:12, aliqOutros:0 },
      comercio_atacado:{ id:'comercio_atacado', label:'Atacado', tipoOper:'mercadoria', presKey:'comercio', presAliqIrpj:8, presAliqCsll:12, aliqOutros:0 },
      comercio_online:{ id:'comercio_online', label:'E‚Äëcommerce', tipoOper:'mercadoria', presKey:'comercio', presAliqIrpj:8, presAliqCsll:12, aliqOutros:0 },
      industria_fabricacao:{ id:'industria_fabricacao', label:'Ind√∫stria', tipoOper:'mercadoria', presKey:'comercio', presAliqIrpj:8, presAliqCsll:12, aliqOutros:0 },
      combustiveis_revenda:{ id:'combustiveis_revenda', label:'Combust√≠veis', tipoOper:'mercadoria', presKey:'combustiveis', presAliqIrpj:1.6, presAliqCsll:12, aliqOutros:0 },
      // Especiais
      construcao_ret:{ id:'construcao_ret', label:'Constru√ß√£o ‚Äì RET', tipoOper:'servico', presKey:'retpa', presAliqIrpj:4, presAliqCsll:4, aliqOutros:4 },
      custom:{ id:'custom', label:'Personalizado', tipoOper:null }
    };
    let suppressTipoOperSync = false;
    let suppressActivitySync = false;
    let suppressActivityPreset = false;

    const RECEITAS_DEFAULT_TAB = 'receitas';
    const receitasTabsState = { current: RECEITAS_DEFAULT_TAB };
    const baseDataset = [];
    let hasSimulated = false;
    // inline editing per-item is controlled by item.uiEditing (boolean)

    // Quick KPI updater
    const updateQuickStats = () => {
      try{
        const receita = parseBR(el('receita')?.value);
        const comprasAtualWrap = document.getElementById('wrapComprasAtual');
        const comprasNovoWrap = document.getElementById('wrapComprasNovo');
        const comprasICMSWrap = document.getElementById('wrapComprasICMS');
        const comprasAtual = isHidden(comprasAtualWrap) ? 0 : parseBR(el('comprasAtual')?.value);
        const comprasNovo = isHidden(comprasNovoWrap) ? 0 : parseBR(el('comprasNovo')?.value);
        const comprasICMS = isHidden(comprasICMSWrap) ? 0 : parseBR(el('comprasICMS')?.value);
        const comprasSum = Math.max(0, (comprasAtual||0)+(comprasNovo||0)+(comprasICMS||0));
        const regime = el('regimeTrib')?.value || 'real';
        const regimeTxt = (()=>{ const opt=el('regimeTrib')?.selectedOptions?.[0]; return opt?opt.textContent.trim():regime; })();
        const c = currentScenario();
        const cfg = SCENARIO_CONFIG[c] || SCENARIO_CONFIG.regime2033;
        const aliqSum = (cfg.auto?.cbs||0) + (cfg.auto?.ibs||0);
        const cLabel = (el('cenario')?.selectedOptions?.[0]?.textContent || '').trim();
        if(el('qsReceitaVal')) el('qsReceitaVal').textContent = fmtMon(receita||0);
        if(el('qsComprasVal')) el('qsComprasVal').textContent = fmtMon(comprasSum||0);
        if(el('qsRegimeVal')) el('qsRegimeVal').textContent = regimeTxt || '‚Äî';
        if(el('qsAliqVal')) el('qsAliqVal').textContent = `CBS+IBS: ${fmtPct(aliqSum)}`;
        if(el('qsAliqHint')) el('qsAliqHint').textContent = `Cen√°rio: ${cLabel||'‚Äî'}`;
      }catch(_){ /* noop */ }
    };

    const scenarioDisplayName = code => {
      const opt = el('cenario')?.querySelector(`option[value="${code}"]`);
      if(opt) return opt.textContent.trim();
      const cfg = SCENARIO_CONFIG[code];
      return cfg?.title || code;
    };

    const regimeDisplayName = value => {
      const opt = el('regimeTrib')?.querySelector(`option[value="${value}"]`);
      if(opt) return opt.textContent.trim();
      const map = { simples:'Simples Nacional', presumido:'Lucro Presumido', real:'Lucro Real' };
      return map[value] || value || '‚Äî';
    };

    const tipoDisplayName = value => {
      if(value==='servico') return 'Servi√ßo (ISS)';
      if(value==='mercadoria') return 'Mercadoria (ICMS)';
      if(value==='none') return 'Sem incid√™ncia';
      return value || '‚Äî';
    };

    const collectEntryFromUI = (opts={}) => {
      const includeMeta = opts.includeMeta !== false;
      const numberField = id => {
        const node = el(id);
        if(!node) return 0;
        const raw = String(node.value ?? '').replace(',', '.');
        const num = parseFloat(raw);
        return isFinite(num) ? num : 0;
      };
      const check = id => !!el(id)?.checked;
      const selectLabel = id => {
        const node = el(id);
        const option = node?.selectedOptions?.[0];
        return option ? option.textContent.trim() : '';
      };

      const percentField = id => {
        const node = el(id);
        if(!node) return null;
        const raw = String(node.value ?? '').trim().replace(',', '.');
        if(raw==='') return null;
        const num = parseFloat(raw);
        return isFinite(num) ? num : null;
      };

      const cenario = currentScenario();
      const regime = el('regimeTrib')?.value || 'real';
      const _actCfg = (()=>{ const a=el('atividadeOper')?.value||DEFAULT_ACTIVITY_ID; return OPERATION_ACTIVITIES[a]||OPERATION_ACTIVITIES.custom; })();
      const tipo = el('tipoOper')?.value || _actCfg.tipoOper || 'servico';
      const atividadeSel = el('atividadeOper');
      const atividadeId = atividadeSel?.value || DEFAULT_ACTIVITY_ID;
      const atividadeLabel = atividadeSel?.selectedOptions?.[0]?.textContent.trim() || 'Personalizado';
      const presAtividade = _actCfg.presKey || (tipo==='mercadoria' ? 'comercio' : 'servicos');
      const snAnexoSel = el('snAnexo');

      const reductions = {
        ativo: true
      };
      Object.entries(REDUCTIONS).forEach(([key,cfg])=>{
        const sel = el(cfg.select);
        const input = el(cfg.input);
        const optVal = sel?.value ?? '0';
        const customValRaw = input?.value ?? '0';
        const customNum = parseFloat(String(customValRaw).replace(',', '.'));
        reductions[key] = {
          opt: optVal,
          custom: isFinite(customNum) ? customNum : 0
        };
      });

      const defaultAnexo = tipo==='mercadoria' ? 'I' : 'III';
      const entry = {
        cenario,
        cenarioLabel: scenarioDisplayName(cenario),
        regime,
        regimeLabel: regimeDisplayName(regime),
        tipo,
        tipoLabel: tipoDisplayName(tipo),
        atividade: atividadeId,
        atividadeLabel,
        receita: parseBR(el('receita')?.value),
        comprasNovo: parseBR(el('comprasNovo')?.value),
        comprasAtual: parseBR(el('comprasAtual')?.value),
        comprasICMS: parseBR(el('comprasICMS')?.value),
        baseSeletivo: parseBR(el('baseSeletivo')?.value),
        despesasLucroReal: parseBR(el('despesasLucroReal')?.value),
        meses: parseInt(el('meses')?.value, 10) || 0,
        pis: numberField('pis'),
        cofins: numberField('cofins'),
        iss: numberField('iss'),
        icms: numberField('icms'),
        ipi: numberField('ipi'),
        cbs: numberField('cbs'),
        ibs: numberField('ibs'),
        seletivo: numberField('seletivo'),
        irpj: numberField('irpj'),
        csll: numberField('csll'),
        cpp: numberField('cpp'),
        aliqOutros: numberField('aliqOutros'),
        incPisCof: !!el('incPisCof')?.checked,
        incIssIcms: !!el('incIssIcms')?.checked,
        incIpi: !!el('incIpi')?.checked,
        incCbsIbs: !!el('incCbsIbs')?.checked,
        incSeletivo: !!el('incSeletivo')?.checked,
        incIrpj: !!el('incIrpj')?.checked,
        incCsll: !!el('incCsll')?.checked,
        incOutros: !!el('incOutros')?.checked,
        presAliqIrpj: percentField('presAliqIrpj'),
        presAliqCsll: percentField('presAliqCsll'),
        consideraCredAtual: check('consideraCredAtual'),
        consideraCredICMS: check('consideraCredICMS'),
        consideraCredNovo: check('consideraCredNovo'),
        presAtividade,
        presAtividadeLabel: presAtividade,
        reducoes: reductions,
        snAnexo: snAnexoSel?.value || defaultAnexo,
        snAnexoLabel: selectLabel('snAnexo'),
        snFatorToggle: check('snFatorToggle'),
        snCompararFora: check('snCompararFora'),
        snRbt12: parseBR(el('snRbt12')?.value),
        moedaAtual: el('moeda')?.value || 'BRL'
      };

      if(includeMeta){
        entry.id = `${Date.now()}-${Math.random().toString(16).slice(2)}`;
        entry.addedAt = new Date();
      }
      return entry;
    };

    const captureBaseDatasetEntry = () => {
      const entry = collectEntryFromUI();
      baseDataset.push(entry);
      renderBaseDataset();
      if(typeof lockGlobalConfigIfHasItems==='function') lockGlobalConfigIfHasItems();
      return entry;
    };

    const removeBaseDatasetEntry = id => {
      const idx = baseDataset.findIndex(item => item.id === id);
      if(idx === -1) return;
      baseDataset.splice(idx,1);
      renderBaseDataset();
      if(baseDataset.length){
        calcula();
      } else {
        clearSimulationOutputs();
        const statusEl = el('status');
        if(statusEl) statusEl.textContent = 'Base vazia';
      }
    };

    const renderBaseDataset = () => {
      const listEl = el('baseDatasetLista');
      const resumoEl = el('baseDatasetResumo');
      const info = el('baseDatasetInfo');
      if(info) info.textContent = `Itens na base: ${baseDataset.length}`;
      if(!listEl) return;
      if(!baseDataset.length){
        if(resumoEl) resumoEl.innerHTML = '';
        listEl.innerHTML = '<div class="text-sm text-slate-500">Nenhum item cadastrado.</div>';
        return;
      }
      const totals = baseDataset.reduce((acc,item)=>{
        acc.receita += item.receita||0;
        acc.comprasNovo += item.comprasNovo||0;
        acc.comprasAtual += item.comprasAtual||0;
        acc.comprasICMS += item.comprasICMS||0;
        acc.baseSeletivo += item.baseSeletivo||0;
        acc.despesas += item.despesasLucroReal||0;
        return acc;
      },{receita:0,comprasNovo:0,comprasAtual:0,comprasICMS:0,baseSeletivo:0,despesas:0});
      const globalMeses = parseInt(el('meses')?.value,10) || 1;
      const formatPct = v => `${(isFinite(v)?v:0).toFixed(2).replace('.',',')}%`;
      const boolLabel = v => v ? 'Sim' : 'N√£o';
      const reductionLabel = (key,label,item) => {
        const red=item.reducoes?.[key];
        if(!item.reducoes?.ativo || !red) return `${label}: 0%`;
        if(red.opt==='custom') return `${label}: ${formatPct(red.custom||0)}`;
        const optNum=parseFloat(red.opt);
        return `${label}: ${formatPct(isFinite(optNum)?optNum*100:0)}`;
      };

      // Resumo em mini-cards padronizados
      if(resumoEl){
        resumoEl.innerHTML = `
          <div class="mini-stat" data-kind="receita">
            <span class="mini-stat__label">Receita total</span>
            <span class="mini-stat__value">${fmtMon(totals.receita)}</span>
            <span class="mini-stat__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="10" rx="2"/><path d="M12 8v8"/><path d="M17 12h.01"/><path d="M7 12h.01"/></svg>
            </span>
          </div>
          <div class="mini-stat" data-kind="compras">
            <span class="mini-stat__label">Compras ‚Äì CBS/IBS</span>
            <span class="mini-stat__value">${fmtMon(totals.comprasNovo)}</span>
            <span class="mini-stat__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 12.39a2 2 0 0 0 2 1.61h7.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
            </span>
          </div>
          <div class="mini-stat" data-kind="compras">
            <span class="mini-stat__label">Compras ‚Äì PIS/COFINS</span>
            <span class="mini-stat__value">${fmtMon(totals.comprasAtual)}</span>
            <span class="mini-stat__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2l.344 2.75A4 4 0 0 0 10.31 8H19a2 2 0 0 1 2 2v7a5 5 0 0 1-5 5H9a5 5 0 0 1-5-5V7a5 5 0 0 1 2-4l0 0z"/></svg>
            </span>
          </div>
          <div class="mini-stat" data-kind="compras">
            <span class="mini-stat__label">Compras ‚Äì ICMS</span>
            <span class="mini-stat__value">${fmtMon(totals.comprasICMS)}</span>
            <span class="mini-stat__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="14" rx="2"/><path d="M3 7h18"/></svg>
            </span>
          </div>
          <div class="mini-stat">
            <span class="mini-stat__label">Base Seletivo</span>
            <span class="mini-stat__value">${fmtMon(totals.baseSeletivo)}</span>
            <span class="mini-stat__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
            </span>
          </div>
          <div class="mini-stat">
            <span class="mini-stat__label">Despesas (LR)</span>
            <span class="mini-stat__value">${fmtMon(totals.despesas)}</span>
            <span class="mini-stat__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 3h6a2 2 0 0 1 2 2v14l-5-3-5 3V5a2 2 0 0 1 2-2z"/></svg>
            </span>
          </div>
          <div class="mini-stat">
            <span class="mini-stat__label">Meses acum.</span>
            <span class="mini-stat__value">${globalMeses}</span>
            <span class="mini-stat__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
            </span>
            <span class="mini-stat__action"><button class="icon-btn" data-edit-kind="meses" title="Editar meses" aria-label="Editar meses">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
            </button></span>
          </div>
          <div class="mini-stat">
            <span class="mini-stat__label">Itens</span>
            <span class="mini-stat__value">${baseDataset.length}</span>
            <span class="mini-stat__icon" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h13M8 12h13M8 18h13"/><path d="M3 6h.01M3 12h.01M3 18h.01"/></svg>
            </span>
          </div>
        `;
      }

      // Cart√µes por item (modelo widget.html adaptado)
      const cards = baseDataset.map((item,idx)=>{
          const res = evaluateEntry(item);
          const tipoCurto = item.tipo==='mercadoria'?'Mercadoria (ICMS)': item.tipo==='servico'?'Servi√ßo (ISS)':'Sem incid√™ncia';
          const chipsTop = [`<span class=\"w-chip\">${item.cenarioLabel||''}</span>`, `<span class=\"w-chip\">${item.regimeLabel} ‚Ä¢ ${item.tipoLabel}</span>`, `<span class=\"w-chip w-chip--ok\">Total (Atual): ${fmtMon(res.totalAtual||0)}</span>`, `<span class=\"w-chip w-chip--ok\">Total (Cen√°rio): ${fmtMon(res.totalNovo||0)}</span>`].join('');

          const V = (()=>{
            const id = item.id;
            const money = (field,val)=>`<input type="text" class="w-input${item.uiEditing?'':' opacity-60 bg-slate-100'}" data-item="${id}" data-kind="money" data-field="${field}" value="${fmtMon(val||0)}"${item.uiEditing?'':' disabled'} inputmode="decimal" />`;
            const int = (field,val)=>`<input type="number" min="1" step="1" class="w-input${item.uiEditing?'':' opacity-60 bg-slate-100'}" data-item="${id}" data-kind="int" data-field="${field}" value="${val||1}"${item.uiEditing?'':' disabled'} inputmode="numeric" pattern="[0-9]*" />`;
            const rows = [
              ['Receita', money('receita', item.receita)],
              ['Compras ‚Äì CBS/IBS', money('comprasNovo', item.comprasNovo)],
              ['Compras ‚Äì PIS/COFINS', money('comprasAtual', item.comprasAtual)],
              ['Compras ‚Äì ICMS', money('comprasICMS', item.comprasICMS)],
              ['Base Seletivo', money('baseSeletivo', item.baseSeletivo)],
              ...(item.regime==='real' ? [['Despesas (LR)', money('despesasLucroReal', item.despesasLucroReal)]] : []),
              ['Meses', int('meses', item.meses||1)]
            ];
            return rows.map(([k,v])=>`<div class="w-kv"><div class="k">${k}</div><div class="v">${v}</div></div>`).join('');
          })();

          const inc = {
            pisCof: item.incPisCof !== false && item.regime!=='simples',
            issIcms: item.incIssIcms !== false,
            cbsIbs: item.incCbsIbs !== false,
            ipi: item.incIpi !== false,
            seletivo: item.incSeletivo !== false,
            irpj: item.incIrpj !== false,
            csll: item.incCsll !== false,
            outros: item.incOutros !== false,
            cpp: item.cpp !== undefined
          };
          const pct = (field,val)=>`<input type="number" min="0" step="0.01" class="w-input number-input pct-input${item.uiEditing?'':' opacity-60 bg-slate-100'}" data-item="${item.id}" data-kind="pct" data-field="${field}" value="${Number(val||0)}"${item.uiEditing?'':' disabled'} inputmode="decimal" />`;
          const aliqs = [];
          if(inc.pisCof){ aliqs.push(['PIS', item.pis, 'pis'], ['COFINS', item.cofins, 'cofins']); }
          if(inc.issIcms){ const isMerc=item.tipo==='mercadoria'; aliqs.push([isMerc?'ICMS':'ISS', isMerc?item.icms:item.iss, isMerc?'icms':'iss']); }
          if(inc.cbsIbs){ aliqs.push(['CBS', item.cbs, 'cbs'], ['IBS', item.ibs, 'ibs']); }
          if(inc.ipi){ aliqs.push(['IPI', item.ipi, 'ipi']); }
          if(inc.seletivo){ aliqs.push(['Seletivo', item.seletivo, 'seletivo']); }
          if(inc.irpj){ aliqs.push(['IRPJ', item.irpj, 'irpj']); }
          if(inc.csll){ aliqs.push(['CSLL', item.csll, 'csll']); }
          if(inc.cpp){ aliqs.push(['CPP', item.cpp, 'cpp']); }
          if(inc.outros){ aliqs.push(['Outros', item.aliqOutros||0, 'aliqOutros']); }
          const aliqsHTML = aliqs.map(([label,val,field])=>{
            const v = Number(val)||0; const cls = v>0 ? 'ok' : 'off';
            const editor = item.uiEditing ? pct(field,v) : fmtPct(v);
            return `<div class="w-aliq ${cls}"><div class="k">${label}</div><div class="v">${editor}</div></div>`;
          }).join('');

          const getRed = (key) => Math.round((getReductionForEntry(item,key)||0)*10000)/100; // percent 0..100
          const id = item.id;
          const chips = [];
          // Cr√©ditos (Op√ß√µes) ‚Äî edit√°veis somente quando em modo edi√ß√£o
          const credited = (ok)=> ok ? 'w-chip--ok' : 'w-chip--off';
          const dis = item.uiEditing ? '' : ' disabled="disabled"';
          chips.push(`<button type=\"button\" class=\"w-chip ${credited(!!item.consideraCredAtual)}\" aria-pressed=\"${item.consideraCredAtual?'true':'false'}\" data-opt-toggle=\"credAtual\" data-item=\"${id}\"${item.uiEditing?'':' tabindex=\"-1\" title=\"Ative edi√ß√£o para alterar\"'}><strong>Cr√©d. PIS/COFINS:</strong> ${item.consideraCredAtual?'Sim':'N√£o'}</button>`);
          chips.push(`<button type=\"button\" class=\"w-chip ${credited(!!item.consideraCredICMS)}\" aria-pressed=\"${item.consideraCredICMS?'true':'false'}\" data-opt-toggle=\"credIcms\" data-item=\"${id}\"${item.uiEditing?'':' tabindex=\"-1\" title=\"Ative edi√ß√£o para alterar\"'}><strong>Cr√©d. ICMS:</strong> ${item.consideraCredICMS?'Sim':'N√£o'}</button>`);
          chips.push(`<button type=\"button\" class=\"w-chip ${credited(!!item.consideraCredNovo)}\" aria-pressed=\"${item.consideraCredNovo?'true':'false'}\" data-opt-toggle=\"credNovo\" data-item=\"${id}\"${item.uiEditing?'':' tabindex=\"-1\" title=\"Ative edi√ß√£o para alterar\"'}><strong>Cr√©d. CBS/IBS:</strong> ${item.consideraCredNovo?'Sim':'N√£o'}</button>`);
          // Redu√ß√µes (Dedu√ß√µes)
          const pushRed = (key,label)=>{ const v=getRed(key); const cls = v>0?'w-chip--warn':'w-chip--off'; chips.push(`<button type=\"button\" class=\"w-chip ${cls}\" data-reduction=\"${key}\" data-item=\"${id}\"><strong>${label}:</strong> ${fmtPct(v)}</button>`); };
          if(inc.pisCof) pushRed('pisCof','PIS/COFINS');
          if(inc.issIcms) pushRed('issIcms', item.tipo==='mercadoria'?'ICMS':'ISS');
          if(inc.cbsIbs) pushRed('cbsIbs','CBS/IBS');
          if(inc.ipi) pushRed('ipi','IPI');
          if(inc.seletivo) pushRed('seletivo','Seletivo');
          if(inc.irpj) pushRed('irpj','IRPJ');
          // Divide visualmente em Op√ß√µes (cr√©ditos) e Dedu√ß√µes (redu√ß√µes)
          const optsCredits = chips.filter(h=> h.includes('data-opt-toggle')).join('');
          const optsReductions = chips.filter(h=> h.includes('data-reduction')).join('');
          const optsHTML = `
            <div class=\"w-chips-group\">
              <div class=\"w-chips-head\">Op√ß√µes <span class=\"help-tip\" title=\"Cr√©ditos a abater das bases de c√°lculo (PIS/COFINS, ICMS, CBS/IBS).\">?</span></div>
              <div class=\"w-chips\">${optsCredits || '<span class="text-xs text-slate-500">Sem op√ß√µes</span>'}</div>
            </div>
            <div class=\"w-chips-group\">
              <div class=\"w-chips-head\">Dedu√ß√µes <span class=\"help-tip\" title=\"Benef√≠cios e tratamentos que reduzem al√≠quotas/bases (ex.: isen√ß√µes, incentivos).\">?</span></div>
              <div class=\"w-chips\">${optsReductions || '<span class="text-xs text-slate-500">Sem dedu√ß√µes</span>'}</div>
            </div>`;
          // Dedu√ß√µes em grid (edit√°vel)
          const dedPct = (key,val)=>`<input type=\"number\" min=\"0\" max=\"100\" step=\"0.01\" class=\"w-input number-input pct-input${item.uiEditing?'':' opacity-60 bg-slate-100'}\" data-item=\"${item.id}\" data-kind=\"ded\" data-field=\"${key}\" value=\"${Number(val||0)}\"${item.uiEditing?'':' disabled'} inputmode=\"decimal\" />`;
          const dedsArr = [];
          if(inc.pisCof) dedsArr.push(['PIS/COFINS','pisCof', getRed('pisCof')]);
          if(inc.issIcms) dedsArr.push([item.tipo==='mercadoria'?'ICMS':'ISS','issIcms', getRed('issIcms')]);
          if(inc.cbsIbs) dedsArr.push(['CBS/IBS','cbsIbs', getRed('cbsIbs')]);
          if(inc.ipi) dedsArr.push(['IPI','ipi', getRed('ipi')]);
          if(inc.seletivo) dedsArr.push(['Seletivo','seletivo', getRed('seletivo')]);
          if(inc.irpj) dedsArr.push(['IRPJ','irpj', getRed('irpj')]);
          const dedGridHTML = dedsArr.map(([label,key,val])=>{ const v=Number(val)||0; const cls=v>0?'ok':'off'; const editor = item.uiEditing ? dedPct(key,v) : fmtPct(v); return `<div class=\"w-aliq ${cls}\"><div class=\"k\">${label}</div><div class=\"v\">${editor}</div></div>`; }).join('');

          return `
          <article class="card" data-entry-id="${item.id}">
            <div class="flex items-center justify-between gap-3 mb-3">
              <div>
                <div class="font-medium">Item ${idx+1}</div>
                <div class="text-xs text-slate-500">${item.cenarioLabel||''} ¬∑ ${tipoCurto} ¬∑ ${item.regimeLabel}</div>
              </div>
              <div class="flex items-center gap-2">
                <button class="btn btn-soft" data-entry-edit="${item.id}" title="${item.uiEditing?'Concluir edi√ß√£o':'Editar item'}" aria-label="${item.uiEditing?'Concluir edi√ß√£o':'Editar item'}">${item.uiEditing?'Concluir':'Editar'}</button>
                <button class="btn btn-ghost" data-base-remove="${item.id}" title="Excluir item" aria-label="Excluir item">Excluir</button>
              </div>
            </div>
            <div class="w-chips mb-2">${chipsTop}</div>
            <div class="grid grid-cols-12 gap-4">
              <section class="section-block col-span-12 lg:col-span-6">
                <div class="section-block__header">
                  <span class="section-block__label">Cen√°rio & Config</span>
                  <span class="section-block__hint">Editar inline</span>
                </div>
                <div class="section-block__content">
                  <div class="w-kv"><div class="k">Cen√°rio</div><div class="v">${(()=>{ const sel=el('cenario'); const opts=sel?Array.from(sel.options).map(o=>`<option value=\"${o.value}\" ${o.value===item.cenario?'selected':''}>${o.textContent.trim()}</option>`).join(''):Object.keys(SCENARIO_CONFIG).map(k=>`<option value=\"${k}\" ${k===item.cenario?'selected':''}>${SCENARIO_CONFIG[k].title}</option>`).join(''); const dis=item.uiEditing?'':' disabled'; return `<select class=\"w-select\" data-item=\"${item.id}\" data-field=\"cenario\"${dis}>${opts}</select>`; })()}</div></div>
                  <div class="w-kv"><div class="k">Regime</div><div class="v"><select class="w-select" data-item="${item.id}" data-field="regime"${item.uiEditing?'':' disabled'}><option value="simples" ${item.regime==='simples'?'selected':''}>Simples Nacional</option><option value="presumido" ${item.regime==='presumido'?'selected':''}>Lucro Presumido</option><option value="real" ${item.regime==='real'?'selected':''}>Lucro Real</option></select></div></div>
                  <div class="w-kv"><div class="k">Tipo</div><div class="v"><select class="w-select" data-item="${item.id}" data-field="tipo"${item.uiEditing?'':' disabled'}><option value="servico" ${item.tipo==='servico'?'selected':''}>Servi√ßo (ISS)</option><option value="mercadoria" ${item.tipo==='mercadoria'?'selected':''}>Mercadoria (ICMS)</option><option value="none" ${item.tipo==='none'?'selected':''}>Sem incid√™ncia</option></select></div></div>
                </div>
              </section>
              <section class="section-block col-span-12 lg:col-span-6">
                <div class="section-block__header">
                  <span class="section-block__label">Valores</span>
                  <span class="section-block__hint">Base do c√°lculo</span>
                </div>
                <div class="section-block__content">
                  ${V}
                </div>
              </section>
              <section class="section-block col-span-12">
                <div class="section-block__header">
                  <span class="section-block__label">Al√≠quotas</span>
                  <span class="section-block__hint">Percentuais declarados</span>
                </div>
                <div class="section-block__content"><div class="w-aliq-grid">${aliqsHTML}</div></div>
              </section>
              <section class="section-block col-span-12 lg:col-span-6">
                <div class="section-block__header">
                  <span class="section-block__label">Op√ß√µes</span>
                  <span class="section-block__hint">Cr√©ditos</span>
                </div>
                <div class="section-block__content"><div class="opts-only">${optsHTML}</div></div>
              </section>
              <section class="section-block col-span-12 lg:col-span-6">
                <div class="section-block__header">
                  <span class="section-block__label">Dedu√ß√µes</span>
                  <span class="section-block__hint">Redu√ß√µes por tributo</span>
                </div>
                <div class="section-block__content"><div class="w-aliq-grid">${dedGridHTML || '<div class=\\"text-xs text-slate-500\\">Sem dedu√ß√µes</div>'}</div></div>
              </section>
            </div>
          </article>`;
      }).join('');

      listEl.innerHTML = cards;
      if(typeof lockGlobalConfigIfHasItems==='function') lockGlobalConfigIfHasItems();
      // mini-stat actions (edit aggregate)
      const resumoWrap = el('baseDatasetResumo');
      resumoWrap?.addEventListener('click', ev=>{
        const btn = ev.target.closest('[data-edit-kind]');
        if(!btn) return;
        const kind = btn.getAttribute('data-edit-kind');
        if(kind==='meses'){
          const cur = parseInt(el('meses')?.value,10) || 1;
          const next = prompt('Definir meses do per√≠odo:', String(cur));
          if(next!=null){
            const val = Math.max(1, parseInt(String(next).trim(),10)||1);
            const node = el('meses'); if(node) node.value = String(val);
            baseDataset.forEach(it=> it.meses = val);
            renderBaseDataset();
            calcula();
          }
        }
      }, { once: true });
    };

    const initBaseDataset = () => {
      renderBaseDataset();
      if(typeof lockGlobalConfigIfHasItems==='function') lockGlobalConfigIfHasItems();
      el('moeda')?.addEventListener('change', renderBaseDataset);
      el('casas')?.addEventListener('change', renderBaseDataset);
      el('baseDatasetLista')?.addEventListener('click', ev=>{
        const t = ev.target;
        // toggle editing mode for widget
        const editToggle = t.closest('[data-entry-edit]');
        if(editToggle){
          const id = editToggle.getAttribute('data-entry-edit');
          if(id){ const idx = baseDataset.findIndex(it=> String(it.id)===String(id)); if(idx>-1){ baseDataset[idx].uiEditing = !baseDataset[idx].uiEditing; renderBaseDataset(); } }
          return;
        }
        // toggle credit chips
        const chipToggle = t.closest('[data-opt-toggle]');
        if(chipToggle){
          const id = chipToggle.getAttribute('data-item');
          const key = chipToggle.getAttribute('data-opt-toggle');
          const idx = baseDataset.findIndex(it=> String(it.id)===String(id));
          if(idx>-1 && baseDataset[idx].uiEditing){
            const it = baseDataset[idx];
            if(key==='credAtual') it.consideraCredAtual = !it.consideraCredAtual;
            if(key==='credIcms') it.consideraCredICMS = !it.consideraCredICMS;
            if(key==='credNovo') it.consideraCredNovo = !it.consideraCredNovo;
            renderBaseDataset();
            calcula();
          }
          return;
        }
        // edit reduction chips
        const chipRed = t.closest('[data-reduction]');
        if(chipRed){
          const id = chipRed.getAttribute('data-item');
          const key = chipRed.getAttribute('data-reduction');
          const idx = baseDataset.findIndex(it=> String(it.id)===String(id));
          if(idx>-1){
            const it = baseDataset[idx];
            const current = (getReductionForEntry(it,key)||0)*100;
            const next = prompt(`Definir redu√ß√£o para ${key} (%)`, String((Math.round(current*100)/100).toString().replace('.',',')));
            if(next!=null){
              const val = parseFloat(String(next).replace(',','.'));
              const pct = isFinite(val) ? Math.max(0, Math.min(val,100)) : 0;
              if(!it.reducoes) it.reducoes = { ativo:true };
              if(!it.reducoes[key]) it.reducoes[key] = { opt:'0', custom:0 };
              if(pct===0){ it.reducoes[key].opt='0'; it.reducoes[key].custom=0; }
              else if(pct===50){ it.reducoes[key].opt='0.5'; it.reducoes[key].custom=0; }
              else if(pct===100){ it.reducoes[key].opt='1'; it.reducoes[key].custom=0; }
              else { it.reducoes[key].opt='custom'; it.reducoes[key].custom=pct; }
              renderBaseDataset();
              calcula();
            }
          }
          return;
        }
        const removeBtn = t.closest('[data-base-remove]');
        if(removeBtn){
          const id = removeBtn.getAttribute('data-base-remove');
          if(id){ removeBaseDatasetEntry(id); }
          return;
        }
      });

      // Inline edits for widget fields
      const updateItemField = (id, field, rawValue, kind=null) => {
        const idx = baseDataset.findIndex(it=> String(it.id) === String(id));
        if(idx===-1) return;
        const it = baseDataset[idx];
        if(kind==='money'){
          it[field] = parseBR(String(rawValue));
        } else if(kind==='int'){
          const n = parseInt(String(rawValue||'1'),10);
          it[field] = isFinite(n) && n>0 ? n : 1;
        } else if(kind==='pct'){
          const f = parseFloat(String(rawValue).replace(',','.'));
          it[field] = isFinite(f) && f>=0 ? f : 0;
        } else if(kind==='ded'){
          const f = parseFloat(String(rawValue).replace(',','.'));
          const pct = isFinite(f) && f>=0 ? Math.min(f,100) : 0;
          if(!it.reducoes) it.reducoes = { ativo:true };
          if(!it.reducoes[field]) it.reducoes[field] = { opt:'0', custom:0 };
          if(pct===0){ it.reducoes[field].opt='0'; it.reducoes[field].custom=0; }
          else if(pct===50){ it.reducoes[field].opt='0.5'; it.reducoes[field].custom=0; }
          else if(pct===100){ it.reducoes[field].opt='1'; it.reducoes[field].custom=0; }
          else { it.reducoes[field].opt='custom'; it.reducoes[field].custom=pct; }
        } else {
          it[field] = rawValue;
          if(field==='cenario'){ it.cenarioLabel = scenarioDisplayName(rawValue); }
          if(field==='regime'){ it.regimeLabel = regimeDisplayName(rawValue); }
          if(field==='tipo'){ it.tipoLabel = tipoDisplayName(rawValue); }
          if(field==='cenario'){
            const cfg = SCENARIO_CONFIG[rawValue];
            if(cfg && cfg.auto){ if(isFinite(cfg.auto.cbs)) it.cbs = cfg.auto.cbs; if(isFinite(cfg.auto.ibs)) it.ibs = cfg.auto.ibs; if(isFinite(cfg.auto.seletivo)) it.seletivo = cfg.auto.seletivo; }
          }
        }
        renderBaseDataset();
        calcula();
      };

      el('baseDatasetLista')?.addEventListener('change', ev=>{
        const t = ev.target;
        if(t && t.classList.contains('w-select')){
          const id = t.getAttribute('data-item');
          const field = t.getAttribute('data-field');
          if(id && field){ updateItemField(id, field, t.value, null); }
        }
      });
      el('baseDatasetLista')?.addEventListener('blur', ev=>{
        const t = ev.target;
        if(t && t.classList.contains('w-input')){
          const id = t.getAttribute('data-item');
          const field = t.getAttribute('data-field');
          const kind = t.getAttribute('data-kind');
          if(id && field){ updateItemField(id, field, t.value, kind); }
          // Normaliza√ß√£o visual do input percentual no blur (pt-BR)
          if(kind==='pct' || kind==='ded'){
            const v = parseFloat(String(t.value).replace(',','.'));
            const num = isFinite(v) && v>=0 ? v : 0;
            t.value = String(num.toFixed(2)).replace('.',',');
          }
        }
      }, true);
    };

    const reductionRatio = cfg => {
      if(!cfg) return 0;
      if(cfg.opt === 'custom'){
        return clamp01((cfg.custom || 0) / 100);
      }
      const num = parseFloat(cfg.opt);
      if(!isFinite(num)) return 0;
      return clamp01(num);
    };

    const getReductionForEntry = (entry, key) => {
      if(!entry?.reducoes?.ativo) return 0;
      return reductionRatio(entry.reducoes[key]);
    };

    const computeSNForEntry = (entry, rc) => {
      if(!entry) return null;
      const receitaPeriodo = Math.max(rc || 0, 0);
      const rbt12Raw = entry.snRbt12 || 0;
      const rbt12 = rbt12Raw > 0 ? rbt12Raw : (receitaPeriodo || 0);
      const anexoOriginal = entry.snAnexo || (entry.tipo==='mercadoria'?'I':'III');
      const usaFR = anexoOriginal==='V' && !!entry.snFatorToggle;
      const anexoFinal = usaFR ? 'III' : anexoOriginal;
      const faixaInfo = (()=>{ const tbl=SN[anexoFinal]; let idx=0; for(let i=0;i<SN_LIMITS.length;i++){ if(rbt12>SN_LIMITS[i]) idx=i+1; } if(tbl && idx>=tbl.length) idx=tbl.length-1; if(idx<0) idx=0; const slot=tbl?tbl[idx]:null; const aliq=slot?slot[0]:0; const pd=slot?slot[1]:0; return { faixa:idx+1, aliq, pd }; })();
      const efetiva = rbt12>0
        ? Math.max((rbt12*faixaInfo.aliq - faixaInfo.pd)/rbt12,0)
        : Math.max(faixaInfo.aliq,0);
      const das = receitaPeriodo*efetiva;
      const splitFaixa = SN_SPLIT_FAIXA[anexoFinal];
      const split = (splitFaixa && splitFaixa[(faixaInfo.faixa||1)-1]) || SN_SPLIT[anexoFinal] || SN_SPLIT.default;
      const breakdown=[];
      Object.entries(split).forEach(([trib,share])=>{
        const valor=das*share;
        const aliqComp=efetiva*share;
        breakdown.push({
          nome:trib,
          key:trib,
          value:valor,
          base:receitaPeriodo,
          aliq:aliqComp,
          note: usaFR && anexoOriginal==='V' ? 'Fator R ‚â•28% aplicado.' : ''
        });
      });
      return {
        total:das,
        breakdown,
        receita:receitaPeriodo,
        efetiva,
        faixa:faixaInfo.faixa,
        aliqNominal:faixaInfo.aliq,
        parcelaDedutivel:faixaInfo.pd,
        anexoFinal,
        anexoOriginal,
        fatorRAplicado:usaFR
      };
    };

    const evaluateEntry = entry => {
      const cfg = SCENARIO_CONFIG[entry.cenario] || SCENARIO_CONFIG.regime2033;
      const rc = Math.max(entry.receita || 0, 0);
      const compN = Math.max(entry.comprasNovo || 0, 0);
      const compA = Math.max(entry.comprasAtual || 0, 0);
      const compICMS = Math.max(entry.comprasICMS || 0, 0);
      const baseSel = Math.max(entry.baseSeletivo || 0, 0);
      const despesasReal = Math.max(entry.despesasLucroReal || 0, 0);
      const regime = entry.regime || 'real';
      const tipoOper = entry.tipo || 'servico';
      const legacyShare = clamp01(cfg.legacyShare ?? 0);
      const ibsShare = clamp01(cfg.ibsShare ?? 1);
      const p = (entry.pis || 0)/100;
      const f = (entry.cofins || 0)/100;
      const alIss = (entry.iss || 0)/100;
      const alIcms = (entry.icms || 0)/100;
      const alIpi = (entry.ipi || 0)/100;
      const alCbs = (entry.cbs || 0)/100;
      const alIbs = (entry.ibs || 0)/100;
      const alSel = (entry.seletivo || 0)/100;
      const alIrpj = (entry.irpj || 0)/100;
      const alCsll = (entry.csll || 0)/100;
      const aliqOutrosRate = ((entry.aliqOutros ?? 0) || 0)/100;
      const presAliqEntryIrpj = entry.presAliqIrpj != null ? (entry.presAliqIrpj/100) : null;
      const presAliqEntryCsll = entry.presAliqCsll != null ? (entry.presAliqCsll/100) : null;
      const credAtual = !!entry.consideraCredAtual;
      const credICMS = !!entry.consideraCredICMS;
      const credNovo = !!entry.consideraCredNovo;
      const redPisCof = clamp01(getReductionForEntry(entry,'pisCof'));
      const redIssIcms = clamp01(getReductionForEntry(entry,'issIcms'));
      const redIpi = clamp01(getReductionForEntry(entry,'ipi'));
      const fatorAliqCbsIbs = 1 - clamp01(getReductionForEntry(entry,'cbsIbs'));
      const redSel = clamp01(getReductionForEntry(entry,'seletivo'));
      const redIrpj = clamp01(getReductionForEntry(entry,'irpj'));

      const basePisCof0 = Math.max(rc - (credAtual ? compA : 0), 0);
      const basePisCof = basePisCof0 * (1 - redPisCof);
      const valPis = (regime==='simples' || entry.incPisCof===false) ? 0 : basePisCof * p;
      const valCof = (regime==='simples' || entry.incPisCof===false) ? 0 : basePisCof * f;

      const baseIss = rc * (1 - redIssIcms);
      const baseIcms0 = Math.max(rc - ((tipoOper==='mercadoria' && credICMS) ? compICMS : 0), 0);
      const baseIcms = baseIcms0 * (1 - redIssIcms);
      const valIss = (tipoOper==='servico' && entry.incIssIcms!==false) ? baseIss * alIss : 0;
      const valIcms = (tipoOper==='mercadoria' && entry.incIssIcms!==false) ? baseIcms * alIcms : 0;

      const baseIpi = rc * (1 - redIpi);
      const valIpi = entry.incIpi===false ? 0 : baseIpi * alIpi;

      const aliqPisEff = basePisCof>0 ? valPis/basePisCof : null;
      const aliqCofEff = basePisCof>0 ? valCof/basePisCof : null;
      const aliqIssEff = baseIss>0 ? valIss/baseIss : null;
      const aliqIcmsEff = baseIcms>0 ? valIcms/baseIcms : null;
      const aliqIpiEff = baseIpi>0 ? valIpi/baseIpi : null;

      const defaultPres = tipoOper==='mercadoria' ? 'comercio' : 'servicos';
      const presCfg = PRES_ATIVIDADES[entry.presAtividade] || PRES_ATIVIDADES[defaultPres];

      let baseIrpj = 0;
      let baseCsll = 0;
      let valIrpjBase = 0;
      let valIrpjExtra = 0;
      let valCsll = 0;
      const mesesApur = Math.max(parseInt(entry.meses,10)||1,1);
      const extraTh = IRPJ_EXTRA_THRESHOLD * mesesApur;

      if(regime==='presumido' && presCfg){
        const presIrpjRate = presAliqEntryIrpj ?? presCfg.irpj ?? 0;
        const presCsllRate = presAliqEntryCsll ?? presCfg.csll ?? 0;
        baseIrpj = rc * presIrpjRate;
        baseCsll = rc * presCsllRate;
        valIrpjBase = baseIrpj * alIrpj;
        valIrpjExtra = alIrpj>0 ? Math.max(baseIrpj - extraTh, 0) * 0.10 : 0;
        valCsll = baseCsll * alCsll;
      } else if(regime==='real'){
        const lucroTributavel = Math.max(rc - despesasReal, 0);
        baseIrpj = lucroTributavel;
        baseCsll = lucroTributavel;
        valIrpjBase = baseIrpj * alIrpj;
        valIrpjExtra = alIrpj>0 ? Math.max(baseIrpj - extraTh, 0) * 0.10 : 0;
        valCsll = baseCsll * alCsll;
      }
      // Aplicar redu√ß√£o de IRPJ (ex.: SUDENE/SUDAM) somente sobre a parcela base
      if(redIrpj>0){
        valIrpjBase = valIrpjBase * (1 - redIrpj);
      }
      const valIrpj = (entry.incIrpj===false ? 0 : (valIrpjBase + valIrpjExtra));
      const baseIrpjExtra = Math.max(baseIrpj - extraTh, 0);
      const valOutros = (aliqOutrosRate>0 && entry.incOutros!==false) ? rc * aliqOutrosRate : 0;

      const snCalc = regime==='simples' ? computeSNForEntry(entry, rc) : null;
      const arrAtual = [];
      const arrCenario = [];
      const atualRows = [];
      const novoRows = [];

      const pushRow = (rows, nome, base, aliq, valor) => {
        if(!rows || Math.abs(valor) < 1e-9) return;
        const hasBase = !(base === null || base === undefined || base === '‚Äî');
        const numericBase = hasBase ? base : 0;
        rows.push({ nome, base:numericBase, baseValue:numericBase, aliq, valor, hasBase });
      };

      const pushResumo = (arr, nome, valor, base, aliq, opts={}) => {
        const numericBase = (base === null || base === undefined || base === '‚Äî') ? 0 : base;
        pushComp(arr, nome, valor, numericBase, aliq, opts);
      };

      let totalAtual = 0;
      let baseEfetivaAtual = regime==='simples' ? (snCalc?.receita || rc) : rc;

      if(regime==='simples'){
        const baseSN = snCalc?.receita || rc;
        (snCalc?.breakdown || []).forEach(item=>{
          pushRow(atualRows, item.nome, baseSN, item.aliq, item.value);
          pushResumo(arrAtual, item.nome, item.value, baseSN, item.aliq, { key:item.key||item.nome, note:item.note || 'Simples (DAS)' });
          totalAtual += item.value || 0;
        });
      } else {
        if(valPis>0){
          totalAtual += valPis;
          pushRow(atualRows,'PIS',basePisCof,aliqPisEff,valPis);
          pushResumo(arrAtual,'PIS',valPis,basePisCof,aliqPisEff,{key:'PIS'});
        }
        if(valCof>0){
          totalAtual += valCof;
          pushRow(atualRows,'COFINS',basePisCof,aliqCofEff,valCof);
          pushResumo(arrAtual,'COFINS',valCof,basePisCof,aliqCofEff,{key:'COFINS'});
        }
        if(valIss>0){
          totalAtual += valIss;
          pushRow(atualRows,'ISS',baseIss,aliqIssEff,valIss);
          pushResumo(arrAtual,'ISS',valIss,baseIss,aliqIssEff,{key:'ISS'});
        }
        if(valIcms>0){
          totalAtual += valIcms;
          pushRow(atualRows,'ICMS',baseIcms,aliqIcmsEff,valIcms);
          pushResumo(arrAtual,'ICMS',valIcms,baseIcms,aliqIcmsEff,{key:'ICMS'});
        }
        if(valIpi>0){
          totalAtual += valIpi;
          pushRow(atualRows,'IPI',baseIpi,aliqIpiEff,valIpi);
          pushResumo(arrAtual,'IPI',valIpi,baseIpi,aliqIpiEff,{key:'IPI'});
        }
        const valIrpjTotalAtual = (valIrpjBase||0) + (valIrpjExtra||0);
        if(valIrpjTotalAtual>0 && entry.incIrpj!==false){
          totalAtual += valIrpjTotalAtual;
          const aliqIrpjTotal = baseIrpj>0 ? valIrpjTotalAtual/baseIrpj : null;
          pushRow(atualRows,'IRPJ',baseIrpj,aliqIrpjTotal,valIrpjTotalAtual);
          pushResumo(arrAtual,'IRPJ',valIrpjTotalAtual,baseIrpj,aliqIrpjTotal,{key:'IRPJ'});
        }
        if(valCsll>0 && entry.incCsll!==false){
          totalAtual += valCsll;
          const aliqCsll = baseCsll>0 ? valCsll/baseCsll : null;
          pushRow(atualRows,'CSLL',baseCsll,aliqCsll,valCsll);
          pushResumo(arrAtual,'CSLL',valCsll,baseCsll,aliqCsll,{key:'CSLL'});
        }
      }

      if(valOutros>0){
        totalAtual += valOutros;
        pushRow(atualRows,'Outros tributos',rc,aliqOutrosRate,valOutros);
        pushResumo(arrAtual,'Outros tributos',valOutros,rc,aliqOutrosRate,{key:'Outros tributos'});
      }

      const snCompararFora = (regime==='simples') && !!entry.snCompararFora;
      let totalNovo = 0;
      const baseEfetivaNovo = (regime==='simples' && !snCompararFora) ? (snCalc?.receita || rc) : rc;

      const appendSNToNovo = () => {
        if(!snCalc) return;
        const baseSN = snCalc.receita || rc;
        (snCalc.breakdown || []).forEach(item=>{
          pushRow(novoRows,item.nome,baseSN,item.aliq,item.value);
          pushResumo(arrCenario,item.nome,item.value,baseSN,item.aliq,{ key:item.key||item.nome, note:item.note || 'Simples (DAS)'});
        });
      };

      if(regime==='simples' && !snCompararFora){
        appendSNToNovo();
        totalNovo = snCalc?.total || 0;
      } else if(entry.cenario==='piloto2026'){
        if(snCompararFora){
          appendSNToNovo();
          totalNovo += snCalc?.total || 0;
        }
        const baseGenerica = Math.max(rc - (credNovo ? compN : 0), 0);
        const baseTestes = Math.max(baseGenerica, 0);
        const aliqCbsPiloto = 0.009 * fatorAliqCbsIbs;
        const aliqIbsPiloto = 0.001 * fatorAliqCbsIbs;
        const valCbsPiloto = baseTestes * aliqCbsPiloto;
        const valIbsPiloto = baseTestes * aliqIbsPiloto;
        const devidoPisCof = regime==='simples' ? 0 : (basePisCof * (p+f));
        const comp = Math.min(devidoPisCof, valCbsPiloto + valIbsPiloto);
        const pisCofApos = Math.max(devidoPisCof - comp, 0);
        const aliqCbsReal = baseTestes>0 ? valCbsPiloto/baseTestes : null;
        const aliqIbsReal = baseTestes>0 ? valIbsPiloto/baseTestes : null;

        pushRow(novoRows,'CBS (0,9%) ‚Äì teste',baseTestes,aliqCbsReal,valCbsPiloto);
        pushRow(novoRows,'IBS (0,1%) ‚Äì teste',baseTestes,aliqIbsReal,valIbsPiloto);
        pushRow(novoRows,'Compensa√ß√£o CBS/IBS √ó PIS/COFINS',null,null,-comp);
        if(pisCofApos>0){
          const aliqPisComp = basePisCof>0 ? pisCofApos/basePisCof : null;
          pushRow(novoRows,'PIS+COFINS ap√≥s compensa√ß√£o',basePisCof,aliqPisComp,pisCofApos);
        }

        const extraSN = valCbsPiloto + valIbsPiloto;
        totalNovo = snCompararFora
          ? (totalNovo + extraSN)
          : (devidoPisCof + valIss + valIcms + valIpi + valIrpj + valCsll);

        pushResumo(arrCenario,'CBS (0,9%) ‚Äì teste',valCbsPiloto,baseTestes,aliqCbsReal,{key:'CBS_piloto',note:'Piloto 2026'});
        pushResumo(arrCenario,'IBS (0,1%) ‚Äì teste',valIbsPiloto,baseTestes,aliqIbsReal,{key:'IBS_piloto',note:'Piloto 2026'});
        pushResumo(arrCenario,'Compensa√ß√£o CBS/IBS √ó PIS/COFINS',-comp,0,null,{key:'COMP',note:'Cr√©dito compensat√≥rio'});

        if(pisCofApos>0 && (p+f)>0){
          const somaAliq=p+f;
          const valPisNovo=pisCofApos*(p/somaAliq);
          const valCofNovo=pisCofApos*(f/somaAliq);
          const aliqPisNovo=basePisCof>0?valPisNovo/basePisCof:null;
          const aliqCofNovo=basePisCof>0?valCofNovo/basePisCof:null;
          if(valPisNovo>0) pushResumo(arrCenario,'PIS',valPisNovo,basePisCof,aliqPisNovo,{key:'PIS',note:'Ap√≥s compensa√ß√£o CBS/IBS'});
          if(valCofNovo>0) pushResumo(arrCenario,'COFINS',valCofNovo,basePisCof,aliqCofNovo,{key:'COFINS',note:'Ap√≥s compensa√ß√£o CBS/IBS'});
        }

        if(!snCompararFora){
          if(valIss>0){
            pushResumo(arrCenario,'ISS',valIss,baseIss,aliqIssEff,{key:'ISS'});
            pushRow(novoRows,'ISS',baseIss,aliqIssEff,valIss);
          }
          if(valIcms>0){
            pushResumo(arrCenario,'ICMS',valIcms,baseIcms,aliqIcmsEff,{key:'ICMS'});
            pushRow(novoRows,'ICMS',baseIcms,aliqIcmsEff,valIcms);
          }
          if(valIpi>0){
            pushResumo(arrCenario,'IPI',valIpi,baseIpi,aliqIpiEff,{key:'IPI'});
            pushRow(novoRows,'IPI',baseIpi,aliqIpiEff,valIpi);
          }
          const valIrpjTotalNovo = (valIrpjBase||0) + (valIrpjExtra||0);
          if(valIrpjTotalNovo>0 && entry.incIrpj!==false){
            const aliqIrpjTotal = baseIrpj>0 ? valIrpjTotalNovo/baseIrpj : null;
            pushResumo(arrCenario,'IRPJ',valIrpjTotalNovo,baseIrpj,aliqIrpjTotal,{key:'IRPJ'});
            pushRow(novoRows,'IRPJ',baseIrpj,aliqIrpjTotal,valIrpjTotalNovo);
          }
          if(valCsll>0 && entry.incCsll!==false){
            const aliqCsll = baseCsll>0 ? valCsll/baseCsll : null;
            pushResumo(arrCenario,'CSLL',valCsll,baseCsll,aliqCsll,{key:'CSLL'});
            pushRow(novoRows,'CSLL',baseCsll,aliqCsll,valCsll);
          }
        } else {
          // SN breakdown already appended when snCompararFora true
        }
      } else {
        if(snCompararFora){
          appendSNToNovo();
          totalNovo += snCalc?.total || 0;
        }
        const baseCbs0 = Math.max(rc - (credNovo ? compN : 0), 0);
        const aliqCbsNom = alCbs * fatorAliqCbsIbs;
        const aliqIbsNom = alIbs * fatorAliqCbsIbs;
        const valCbs = entry.incCbsIbs===false ? 0 : baseCbs0 * aliqCbsNom;
        const valIbs = entry.incCbsIbs===false ? 0 : baseCbs0 * aliqIbsNom;
        const baseSelAdj = baseSel * (1 - redSel);
        const valSel = entry.incSeletivo===false ? 0 : baseSelAdj * alSel;
        const valIssLegacy = snCompararFora ? 0 : (valIss * legacyShare);
        const valIcmsLegacy = snCompararFora ? 0 : (valIcms * legacyShare);
        const seletivoTotal = ((entry.seletivo || 0) > 0 && baseSel > 0) ? valSel : 0;
        const valIpiNovo = valIpi;

        const aliqCbsReal = baseCbs0>0 ? valCbs/baseCbs0 : null;
        const aliqIbsReal = baseCbs0>0 ? valIbs/baseCbs0 : null;
        const aliqSelReal = baseSelAdj>0 ? valSel/baseSelAdj : null;
        const aliqIssLegacyEff = baseIss>0 ? valIssLegacy/baseIss : null;
        const aliqIcmsLegacyEff = baseIcms>0 ? valIcmsLegacy/baseIcms : null;
        const aliqIpiNovo = baseIpi>0 ? valIpiNovo/baseIpi : null;

        pushRow(novoRows,'CBS',baseCbs0,aliqCbsReal,valCbs);
        pushResumo(arrCenario,'CBS',valCbs,baseCbs0,aliqCbsReal);

        const noteIbs = ibsShare>0 && ibsShare<1 ? `Quota IBS ${Math.round(ibsShare*100)}%` : '';
        pushRow(novoRows,'IBS',baseCbs0,aliqIbsReal,valIbs);
        pushResumo(arrCenario,'IBS',valIbs,baseCbs0,aliqIbsReal,{note:noteIbs});

        if(seletivoTotal>0){
          pushRow(novoRows,'Imposto Seletivo',baseSelAdj,aliqSelReal,valSel);
          pushResumo(arrCenario,'Imposto Seletivo',valSel,baseSelAdj,aliqSelReal);
        }

        if(valIssLegacy>0 && tipoOper==='servico'){
          const labelIss = legacyShare===1 ? 'ISS' : 'ISS (legado)';
          const noteIss = legacyShare<1 ? `Legado ${Math.round(legacyShare*100)}% da base` : '';
          pushRow(novoRows,labelIss,baseIss,aliqIssLegacyEff,valIssLegacy);
          pushResumo(arrCenario,labelIss,valIssLegacy,baseIss,aliqIssLegacyEff,{key:'ISS',note:noteIss});
        }
        if(valIcmsLegacy>0 && tipoOper==='mercadoria'){
          const labelIcms = legacyShare===1 ? 'ICMS' : 'ICMS (legado)';
          const noteIcms = legacyShare<1 ? `Legado ${Math.round(legacyShare*100)}% da base` : '';
          pushRow(novoRows,labelIcms,baseIcms,aliqIcmsLegacyEff,valIcmsLegacy);
          pushResumo(arrCenario,labelIcms,valIcmsLegacy,baseIcms,aliqIcmsLegacyEff,{key:'ICMS',note:noteIcms});
        }
        if(valIpiNovo>0){
          pushRow(novoRows,'IPI',baseIpi,aliqIpiNovo,valIpiNovo);
          pushResumo(arrCenario,'IPI',valIpiNovo,baseIpi,aliqIpiNovo);
        }

        const extraSN = valCbs + valIbs + seletivoTotal + valIpiNovo;
        if(snCompararFora){
          totalNovo += extraSN;
        } else {
          totalNovo = valCbs + valIbs + seletivoTotal + valIssLegacy + valIcmsLegacy + valIpiNovo + valIrpj + valCsll;
        }

        if(!snCompararFora){
          const valIrpjTotalNovo2 = (valIrpjBase||0) + (valIrpjExtra||0);
          if(valIrpjTotalNovo2>0){
            const aliqIrpjTotal2 = baseIrpj>0 ? valIrpjTotalNovo2/baseIrpj : null;
            pushRow(novoRows,'IRPJ',baseIrpj,aliqIrpjTotal2,valIrpjTotalNovo2);
            pushResumo(arrCenario,'IRPJ',valIrpjTotalNovo2,baseIrpj,aliqIrpjTotal2,{key:'IRPJ'});
          }
          if(valCsll>0){
            const aliqCsll = baseCsll>0 ? valCsll/baseCsll : null;
            pushRow(novoRows,'CSLL',baseCsll,aliqCsll,valCsll);
            pushResumo(arrCenario,'CSLL',valCsll,baseCsll,aliqCsll,{key:'CSLL'});
          }
        }
      }

      if(valOutros>0){
        totalNovo += valOutros;
        pushRow(novoRows,'Outros tributos',rc,aliqOutrosRate,valOutros);
        pushResumo(arrCenario,'Outros tributos',valOutros,rc,aliqOutrosRate,{key:'Outros tributos'});
      }

      const resultado = {
        totalAtual,
        totalNovo,
        arrAtual,
        arrCenario,
        atualRows,
        novoRows,
        baseEfetivaAtual,
        baseEfetivaNovo,
        tituloNovo: cfg.title || 'Novo modelo',
        rotuloNovo: cfg.total || 'Total (novo)',
        visLabelAtual: (regime==='simples' && !snCompararFora) ? 'Simples Nacional' : 'Modelo atual'
      };

      return resultado;
    };

    const aggregateEntries = entries => {
      const rowsAtual = new Map();
      const orderRowsAtual = [];
      const rowsNovo = new Map();
      const orderRowsNovo = [];
      const resumoAtual = new Map();
      const resumoNovo = new Map();
      const orderResumoAtual = [];
      const orderResumoNovo = [];

      const mergeRow = (map, order, row) => {
        const key = row.nome;
        if(!map.has(key)){
          map.set(key,{ nome:row.nome, base:0, valor:0, hasBase:false });
          order.push(key);
        }
        const acc = map.get(key);
        acc.valor += row.valor || 0;
        if(row.hasBase) acc.base += row.base || 0;
        acc.hasBase = acc.hasBase || !!row.hasBase;
      };

      const mergeResumo = (map, order, item) => {
        const key = item.key || item.nome;
        if(!map.has(key)){
          map.set(key,{ nome:item.nome, key, value:0, base:0, note:item.note || '' });
          order.push(key);
        }
        const acc = map.get(key);
        acc.value += item.value || 0;
        acc.base += item.base || 0;
        if(!acc.note && item.note) acc.note = item.note;
      };

      let totalAtual = 0;
      let totalNovo = 0;
      let baseEfetivaAtual = 0;
      let baseEfetivaNovo = 0;
      const titulosNovos = new Set();
      const rotulosNovos = new Set();
      const rotulosAtuais = new Set();

      entries.forEach(entry=>{
        const res = evaluateEntry(entry);
        titulosNovos.add(res.tituloNovo);
        rotulosNovos.add(res.rotuloNovo);
        rotulosAtuais.add(res.visLabelAtual);
        totalAtual += res.totalAtual;
        totalNovo += res.totalNovo;
        baseEfetivaAtual += res.baseEfetivaAtual;
        baseEfetivaNovo += res.baseEfetivaNovo;
        res.atualRows.forEach(row=>mergeRow(rowsAtual,orderRowsAtual,row));
        res.novoRows.forEach(row=>mergeRow(rowsNovo,orderRowsNovo,row));
        res.arrAtual.forEach(item=>mergeResumo(resumoAtual,orderResumoAtual,item));
        res.arrCenario.forEach(item=>mergeResumo(resumoNovo,orderResumoNovo,item));
      });

      const finalizeRows = (map, order) => order.map(key=>{
        const acc = map.get(key);
        const baseValue = acc.base || 0;
        const hasBase = !!acc.hasBase;
        const aliq = hasBase && baseValue>0 ? acc.valor/baseValue : null;
        return { nome:acc.nome, base:hasBase ? baseValue : '‚Äî', baseValue, aliq, valor:acc.valor, hasBase };
      });

      const finalizeResumo = (map, order) => order.map(key=>{
        const acc = map.get(key);
        const base = acc.base || 0;
        const aliq = base>0 ? acc.value/base : null;
        return { nome:acc.nome, key:acc.key, value:acc.value, base, aliq, note:acc.note };
      });

      const atualRows = finalizeRows(rowsAtual, orderRowsAtual);
      const novoRows = finalizeRows(rowsNovo, orderRowsNovo);
      const arrAtual = finalizeResumo(resumoAtual, orderResumoAtual);
      const arrCenario = finalizeResumo(resumoNovo, orderResumoNovo);

      const tituloNovo = entries.length===1 ? [...titulosNovos][0] : 'Simula√ß√£o consolidada (CBS/IBS)';
      const rotuloNovo = entries.length===1 ? [...rotulosNovos][0] : 'Total consolidado';
      const tituloAtual = entries.length===1 ? [...rotulosAtuais][0] : 'Modelo atual';

      return {
        totalAtual,
        totalNovo,
        atualRows,
        novoRows,
        arrAtual,
        arrCenario,
        baseEfetivaAtual,
        baseEfetivaNovo,
        tituloNovo,
        rotuloNovo,
        tituloAtual
      };
    };

    const clearSimulationOutputs = () => {
      const emptyMsg = '<tr><td colspan="4" class="text-center text-slate-400 text-sm">Aguardando dados para c√°lculo.</td></tr>';
      const tA = el('tAtual'); if(tA) tA.innerHTML = emptyMsg;
      const tN = el('tNovo'); if(tN) tN.innerHTML = emptyMsg;
      const tituloAtualEl = el('titleAtual'); if(tituloAtualEl) tituloAtualEl.textContent = 'Modelo atual';
      const tituloNovoEl = el('tituloNovo'); if(tituloNovoEl) tituloNovoEl.textContent = 'Cen√°rio (CBS/IBS)';
      const rotTotNovoEl = el('rotTotNovo'); if(rotTotNovoEl) rotTotNovoEl.textContent = 'Total (cen√°rio)';
      const resHeadAtualEl = el('resHeadAtual'); if(resHeadAtualEl) resHeadAtualEl.textContent = 'Modelo atual';
      const resHeadNovoEl = el('resHeadNovo'); if(resHeadNovoEl) resHeadNovoEl.textContent = 'Cen√°rio';
      if(el('totAtual')) el('totAtual').textContent = fmtMon(0);
      if(el('totNovo')) el('totNovo').textContent = fmtMon(0);
      if(el('efetAtual')) el('efetAtual').textContent = fmtPct(0);
      if(el('efetNovo')) el('efetNovo').textContent = fmtPct(0);
      if(el('resumoBody')) el('resumoBody').innerHTML = '<tr><td colspan="4" class="text-center text-slate-400 text-sm">Aguardando dados para c√°lculo.</td></tr>';
      if(el('resTotAtual')) el('resTotAtual').textContent = fmtMon(0);
      if(el('resTotNovo')) el('resTotNovo').textContent = fmtMon(0);
      if(el('resTotDif')) el('resTotDif').textContent = fmtMon(0);
      if(el('difAbs')) el('difAbs').textContent = fmtMon(0);
      if(el('difPct')) el('difPct').textContent = fmtPct(0);
      if(el('difAbsHint')) el('difAbsHint').textContent = 'Adicione itens √† base para calcular.';
      if(el('difPctHint')) el('difPctHint').textContent = '';
      if(el('difAbsIcon')) el('difAbsIcon').textContent = '‚ñ†';
      if(el('difPctBar')){ const bar=el('difPctBar'); bar.style.width='0%'; bar.classList.remove('diff-up','diff-down','diff-neutral'); bar.classList.add('diff-neutral'); }
      if(el('cardDifAbs')){ const card=el('cardDifAbs'); card.classList.remove('diff-up','diff-down'); card.classList.add('diff-neutral'); }
      if(el('cardDifPct')){ const card=el('cardDifPct'); card.classList.remove('diff-up','diff-down'); card.classList.add('diff-neutral'); }
      if(el('cardTotais')){ const card=el('cardTotais'); card.classList.remove('diff-up','diff-down'); card.classList.add('diff-neutral'); }
      if(el('totIcon')) el('totIcon').textContent = '‚áÜ';
      if(el('totAtualResumo')) el('totAtualResumo').textContent = fmtMon(0);
      if(el('totNovoResumo')) el('totNovoResumo').textContent = fmtMon(0);
      try{ window.updateMiniCharts(0,0,[],[]); }catch(_){ }
    };

    // Chart theme helpers
    const chartThemeColors = (themeName) => {
      const theme = themeName || document.documentElement.getAttribute('data-theme') || 'light';
      const isDark = theme === 'dark';
      return {
        text: isDark ? '#ECEFF4' : '#111827',
        grid: isDark ? '#2F4569' : '#E5E7EB'
      };
    };
    window.applyChartTheme = (themeName) => {
      if(typeof Chart === 'undefined') return;
      const c = chartThemeColors(themeName);
      Chart.defaults.color = c.text;
      Chart.defaults.borderColor = c.grid;
      try{
        const small = (self.innerWidth||0) <= 420;
        Chart.defaults.font = Object.assign({}, Chart.defaults.font || {}, { size: small ? 10 : 12 });
      }catch(_){ }
      try{
        const tot = window.__miniTot; if(tot){
          tot.options.scales = tot.options.scales || {};
          tot.options.scales.x = tot.options.scales.x || {};
          tot.options.scales.y = tot.options.scales.y || {};
          tot.options.scales.x.ticks = Object.assign({}, tot.options.scales.x.ticks, { color: c.text });
          tot.options.scales.y.ticks = Object.assign({}, tot.options.scales.y.ticks, { color: c.text });
          tot.options.scales.x.grid = Object.assign({}, tot.options.scales.x.grid, { color: c.grid });
          tot.options.scales.y.grid = Object.assign({}, tot.options.scales.y.grid, { color: c.grid });
          tot.update();
        }
        const k1='__mini_chartMiniAtual', k2='__mini_chartMiniCenario';
        [k1,k2].forEach(k=>{ if(window[k]){ window[k].update(); } });
      }catch(_){ }
    };

    // Chart widgets updater (mini)
    window.updateMiniCharts = (totalAtual, totalNovo, resumoAtual, resumoNovo) => {
      if(typeof Chart === 'undefined') return;
      const css = (name, fb) => (getComputedStyle(document.documentElement).getPropertyValue(name).trim() || fb);
      const colorA = css('--accent', '#1E3A8A');
      const colorB = css('--accent-2', '#10B981');
      const c = chartThemeColors();
      // Totais bar
      const cTot = document.getElementById('chartMiniTotais');
      if(cTot){
        const ctx = cTot.getContext('2d');
        const small = (self.innerWidth||0) <= 420;
        if(!window.__miniTot){
          window.__miniTot = new Chart(ctx, {
            type: 'bar',
            data: { labels: ['Atual','Cen√°rio'], datasets: [{ data:[totalAtual||0,totalNovo||0], backgroundColor:[colorA,colorB]}] },
            options: { responsive:true, maintainAspectRatio:true, aspectRatio: small? 2.2 : 2.6, plugins:{legend:{display:false}}, scales:{
              x:{ ticks:{ color:c.text }, grid:{ color:c.grid } },
              y:{ ticks:{ color:c.text, callback:(v)=> new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v)}, grid:{ color:c.grid } }
            }}
          });
        } else {
          window.__miniTot.data.datasets[0].data = [totalAtual||0,totalNovo||0];
          window.__miniTot.update();
        }
      }
      // Top 4 helper
      const topN = (arr)=> (arr||[]).slice().sort((a,b)=> (b?.value||0)-(a?.value||0)).slice(0,4);
      const palette = ['#6366f1','#22c55e','#f59e0b','#ef4444'];
      const buildPie = (elId, arr) => {
        const el = document.getElementById(elId); if(!el) return;
        const ctx = el.getContext('2d');
        const labels = arr.map(x=>x.nome);
        const data = arr.map(x=>x.value||0);
        const colors = palette.slice(0, data.length);
        const key = `__mini_${elId}`;
        const small = (self.innerWidth||0) <= 420;
        if(!window[key]){
          window[key] = new Chart(ctx, { type:'doughnut', data:{ labels, datasets:[{ data, backgroundColor:colors}] }, options:{ responsive:true, maintainAspectRatio:true, aspectRatio: small? 1 : 1.2, plugins:{legend:{display:false}}, cutout:'60%'}});
        } else {
          window[key].data.labels = labels;
          window[key].data.datasets[0].data = data;
          window[key].data.datasets[0].backgroundColor = colors;
          window[key].update();
        }
      };
      buildPie('chartMiniAtual', topN(resumoAtual));
      buildPie('chartMiniCenario', topN(resumoNovo));
    };

    const renderSimulationOutputs = data => {
      const tituloAtualEl = el('titleAtual');
      if(tituloAtualEl) tituloAtualEl.textContent = data.tituloAtual || 'Modelo atual';
      const tituloNovoEl = el('tituloNovo');
      if(tituloNovoEl) tituloNovoEl.textContent = data.tituloNovo || 'Novo modelo';
      const rotTotNovoEl = el('rotTotNovo');
      if(rotTotNovoEl) rotTotNovoEl.textContent = 'Total (Cen√°rio)';

      const renderRows = rows => {
        if(!rows.length) return '<tr><td colspan="4" class="text-center text-slate-400 text-sm">Sem tributos calculados.</td></tr>';
        return rows.map(row=>`<tr>
          <td class="text-slate-600">${row.nome}</td>
          <td class="text-right">${row.hasBase ? fmtBase(row.baseValue ?? row.base) : '‚Äî'}</td>
          <td class="text-right">${fmtAliq(row.aliq)}</td>
          <td class="text-right">${fmtMon(row.valor)}</td>
        </tr>`).join('');
      };

      const tA = el('tAtual');
      if(tA) tA.innerHTML = renderRows(data.atualRows || []);
      // mobile list (Atual)
      try{
        const listA = el('listAtual');
        if(listA){
          const rows = data.atualRows || [];
          listA.innerHTML = rows.length ? rows.map(row=>{
            const sub = [];
            if(row.hasBase) sub.push(`Base: ${fmtBase(row.baseValue ?? row.base)}`);
            if(row.aliq!=null && row.aliq!=='‚Äî') sub.push(`Al√≠quota: ${fmtAliq(row.aliq)}`);
            return `<div class="ml-row"><div class="ml-k">${row.nome}<span class="ml-sub">${sub.join(' ‚Ä¢ ')}</span></div><div class="ml-v">${fmtMon(row.valor)}</div></div>`;
          }).join('') : '<div class="text-slate-400 text-sm">Sem tributos calculados.</div>';
        }
      }catch(_){ }
      const tN = el('tNovo');
      if(tN) tN.innerHTML = renderRows(data.novoRows || []);
      // mobile list (Cen√°rio)
      try{
        const listN = el('listNovo');
        if(listN){
          const rows = data.novoRows || [];
          listN.innerHTML = rows.length ? rows.map(row=>{
            const sub = [];
            if(row.hasBase) sub.push(`Base: ${fmtBase(row.baseValue ?? row.base)}`);
            if(row.aliq!=null && row.aliq!=='‚Äî') sub.push(`Al√≠quota: ${fmtAliq(row.aliq)}`);
            return `<div class="ml-row"><div class="ml-k">${row.nome}<span class="ml-sub">${sub.join(' ‚Ä¢ ')}</span></div><div class="ml-v">${fmtMon(row.valor)}</div></div>`;
          }).join('') : '<div class="text-slate-400 text-sm">Sem tributos calculados.</div>';
        }
      }catch(_){ }

      if(el('totAtual')) el('totAtual').textContent = fmtMon(data.totalAtual || 0);
      if(el('totNovo')) el('totNovo').textContent = fmtMon(data.totalNovo || 0);
      // Add mobile summary footers
      try{
        const addSum = (idTotal,idEfet,into)=>{
          const wrap = el(into); if(!wrap) return;
          const tot = el(idTotal)?.textContent || '';
          const eff = el(idEfet)?.textContent || '';
          const sum = document.createElement('div');
          sum.className='ml-row';
          sum.innerHTML = `<div class="ml-k">Total<span class="ml-sub">Al√≠quota efetiva: ${eff}</span></div><div class="ml-v">${tot}</div>`;
          wrap.appendChild(sum);
        };
        addSum('totAtual','efetAtual','listAtual');
        addSum('totNovo','efetNovo','listNovo');
      }catch(_){ }
      

      const efetAtual = data.baseEfetivaAtual>0 ? (data.totalAtual/data.baseEfetivaAtual*100) : 0;
      const efetNovo = data.baseEfetivaNovo>0 ? (data.totalNovo/data.baseEfetivaNovo*100) : 0;
      if(el('efetAtual')) el('efetAtual').textContent = fmtPct(efetAtual);
      if(el('efetNovo')) el('efetNovo').textContent = fmtPct(efetNovo);

      const dif = (data.totalNovo||0) - (data.totalAtual||0);
      const pctVar = (data.totalAtual||0)>0 ? (dif/(data.totalAtual||1)*100) : ((data.totalNovo||0)>0?100:0);
      const difState = Math.abs(dif)>0.01 ? (dif>0?'diff-up':'diff-down') : 'diff-neutral';
      const pctState = Math.abs(pctVar)>0.01 ? (pctVar>0?'diff-up':'diff-down') : 'diff-neutral';

      const difAbsEl = el('difAbs'); if(difAbsEl) difAbsEl.textContent = fmtMon(dif);
      const difPctEl = el('difPct'); if(difPctEl) difPctEl.textContent = fmtPct(pctVar);
      const difAbsHint=el('difAbsHint'); if(difAbsHint) difAbsHint.textContent = dif>0 ? 'Maior carga que o modelo atual' : dif<0 ? 'Economia frente ao modelo atual' : 'Sem varia√ß√£o';
      const difPctHint=el('difPctHint'); if(difPctHint) difPctHint.textContent = dif>0 ? 'Aumento relativo da carga' : dif<0 ? 'Redu√ß√£o relativa da carga' : 'Sem varia√ß√£o';

      const cardDifAbs=el('cardDifAbs'); if(cardDifAbs){ cardDifAbs.classList.remove('diff-up','diff-down','diff-neutral'); cardDifAbs.classList.add(difState); }
      const cardDifPct=el('cardDifPct'); if(cardDifPct){ cardDifPct.classList.remove('diff-up','diff-down','diff-neutral'); cardDifPct.classList.add(pctState); }
      const cardTotais=el('cardTotais'); if(cardTotais){ cardTotais.classList.remove('diff-up','diff-down','diff-neutral'); cardTotais.classList.add(difState); }

      const difAbsIcon=el('difAbsIcon'); if(difAbsIcon) difAbsIcon.textContent = difState==='diff-up'?'‚ñ≤':difState==='diff-down'?'‚ñº':'‚ñ†';
      const difPctBar=el('difPctBar'); if(difPctBar){ difPctBar.style.width=`${Math.min(Math.abs(pctVar),100)}%`; difPctBar.classList.remove('diff-up','diff-down','diff-neutral'); difPctBar.classList.add(pctState); }
      const totIcon=el('totIcon'); if(totIcon) totIcon.textContent = difState==='diff-up'?'‚ñ≤':(difState==='diff-down'?'‚ñº':'‚áÜ');

      if(el('totAtualResumo')) el('totAtualResumo').textContent = fmtMon(data.totalAtual || 0);
      if(el('totNovoResumo')) el('totNovoResumo').textContent = fmtMon(data.totalNovo || 0);

      const buildResumoFallback = rows => rows.map(row=>{
        const baseValue = row.baseValue !== undefined ? row.baseValue : (row.hasBase ? row.base : 0);
        const aliq = row.hasBase && baseValue>0 ? row.valor / baseValue : null;
        return {
          nome: row.nome,
          key: row.nome,
          value: row.valor,
          base: row.hasBase ? baseValue : '‚Äî',
          baseValue,
          aliq,
          note: ''
        };
      });
      const resumoAtual = (data.arrAtual && data.arrAtual.length) ? data.arrAtual : buildResumoFallback(data.atualRows || []);
      const resumoNovo = (data.arrCenario && data.arrCenario.length) ? data.arrCenario : buildResumoFallback(data.novoRows || []);
      renderResumoComparativo(resumoAtual, resumoNovo, data.totalAtual, data.totalNovo, data.tituloNovo || 'Novo modelo', data.tituloAtual || 'Modelo atual');
    };

    const setReceitasTab = key => {
      const buttons = [...document.querySelectorAll('.rc-tab-btn')];
      const panels = [...document.querySelectorAll('.rc-tab-panel')];
      if(!buttons.length || !panels.length) return;
      const target = panels.some(panel => panel.dataset.rcPanel===key) ? key : RECEITAS_DEFAULT_TAB;
      buttons.forEach(btn=>{
        const isActive = btn.dataset.rcTab === target;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        btn.setAttribute('tabindex', isActive ? '0' : '-1');
      });
      panels.forEach(panel=>{
        const show = panel.dataset.rcPanel === target;
        panel.classList.toggle('hidden', !show);
        panel.setAttribute('role','tabpanel');
        panel.setAttribute('aria-hidden', show ? 'false' : 'true');
      });
      receitasTabsState.current = target;
    };

    const initReceitasTabs = () => {
      const buttons = [...document.querySelectorAll('.rc-tab-btn')];
      if(!buttons.length) return;
      buttons.forEach(btn=>{
        btn.setAttribute('role','tab');
        btn.addEventListener('click', ()=>setReceitasTab(btn.dataset.rcTab));
      });
      document.querySelector('.rc-tablist')?.setAttribute('role','tablist');
      setReceitasTab(receitasTabsState.current);
    };

    // (side steps navigation removed per request)

    // Abas de Al√≠quotas
    const setAlqTab = key => {
      const buttons = [...document.querySelectorAll('.alq-tab-btn')];
      const panels = [...document.querySelectorAll('[data-alq-panel]')];
      if(!buttons.length || !panels.length) return;
      const valid = panels.some(p => p.dataset.alqPanel===key) ? key : 'consumo';
      buttons.forEach(btn=>{
        const active = btn.dataset.alqTab===valid;
        btn.classList.toggle('is-active', active);
        btn.setAttribute('aria-selected', active?'true':'false');
        btn.setAttribute('tabindex', active?'0':'-1');
      });
      panels.forEach(p=>{
        const show = p.dataset.alqPanel===valid;
        p.classList.toggle('hidden', !show);
        p.setAttribute('role','tabpanel');
        p.setAttribute('aria-hidden', show?'false':'true');
      });
    };
    const initAlqTabs = () => {
      document.querySelectorAll('.alq-tab-btn').forEach(btn=>{
        btn.setAttribute('role','tab');
        btn.addEventListener('click',()=>setAlqTab(btn.dataset.alqTab));
      });
      setAlqTab('consumo');
    };


    const REDUCTIONS={
      pisCof:{select:'optRedPisCof', input:'redPisCof', wrap:'customWrapRedPisCof'},
      issIcms:{select:'optRedIssIcms', input:'redISSICMS', wrap:'customWrapRedIssIcms', label:'redISSICMSLabel'},
      ipi:{select:'optRedIPI', input:'redIPI', wrap:'customWrapRedIPI'},
      cbsIbs:{select:'optRedCBSIBS', input:'redCBSIBS', wrap:'customWrapRedCBSIBS'},
      seletivo:{select:'optRedSeletivo', input:'redSeletivo', wrap:'customWrapRedSeletivo'},
      irpj:{select:'optRedIRPJ', input:'redIRPJ', wrap:'customWrapRedIRPJ'}
    };

    const moneyInputs = ['receita','comprasNovo','comprasAtual','comprasICMS','baseSeletivo','despesasLucroReal','snRbt12'];
    moneyInputs.forEach(id => { const x = el(id); if(!x) return; x.addEventListener('blur', () => x.value = new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(parseBR(x.value))); });

    const setDis = (id, disabled) => { const x = el(id); if(!x) return; x.disabled = disabled; x.classList.toggle('opacity-60', disabled); x.classList.toggle('bg-slate-100', disabled); };
    const setDisMany = (ids, disabled) => ids.forEach(i=>setDis(i, disabled));
    const setScenarioDisabled = disabled => { const sel=el('cenario'); if(!sel) return; sel.disabled=disabled; sel.classList.toggle('opacity-60', disabled); sel.classList.toggle('bg-slate-100', disabled); };

    const setRedLabel = () => { const l = el('redISSICMSLabel'); if(!l) return; const tipo = el('tipoOper')?.value; if(tipo==='servico') l.textContent='ISS'; else if(tipo==='mercadoria') l.textContent='ICMS'; else l.textContent='ISS / ICMS'; };
    let reductionsGlobalDisabled=false;
    const reductionOverrides={ pisCof:false, issIcms:false, ipi:false, cbsIbs:false, seletivo:false, irpj:false };
    const isReductionActive = () => true;

    const refreshReductionUI = (globalDisabled=null)=>{
      if(globalDisabled!==null) reductionsGlobalDisabled=!!globalDisabled;
      const active=isReductionActive();
      Object.entries(REDUCTIONS).forEach(([key,cfg])=>{
        const sel=el(cfg.select);
        const input=el(cfg.input);
        const wrap=el(cfg.wrap);
        if(!sel || !input) return;
        const forced=reductionOverrides[key];
        const disabled=reductionsGlobalDisabled || forced || !active;
        setDis(cfg.select, disabled);
        const isCustom=sel.value==='custom';
        setDis(cfg.input, disabled || !isCustom);
        if(wrap) wrap.classList.toggle('hidden', !(isCustom && !disabled));
      });
    };

    const initReductions=()=>{
      Object.entries(REDUCTIONS).forEach(([key,cfg])=>{
        const sel=el(cfg.select);
        const input=el(cfg.input);
        if(!sel || !input) return;
        sel.addEventListener('change',()=>{
          if(sel.value!=='custom') input.value='0';
          refreshReductionUI();
          calcula();
        });
      });
      refreshReductionUI();
    };

    const applyActivityPreset = (activityId,{silent=false}={}) => {
      const cfg = OPERATION_ACTIVITIES[activityId] || OPERATION_ACTIVITIES.custom;
      const actSel = el('atividadeOper');
      if(actSel){
        suppressActivitySync = true;
        actSel.value = cfg.id;
        suppressActivitySync = false;
      }
      const tipoSel = el('tipoOper');
      if(tipoSel){
        tipoSel.value = cfg.tipoOper || 'servico';
        toggleImpostos();
        updateReceitasComprasVisibility();
      }
      const setPercentField = (fieldId,value)=>{
        const field=el(fieldId);
        if(!field || value===undefined || value===null) return;
        field.value = Number(value).toFixed(2);
      };
      if(cfg.presAliqIrpj!==undefined) setPercentField('presAliqIrpj', cfg.presAliqIrpj);
      if(cfg.presAliqCsll!==undefined) setPercentField('presAliqCsll', cfg.presAliqCsll);
      if(cfg.aliqOutros!==undefined) setPercentField('aliqOutros', cfg.aliqOutros);
      updatePresumidoInfo();
      if(!silent) calcula();
      return cfg;
    };

    const initOperationActivity = () => {
      const sel=el('atividadeOper');
      if(!sel) return;
      if(!OPERATION_ACTIVITIES[sel.value]) sel.value=DEFAULT_ACTIVITY_ID;
      applyActivityPreset(sel.value,{silent:true});
      // Set helpful titles for each option based on presets
      try{
        const toPct = n => `${Number(n).toFixed(0)}%`;
        const mapTipo = t => t==='mercadoria'?'Mercadoria':(t==='servico'?'Servi√ßo':(t==='none'?'Sem incid√™ncia':'‚Äî'));
        [...sel.options].forEach(opt=>{
          const key = opt.value; const cfg = OPERATION_ACTIVITIES[key];
          if(!cfg) return;
          const pk = cfg.presKey && PRES_ATIVIDADES[cfg.presKey];
          const ir = (cfg.presAliqIrpj!=null?cfg.presAliqIrpj:(pk?pk.irpj*100:null));
          const cs = (cfg.presAliqCsll!=null?cfg.presAliqCsll:(pk?pk.csll*100:null));
          const tip = mapTipo(cfg.tipoOper);
          const parts = [];
          if(tip) parts.push(`Tipo: ${tip}`);
          if(ir!=null && cs!=null) parts.push(`Presun√ß√£o LP: IRPJ ${toPct(ir)}, CSLL ${toPct(cs)}`);
          opt.title = parts.join(' ‚Ä¢ ');
        });
      }catch(_){ }
      sel.addEventListener('change',()=>{
        if(suppressActivitySync) return;
        applyActivityPreset(sel.value,{silent:true});
        updateReceitasComprasVisibility();
        calcula();
      });
    };

    const getReduction = key => {
      const cfg=REDUCTIONS[key];
      if(!cfg) return 0;
      const sel=el(cfg.select);
      const input=el(cfg.input);
      if(!sel || sel.disabled) return 0;
      if(sel.value==='custom'){
        return clamp01((+input?.value||0)/100);
      }
      return clamp01(parseFloat(sel.value)||0);
    };

    const toggleImpostos = () => {
      const tEl=el('tipoOper');
      const issGrp=el('grupoISS');
      const icmsGrp=el('grupoICMS');
      if(!tEl||!issGrp||!icmsGrp) return;
      if (tEl.value==='servico'){
        issGrp.classList.remove('hidden');
        icmsGrp.classList.add('hidden');
        setDis('iss',false);
        setDis('icms',true);
        setDis('comprasICMS',true);
        setDis('consideraCredICMS',true);
      } else if(tEl.value==='mercadoria'){
        icmsGrp.classList.remove('hidden');
        issGrp.classList.add('hidden');
        setDis('icms',false);
        setDis('iss',true);
        setDis('comprasICMS',false);
        setDis('consideraCredICMS',false);
      } else {
        issGrp.classList.add('hidden');
        icmsGrp.classList.add('hidden');
        setDis('iss',true);
        setDis('icms',true);
        setDis('comprasICMS',true);
        setDis('consideraCredICMS',true);
        const credChk=el('consideraCredICMS'); if(credChk) credChk.checked=false;
      }
      setRedLabel();
    };

    const updateReceitasComprasVisibility = () => {
      const regime = el('regimeTrib')?.value || 'real';
      const isSN = regime==='simples';
      const c = el('cenario')?.value || 'piloto2026';
      const tipo = el('tipoOper')?.value || 'servico';
      const act = el('atividadeOper')?.value || DEFAULT_ACTIVITY_ID;
      const scenariosSeletivo = new Set(['cbs2027','ibs2029','ibs2030','ibs2031','ibs2032','regime2033']);

      // Compras & cr√©ditos ‚Äì mostrar/ocultar campos internos
      const showComprasNovo = !isSN && c!=='piloto2026';
      const showComprasAtual = !isSN && regime==='real';
      let showComprasICMS = !isSN && tipo==='mercadoria';
      // Regra solicitada: sempre exibir Compras ICMS no Com√©rcio Varejista (real/presumido)
      if(!isSN && (regime==='real' || regime==='presumido') && act==='comercio_varejo'){
        showComprasICMS = true;
      }
      safe('wrapComprasNovo').toggle('hidden', !showComprasNovo);
      safe('wrapComprasAtual').toggle('hidden', !showComprasAtual);
      safe('wrapComprasICMS').toggle('hidden', !showComprasICMS);
      if(showComprasICMS){ setDis('comprasICMS', false); setDis('consideraCredICMS', false); }

      // Bases espec√≠ficas ‚Äì mostrar campos por aplicabilidade
      const showBaseSeletivo = !isSN && (regime==='real' || scenariosSeletivo.has(c));
      const showDespesasReal = !isSN && regime==='real';
      safe('wrapBaseSeletivo').toggle('hidden', !showBaseSeletivo);
      safe('wrapDespesasReal').toggle('hidden', !showDespesasReal);

      // Per√≠odo: irrelevante para Simples
      safe('blockPeriodo').toggle('hidden', isSN);
    };

    const showHideSN = () => {
      const isSN=el('regimeTrib')?.value==='simples';
      safe('snInlineConfig').toggle('hidden',!isSN);
      safe('snResumoWrap').toggle('hidden',!isSN);
      // Relat√≥rios e comparativos s√£o controlados pelo c√°lculo/simula√ß√µes
      safe('reduzWrap').toggle('hidden',isSN);
      if(isSN){
        const rbt=el('snRbt12');
        if(rbt && !parseBR(rbt.value)) rbt.value=el('receita')?.value||'0,00';
        calculaSN();
      }
    };    

    const aplicaRegime = () => { const r=el('regimeTrib')?.value; if(!r) return; if(r==='presumido'){ if(el('pis')) el('pis').value=0.65; if(el('cofins')) el('cofins').value=3; } else if(r==='real'){ if(el('pis')) el('pis').value=1.65; if(el('cofins')) el('cofins').value=7.6; }
      if(r!=='simples'){
        if(el('iss')) el('iss').value=5;
        if(el('icms')) el('icms').value=20;
        if(el('cbs')) el('cbs').value=12;
        if(el('ibs')) el('ibs').value=13;
        if(el('seletivo')) el('seletivo').value=0;
        if(el('cpp')) el('cpp').value='0';
        if(el('irpj')) el('irpj').value=15;
        if(el('csll')) el('csll').value=9;
      }
    };

    const aplicaCenarioNovo = () => { const c=currentScenario(); const cfg=SCENARIO_CONFIG[c]||SCENARIO_CONFIG.regime2033; if(cfg.auto){ if(el('cbs') && cfg.auto.cbs!==undefined) el('cbs').value=cfg.auto.cbs; if(el('ibs') && cfg.auto.ibs!==undefined) el('ibs').value=cfg.auto.ibs; if(el('seletivo') && cfg.auto.seletivo!==undefined) el('seletivo').value=cfg.auto.seletivo; }
      if(el('tituloNovo')) el('tituloNovo').textContent=cfg.title;
      if(el('rotTotNovo')) el('rotTotNovo').textContent=cfg.total;
    };

    const addRow = (tbody,nome,base,aliq,valor) => { if(!tbody) return; const tr=document.createElement('tr'); tr.innerHTML=`<td class="text-slate-600">${nome}</td><td class="text-right">${fmtBase(base)}</td><td class="text-right">${fmtAliq(aliq)}</td><td class="text-right">${fmtMon(valor)}</td>`; tbody.appendChild(tr); };
    const pushComp = (arr,nome,valor,base=null,aliq=null,opts={}) => {
      if(valor===undefined || valor===null) return;
      if(Math.abs(valor) < 1e-9) return;
      arr.push({ nome, key: opts.key || nome, value: valor, base, aliq, note: opts.note || '' });
    };

    const formatCellStack = (entry,total) => {
      if(!entry) return '<div class="text-slate-400">‚Äî</div>';
      const parts=[`<div class="font-semibold">${fmtMon(entry.value)}</div>`];
      if(total>0) parts.push(`<div class="text-xs text-slate-500">Participa√ß√£o: ${fmtPct(entry.value/total*100)}</div>`);
      if(entry.base!==undefined && entry.base!==null && entry.base!=='‚Äî') parts.push(`<div class="text-xs text-slate-400">Base: ${fmtBase(entry.base)}</div>`);
      if(entry.aliq!==undefined && entry.aliq!==null && entry.aliq!=='‚Äî') parts.push(`<div class="text-xs text-slate-400">Al√≠quota: ${fmtAliq(entry.aliq)}</div>`);
      if(entry.note) parts.push(`<div class="text-xs text-slate-400">${entry.note}</div>`);
      return parts.join('');
    };

    const renderResumoComparativo = (dadosAtual,dadosNovo,totalAtual,totalNovo,tituloNovo='Cen√°rio',tituloAtual='Modelo atual') => {
      const body=el('resumoBody'); if(!body) return;
      const small = (self.innerWidth||0) <= 420;
      const headAtual=el('resHeadAtual'); if(headAtual) headAtual.textContent = small ? 'Atual' : tituloAtual;
      const headNovo=el('resHeadNovo'); if(headNovo) headNovo.textContent = small ? 'Cen√°rio' : tituloNovo;
      const mapAtual=Object.create(null);
      const mapNovo=Object.create(null);
      (dadosAtual||[]).forEach(item=>{ mapAtual[item.key||item.nome]=item; });
      (dadosNovo||[]).forEach(item=>{ mapNovo[item.key||item.nome]=item; });
      const keys=new Set([...Object.keys(mapAtual), ...Object.keys(mapNovo)]);
      const sorted=[...keys].sort((a,b)=>{
        const novoB=mapNovo[b]?.value||0;
        const novoA=mapNovo[a]?.value||0;
        if(novoB!==novoA) return novoB-novoA;
        const atualB=mapAtual[b]?.value||0;
        const atualA=mapAtual[a]?.value||0;
        return atualB-atualA;
      });
      if(!sorted.length){
        body.innerHTML='<tr><td colspan="4" class="text-center text-slate-500 text-sm">Nenhum tributo calculado para este cen√°rio.</td></tr>';
        try{ const cardsWrap = el('resumoCards'); if(cardsWrap) cardsWrap.innerHTML=''; }catch(_){ }
      } else {
        body.innerHTML=sorted.map(key=>{
          const atualEntry=mapAtual[key];
          const novoEntry=mapNovo[key];
          const label=atualEntry?.nome || novoEntry?.nome || key;
          const diff=(novoEntry?.value||0)-(atualEntry?.value||0);
          const diffClass=diff>0?'diff-pos':diff<0?'diff-neg':'';
          const diffParts=[`<div class="font-semibold">${fmtMon(diff)}</div>`];
          if(atualEntry && atualEntry.value){
            const perc=diff/atualEntry.value*100;
            diffParts.push(`<div class=\"text-xs text-slate-500\">Varia√ß√£o: ${diff>0?'+':''}${fmtPct(perc)}</div>`);
          } else if(Math.abs(diff)>1e-9){
            diffParts.push('<div class="text-xs text-slate-500">Sem base no modelo atual</div>');
          }
          return `<tr>
            <td>${label}</td>
            <td class="text-right cell-stack">${formatCellStack(atualEntry,totalAtual)}</td>
            <td class="text-right cell-stack">${formatCellStack(novoEntry,totalNovo)}</td>
            <td class="text-right cell-stack ${diffClass}">${diffParts.join('')}</td>
          </tr>`;
        }).join('');
        // Also render mobile card summary
        try{
          const cardsWrap = el('resumoCards');
          if(cardsWrap){
            cardsWrap.innerHTML = sorted.map(key=>{
              const atualEntry=mapAtual[key];
              const novoEntry=mapNovo[key];
              const label=atualEntry?.nome || novoEntry?.nome || key;
              const valA = fmtMon((atualEntry?.value)||0);
              const valN = fmtMon((novoEntry?.value)||0);
              const diff=(novoEntry?.value||0)-(atualEntry?.value||0);
              const perc = (atualEntry && atualEntry.value) ? (diff/(atualEntry.value||1)*100) : null;
              const diffClass = diff>0?'diff-pos':diff<0?'diff-neg':'';
              const varTxt = perc!=null ? `${diff>0?'+':''}${fmtPct(perc)}` : '';
              return `
                <section class="section-block">
                  <div class="section-block__header">
                    <span class="section-block__label">${label}</span>
                    <span class="section-block__hint">${varTxt?`Varia√ß√£o: ${varTxt}`:''}</span>
                  </div>
                  <div class="section-block__content">
                    <div class="w-kv"><div class="k">Atual</div><div class="v">${valA}</div></div>
                    <div class="w-kv"><div class="k">Cen√°rio</div><div class="v">${valN}</div></div>
                    <div class="w-kv"><div class="k">Dif.</div><div class="v ${diffClass}">${fmtMon(diff)}</div></div>
                  </div>
                </section>`;
            }).join('');
          }
        }catch(_){ }
      }
      const totAtualEl=el('resTotAtual'); if(totAtualEl) totAtualEl.textContent=fmtMon(totalAtual);
      const totNovoEl=el('resTotNovo'); if(totNovoEl) totNovoEl.textContent=fmtMon(totalNovo);
      const totDifEl=el('resTotDif');
      if(totDifEl){
        const diff=totalNovo-totalAtual;
        totDifEl.textContent=fmtMon(diff);
        totDifEl.classList.remove('diff-pos','diff-neg');
        if(diff>0) totDifEl.classList.add('diff-pos'); else if(diff<0) totDifEl.classList.add('diff-neg');
      }
      try{ window.updateMiniCharts(totalAtual, totalNovo, dadosAtual, dadosNovo); }catch(_){ }
    };

    const PRES_ATIVIDADES={
      comercio:{ irpj:0.08, csll:0.12, ref:'Lei 9.249/1995, art. 15, III ‚Äúa‚Äù e Lei 7.689/1988, art. 20.' },
      transportes:{ irpj:0.08, csll:0.12, ref:'Lei 9.249/1995, art. 15, III ‚Äúa‚Äù.' },
      passageiros:{ irpj:0.16, csll:0.12, ref:'Lei 9.249/1995, art. 15, ¬ß1¬∫ III.' },
      hospitalar:{ irpj:0.08, csll:0.12, ref:'Lei 9.249/1995, art. 15, ¬ß1¬∫ III ‚Äúa‚Äù.' },
      combustiveis:{ irpj:0.016, csll:0.12, ref:'Lei 9.718/1998, art. 15.' },
      retpa:{ irpj:0.04, csll:0.04, ref:'Regime especial da constru√ß√£o civil ‚Äì Lei 10.931/2004 (RET).' },
      locacao:{ irpj:0.32, csll:0.32, ref:'Loca√ß√£o de bens im√≥veis ‚Äì Lei 9.249/1995, art. 15, ¬ß1¬∫ III ‚Äúc‚Äù.' },
      servicos:{ irpj:0.32, csll:0.32, ref:'Lei 9.249/1995, art. 15, ¬ß1¬∫ III ‚Äúc‚Äù.' }
    };
    const IRPJ_EXTRA_THRESHOLD=20000;

    const defaultPresAtividade=()=>{
      const actSel = el('atividadeOper')?.value || DEFAULT_ACTIVITY_ID;
      const cfg = OPERATION_ACTIVITIES[actSel] || OPERATION_ACTIVITIES.custom;
      return cfg.presKey || 'servicos';
    };
    const updatePresumidoInfo=()=>{
      const regime = el('regimeTrib')?.value;
      if(regime!=='presumido') return;
      const actSel = el('atividadeOper')?.value || DEFAULT_ACTIVITY_ID;
      const cfg = OPERATION_ACTIVITIES[actSel] || OPERATION_ACTIVITIES.custom;
      if(cfg && cfg.presAliqIrpj!==undefined) setPercentField('presAliqIrpj', cfg.presAliqIrpj);
      if(cfg && cfg.presAliqCsll!==undefined) setPercentField('presAliqCsll', cfg.presAliqCsll);
    };

    const SN_LIMITS=[180000,360000,720000,1800000,3600000,4800000];
    const SN={ I:[[0.04,0],[0.073,5940],[0.095,13860],[0.107,22500],[0.143,87300],[0.19,378000]], II:[[0.045,0],[0.078,5940],[0.10,13860],[0.112,22500],[0.147,85500],[0.30,720000]], III:[[0.06,0],[0.112,9360],[0.135,17640],[0.16,35640],[0.21,125640],[0.33,648000]], IV:[[0.045,0],[0.09,8100],[0.102,12420],[0.14,39780],[0.22,183780],[0.33,828000]], V:[[0.155,0],[0.18,4500],[0.195,9900],[0.205,17100],[0.23,62100],[0.305,540000]] };
    // Reparti√ß√£o do DAS por anexo/faixa (quando dispon√≠vel). Fallback: reparti√ß√£o fixa por anexo
    const SN_SPLIT_FAIXA={
      I:[
        { IRPJ:0.040, CSLL:0.035, COFINS:0.165, PIS:0.035, CPP:0.420, ICMS:0.305 },
        { IRPJ:0.040, CSLL:0.035, COFINS:0.165, PIS:0.035, CPP:0.420, ICMS:0.305 },
        { IRPJ:0.040, CSLL:0.035, COFINS:0.165, PIS:0.035, CPP:0.420, ICMS:0.305 },
        { IRPJ:0.040, CSLL:0.035, COFINS:0.165, PIS:0.035, CPP:0.420, ICMS:0.305 },
        { IRPJ:0.040, CSLL:0.035, COFINS:0.165, PIS:0.035, CPP:0.420, ICMS:0.305 },
        { IRPJ:0.040, CSLL:0.035, COFINS:0.165, PIS:0.035, CPP:0.420, ICMS:0.305 },
      ],
      II:[
        { IRPJ:0.045, CSLL:0.035, COFINS:0.165, PIS:0.035, CPP:0.420, ICMS:0.300 },
        { IRPJ:0.045, CSLL:0.035, COFINS:0.165, PIS:0.035, CPP:0.420, ICMS:0.300 },
        { IRPJ:0.045, CSLL:0.035, COFINS:0.165, PIS:0.035, CPP:0.420, ICMS:0.300 },
        { IRPJ:0.045, CSLL:0.035, COFINS:0.165, PIS:0.035, CPP:0.420, ICMS:0.300 },
        { IRPJ:0.045, CSLL:0.035, COFINS:0.165, PIS:0.035, CPP:0.420, ICMS:0.300 },
        { IRPJ:0.045, CSLL:0.035, COFINS:0.165, PIS:0.035, CPP:0.420, ICMS:0.300 },
      ],
      // Anexo III ‚Äì Servi√ßos (valores por faixa; aproximados de extratos oficiais)
      // Faixas 1..6: shares somam 1.0
      III:[
        { IRPJ:0.0402, CSLL:0.0351, COFINS:0.1284, PIS:0.0277, CPP:0.4340, ISS:0.3346 }, // Faixa 1 ‚Äì calibrado por extrato (6,00%)
        { IRPJ:0.0400, CSLL:0.0350, COFINS:0.1330, PIS:0.0289, CPP:0.4200, ISS:0.3431 }, // Faixa 2
        { IRPJ:0.0450, CSLL:0.0350, COFINS:0.1550, PIS:0.0350, CPP:0.4200, ISS:0.3100 }, // Faixa 3 (padr√£o anterior)
        { IRPJ:0.0400, CSLL:0.0350, COFINS:0.1365, PIS:0.0296, CPP:0.4340, ISS:0.3250 }, // Faixa 4 (ajustado p/ extrato informado)
        { IRPJ:0.0400, CSLL:0.0350, COFINS:0.1330, PIS:0.0290, CPP:0.4340, ISS:0.3290 }, // Faixa 5 (aprox.)
        { IRPJ:0.0500, CSLL:0.0350, COFINS:0.1173, PIS:0.0275, CPP:0.4340, ISS:0.3362 }, // Faixa 6 (aprox.)
      ],
      // Anexo IV ‚Äì Servi√ßos (CPP fora do DAS; shares renormalizados para o DAS)
      IV:[
        { IRPJ:0.07951, CSLL:0.06184, COFINS:0.21201, PIS:0.04770, ISS:0.59894 },
        { IRPJ:0.07951, CSLL:0.06184, COFINS:0.21201, PIS:0.04770, ISS:0.59894 },
        { IRPJ:0.07951, CSLL:0.06184, COFINS:0.21201, PIS:0.04770, ISS:0.59894 },
        { IRPJ:0.07951, CSLL:0.06184, COFINS:0.21201, PIS:0.04770, ISS:0.59894 },
        { IRPJ:0.07951, CSLL:0.06184, COFINS:0.21201, PIS:0.04770, ISS:0.59894 },
        { IRPJ:0.07951, CSLL:0.06184, COFINS:0.21201, PIS:0.04770, ISS:0.59894 },
      ],
      V:[
        { IRPJ:0.128, CSLL:0.128, COFINS:0.142, PIS:0.034, CPP:0.278, ISS:0.290 },
        { IRPJ:0.128, CSLL:0.128, COFINS:0.142, PIS:0.034, CPP:0.278, ISS:0.290 },
        { IRPJ:0.128, CSLL:0.128, COFINS:0.142, PIS:0.034, CPP:0.278, ISS:0.290 },
        { IRPJ:0.128, CSLL:0.128, COFINS:0.142, PIS:0.034, CPP:0.278, ISS:0.290 },
        { IRPJ:0.128, CSLL:0.128, COFINS:0.142, PIS:0.034, CPP:0.278, ISS:0.290 },
        { IRPJ:0.128, CSLL:0.128, COFINS:0.142, PIS:0.034, CPP:0.278, ISS:0.290 },
      ],
    };

    const SN_SPLIT={
      I:{ IRPJ:0.04, CSLL:0.035, COFINS:0.165, PIS:0.035, CPP:0.42, ICMS:0.305 },
      II:{ IRPJ:0.045, CSLL:0.035, COFINS:0.165, PIS:0.035, CPP:0.42, ICMS:0.3 },
      III:{ IRPJ:0.045, CSLL:0.035, COFINS:0.155, PIS:0.035, CPP:0.42, ISS:0.31 },
      // Anexo IV: CPP fora do DAS; shares renormalizados (somam 1)
      IV:{ IRPJ:0.07951, CSLL:0.06184, COFINS:0.21201, PIS:0.04770, ISS:0.59894 },
      V:{ IRPJ:0.128, CSLL:0.128, COFINS:0.142, PIS:0.034, CPP:0.278, ISS:0.29 },
      default:{ IRPJ:0.045, CSLL:0.035, COFINS:0.155, PIS:0.035, CPP:0.42, ISS:0.31 }
    };

    let lastSNCalc={total:0, breakdown:[], fatorR:null, anexo:'III', faixa:1, efetiva:0, rbt12:0, receita:0, folha:0, aliqNominal:0, parcelaDedutivel:0, fatorRAplicado:false, anexoOriginal:'III'};

    const snFaixa=(anexo,rbt12)=>{ const tbl=SN[anexo]; let idx=0; for(let i=0;i<SN_LIMITS.length;i++){ if(rbt12>SN_LIMITS[i]) idx=i+1; } if(tbl && idx>=tbl.length) idx=tbl.length-1; if(idx<0) idx=0; const [aliq,pd]=(tbl&&tbl[idx])?tbl[idx]:(tbl?tbl[tbl.length-1]:[0,0]); return {faixa:idx+1,aliq,pd}; };

    const snUsesFatorR=()=> el('snAnexo')?.value==='V' && !!el('snFatorToggle')?.checked;

    const applySNRateFields=(split,efetiva)=>{
      if(el('regimeTrib')?.value!=='simples') return;
      const setRate=(id,share)=>{
        const input=el(id);
        if(!input) return;
        const rate=(share||0)*efetiva*100;
        input.value=rate.toFixed(2);
      };
      setRate('pis',split.PIS);
      setRate('cofins',split.COFINS);
      setRate('irpj',split.IRPJ);
      setRate('csll',split.CSLL);
      setRate('cpp',split.CPP);
      setRate('iss',split.ISS || 0);
      setRate('icms',split.ICMS || 0);
    };

    const defaultSNAnexo=()=> (el('tipoOper')?.value==='mercadoria'?'I':'III');
    const ensureSNAnexo=()=>{
      const sel=el('snAnexo');
      if(!sel) return;
      if(sel.dataset.userChoice==='true') return;
      const def=defaultSNAnexo();
      if(sel.value!==def){
        sel.value=def;
      }
    };

    const updateSNControls=()=>{
      const anexo=el('snAnexo')?.value||'III';
      const toggleWrap=el('snFatorToggleWrap');
      if(toggleWrap) toggleWrap.classList.toggle('hidden',anexo!=='V');
      if(anexo!=='V' && el('snFatorToggle')) el('snFatorToggle').checked=false;
      const usaFR=snUsesFatorR();
      const info=el('snFRInfo');
      if(info){
        if(anexo==='V'){
          info.textContent=usaFR?'Fator R aplicado: utilizando al√≠quotas do Anexo III.':'Marque o Fator R quando a folha for pelo menos 28% do RBT12.';
        } else {
          info.textContent='Fator R n√£o se aplica ao anexo selecionado.';
        }
      }
      calculaSN();
    };

    const calculaSN=()=>{
      const resumoWrap=el('snResumoWrap');
      if(!resumoWrap) return;

      const receitaPeriodo=Math.max(parseBR(el('receita')?.value)||0,0);
      const rbt12Raw=parseBR(el('snRbt12')?.value)||0;
      const rbt12=rbt12Raw>0?rbt12Raw:(receitaPeriodo||0);
      const axSel=el('snAnexo')?.value||'III';

      const usaFR=snUsesFatorR();
      let anexoFinal=axSel;
      let fatorRAplicado=false;
      if(axSel==='V' && usaFR){
        anexoFinal='III';
        fatorRAplicado=true;
      }

      const dados=snFaixa(anexoFinal,rbt12);
      const efetiva=rbt12>0
        ? Math.max((rbt12*dados.aliq - dados.pd)/rbt12,0)
        : Math.max(dados.aliq,0);
      const das=receitaPeriodo*efetiva;

      const labelAnexo=`Anexo ${anexoFinal}`+(fatorRAplicado?' (Fator R aplicado)':'');
      if(el('snResumoAnexo')) el('snResumoAnexo').textContent=labelAnexo;
      if(el('snResumoHint')) el('snResumoHint').textContent=rbt12>0
        ? `Base RBT12 ${fmtMon(rbt12)}`
        : 'RBT12 n√£o informado (faixa 1 considerada)';
      if(el('snResumoFaixa')) el('snResumoFaixa').textContent=`Faixa ${dados.faixa}`;
      if(el('snResumoFaixaHint')) el('snResumoFaixaHint').textContent=`Al√≠quota nominal ${(dados.aliq*100).toFixed(2).replace('.',',')}% ‚Ä¢ Parcela dedut√≠vel ${fmtMon(dados.pd)}`;
      if(el('snAliq')) el('snAliq').textContent=fmtPct(efetiva*100);
      if(el('snTot')) el('snTot').textContent=fmtMon(das);
      if(el('snResumoEfet')) el('snResumoEfet').textContent=receitaPeriodo>0
        ? `Aplicado sobre ${fmtMon(receitaPeriodo)} do per√≠odo`
        : 'Informe a receita do per√≠odo.';

      const info=el('snFRInfo');
      if(info){
        if(axSel==='V'){
          info.textContent=usaFR?'Fator R aplicado: utilizando al√≠quotas do Anexo III.':'Marque o Fator R quando a folha for pelo menos 28% do RBT12.';
        } else {
          info.textContent='Fator R n√£o se aplica ao anexo selecionado.';
        }
      }

      const split=(SN_SPLIT_FAIXA[anexoFinal] && SN_SPLIT_FAIXA[anexoFinal][(dados.faixa||1)-1]) || SN_SPLIT[anexoFinal] || SN_SPLIT.default;
      const breakdown=[];
      let fatorNotePend=fatorRAplicado;
      Object.entries(split).forEach(([trib,share])=>{
        const valor=das*share;
        const aliqComp=efetiva*share;
        const note=fatorNotePend? 'Fator R ‚â•28% aplicado.' : '';
        breakdown.push({nome:trib,key:trib,value:valor,base:receitaPeriodo,aliq:aliqComp,share,note});
        fatorNotePend=false;
      });

      lastSNCalc={
        total:das,
        breakdown,
        fatorR:usaFR?28:null,
        anexo:anexoFinal,
        faixa:dados.faixa,
        efetiva,
        rbt12,
        receita:receitaPeriodo,
        folha:0,
        aliqNominal:dados.aliq,
        parcelaDedutivel:dados.pd,
        fatorRAplicado,
        anexoOriginal:axSel
      };
      applySNRateFields(split,efetiva);
    };

    const applyContextUI=()=>{ aplicaRegime(); aplicaCenarioNovo(); const regimeEl=el('regimeTrib'); if(!regimeEl) return; const regime=regimeEl.value; const c=currentScenario(); const cfg=SCENARIO_CONFIG[c]||SCENARIO_CONFIG.regime2033; const isSN=regime==='simples'; const atividadeSel=el('atividadeOper'); if(atividadeSel && !suppressActivityPreset) applyActivityPreset(atividadeSel.value||DEFAULT_ACTIVITY_ID,{silent:true}); setScenarioDisabled(false); showHideSN();
      Object.keys(reductionOverrides).forEach(k=>reductionOverrides[k]=false);
      if(isSN){
        setDisMany(['pis','cofins','iss','icms','ipi','cbs','ibs','seletivo','irpj','csll','cpp','comprasNovo','comprasAtual','comprasICMS','baseSeletivo','despesasLucroReal','consideraCredAtual','consideraCredICMS','consideraCredNovo'],true);
        refreshReductionUI(true);
        ensureSNAnexo();
        updateSNControls();
        setDis('receita',false);
      } else {
        setDisMany(['pis','cofins','iss','icms','ipi','irpj','csll','cpp','comprasNovo','comprasAtual','comprasICMS','baseSeletivo','despesasLucroReal','consideraCredAtual','consideraCredICMS','consideraCredNovo','cbs','ibs','seletivo'],false);
        if(c==='piloto2026'){ reductionOverrides.cbsIbs=true; reductionOverrides.seletivo=true; }
        refreshReductionUI(false);
        if(c==='piloto2026'){ setDisMany(['cbs','ibs','seletivo','comprasNovo','consideraCredNovo','baseSeletivo'],true); if(el('consideraCredNovo')) el('consideraCredNovo').checked=false; }
        else if(c==='cbs2027'){ setDis('ibs',true); setDis('cbs',false); setDis('baseSeletivo',false); setDis('comprasNovo',false); setDis('consideraCredNovo',false); }
        else { setDis('cbs',false); setDis('ibs',false); setDis('baseSeletivo',false); setDis('comprasNovo',false); setDis('consideraCredNovo',false); setDis('seletivo',false); }
        if(regime==='presumido'){ if(el('consideraCredAtual')) el('consideraCredAtual').checked=false; setDis('consideraCredAtual',true); setDis('comprasAtual',true); setDis('despesasLucroReal',true);} else if(regime==='real'){ setDis('consideraCredAtual',false); setDis('comprasAtual',false); setDis('despesasLucroReal',false);} else { setDis('despesasLucroReal',true);}        
        updateSNControls();
      }
      toggleImpostos(); updatePresumidoInfo(); updateReceitasComprasVisibility();

      const showCompras=!isSN;
      safe('blockCompras').toggle('hidden',!showCompras);

      const scenariosSeletivo=new Set(['cbs2027','ibs2029','ibs2030','ibs2031','ibs2032','regime2033']);
      const showBases=(regime==='real') || (scenariosSeletivo.has(c) && !isSN);
      safe('blockBases').toggle('hidden',!showBases);
      updateQuickStats();
    };

        const calcula = () => {
          const statusEl = el('status');
          if(statusEl) statusEl.textContent = 'Calculando‚Ä¶';
          const entradas = baseDataset.length ? baseDataset : [];
          if(!entradas.length){
            clearSimulationOutputs();
            // Oculta relat√≥rios/gr√°ficos enquanto n√£o h√° simula√ß√µes
            safe('cardsPadrao').toggle('hidden', true);
            safe('comparativoWrap').toggle('hidden', true);
            safe('reportsEmpty').toggle('hidden', false);
            if(statusEl) statusEl.textContent = 'Adicione dados para calcular.';
            try{ localStorage.setItem('fiscalflash:last', JSON.stringify(snapshot())); }catch(_){ }
            updateQuickStats();
            hasSimulated = false;
            lockGlobalConfigIfHasItems();
            return;
          }
          const data = aggregateEntries(entradas);
          renderSimulationOutputs(data);
          // Exibe relat√≥rios/gr√°ficos quando houver simula√ß√µes
          safe('cardsPadrao').toggle('hidden', false);
          safe('comparativoWrap').toggle('hidden', false);
          safe('reportsEmpty').toggle('hidden', true);
          if(statusEl) statusEl.textContent = 'Pronto';
          try{ localStorage.setItem('fiscalflash:last', JSON.stringify(snapshot())); }catch(_){ }
          updateQuickStats();
      hasSimulated = true;
      lockGlobalConfigIfHasItems();
        };

    initReductions();

    const init=()=>{ initReceitasTabs(); initAlqTabs(); initBaseDataset(); initOperationActivity(); applyContextUI(); calcula(); };

    document.getElementById('btnCalcular')?.addEventListener('click',()=>{
      captureBaseDatasetEntry();
      calcula();
      const statusEl = el('status');
      if(statusEl){
        statusEl.textContent = `Base atualizada (${baseDataset.length} itens)`;
        setTimeout(()=>{ if(statusEl.textContent?.startsWith('Base atualizada')) statusEl.textContent='Pronto'; }, 2500);
      }
    });

    document.getElementById('btnReset')?.addEventListener('click',()=>{
      if(!el('receita')) return;
      const ok = confirm('Limpar todos os campos e remover itens da base?');
      if(!ok) return;
      el('receita').value='100.000,00';
      el('meses').value='1';
      el('comprasAtual').value='50.000,00';
      el('comprasNovo').value='50.000,00';
      if(el('comprasICMS')) el('comprasICMS').value='50.000,00';
      el('baseSeletivo').value='0,00';
      el('despesasLucroReal').value='80.000,00';
      if(el('presAtividade')){ el('presAtividade').dataset.userChoice='false'; el('presAtividade').value=defaultPresAtividade(); }
      el('pis').value=1.65; el('cofins').value=7.6; el('iss').value=5; el('icms').value=20; el('ipi').value=0; el('cbs').value=12; el('ibs').value=13; el('seletivo').value=0; el('irpj').value=15; el('csll').value=9;
      if(el('cpp')) el('cpp').value='0';
      if(el('snRbt12')) el('snRbt12').value='0,00';
      if(el('snAnexo')){ el('snAnexo').value=defaultSNAnexo(); el('snAnexo').dataset.userChoice='false'; }
      if(el('snFatorToggle')) el('snFatorToggle').checked=false;
      if(el('regimeTrib')) el('regimeTrib').value='real';
      const sel=el('cenario'); if(sel) sel.value='piloto2026';
      baseDataset.length=0; renderBaseDataset(); aplicaCenarioNovo(); applyContextUI(); clearSimulationOutputs(); hasSimulated=false; lockGlobalConfigIfHasItems(); calcula();
      const statusEl=el('status'); if(statusEl) statusEl.textContent='Base limpa';
      try{ localStorage.removeItem('taxasim:last'); localStorage.removeItem('fiscalflash:last'); }catch(_){ }
      updateQuickStats();
    });

    // A√ß√µes r√°pidas: selecionar/limpar impostos inclu√≠dos
    const setIncAll = (val) => {
      const ids = ['incPisCof','incIssIcms','incIpi','incCbsIbs','incSeletivo','incIrpj','incCsll','incOutros'];
      ids.forEach(id => { const elx = document.getElementById(id); if (elx) elx.checked = !!val; });
      calcula();
    };
    document.getElementById('btnIncAll')?.addEventListener('click', ()=> setIncAll(true));
    document.getElementById('btnIncNone')?.addEventListener('click', ()=> setIncAll(false));

    // tipoOper √© derivado automaticamente do Segmento/Atividade; sem evento manual
    el('regimeTrib')?.addEventListener('change',()=>{ applyContextUI(); updateReceitasComprasVisibility(); updatePresumidoInfo(); calcula(); });
    // Presun√ß√£o √© ajustada pelo Segmento/Atividade; n√£o h√° seletor dedicado
    el('cenario')?.addEventListener('change',()=>{ applyContextUI(); updateReceitasComprasVisibility(); calcula(); });
    el('snAnexo')?.addEventListener('change',()=>{ const sel=el('snAnexo'); if(sel) sel.dataset.userChoice='true'; updateSNControls(); calcula(); });
    el('snFatorToggle')?.addEventListener('change',()=>{ updateSNControls(); calcula(); });
    el('snCompararFora')?.addEventListener('change',()=>{ calcula(); });

    // Ativa√ß√£o n√£o √© necess√°ria; campos de redu√ß√£o ficam sempre dispon√≠veis

    ['input','change'].forEach(evt=>{
      document.body.addEventListener(evt,e=>{
        if(e.target && (e.target.matches('input')||e.target.matches('select'))){
          clearTimeout(window.__deb);
          window.__deb=setTimeout(()=>{
            const id=e.target.id||'';
            if(id==='snRbt12'){ calculaSN(); }
            calcula();
            updateQuickStats();
          },120);
        }
      });
    });

    const snapshot=()=>({
      receita:el('receita')?.value,
      meses:el('meses')?.value,
      comprasAtual:el('comprasAtual')?.value,
      comprasNovo:el('comprasNovo')?.value,
      comprasICMS:el('comprasICMS')?.value,
      baseSeletivo:el('baseSeletivo')?.value,
      despesasReal:el('despesasLucroReal')?.value,
      presAt:el('presAtividade')?.value,
      pis:el('pis')?.value,
      cofins:el('cofins')?.value,
      iss:el('iss')?.value,
      icms:el('icms')?.value,
      ipi:el('ipi')?.value,
      cbs:el('cbs')?.value,
      ibs:el('ibs')?.value,
      seletivo:el('seletivo')?.value,
      irpj:el('irpj')?.value,
      csll:el('csll')?.value,
      cpp:el('cpp')?.value,
      aliqOutros:el('aliqOutros')?.value,
      presAliqIrpj:el('presAliqIrpj')?.value,
      presAliqCsll:el('presAliqCsll')?.value,
      credA:el('consideraCredAtual')?.checked,
      credIcms:el('consideraCredICMS')?.checked,
      credN:el('consideraCredNovo')?.checked,
      tipo:el('tipoOper')?.value,
      atividade:el('atividadeOper')?.value,
      regime:el('regimeTrib')?.value,
      cenario:el('cenario')?.value,
      optPisCof:el('optRedPisCof')?.value,
      optIssIcms:el('optRedIssIcms')?.value,
      optIPI:el('optRedIPI')?.value,
      optCBSIBS:el('optRedCBSIBS')?.value,
      optSeletivo:el('optRedSeletivo')?.value,
      optIRPJ:el('optRedIRPJ')?.value,
      redPC:el('redPisCof')?.value,
      redII:el('redISSICMS')?.value,
      redIPI:el('redIPI')?.value,
      redCB:el('redCBSIBS')?.value,
      redSE:el('redSeletivo')?.value,
      redIR:el('redIRPJ')?.value,
      snRbt:el('snRbt12')?.value,
      snAnexo:el('snAnexo')?.value,
      snFator:el('snFatorToggle')?.checked,
      dataset: baseDataset.map(item=>({
        ...item,
        addedAt: item.addedAt instanceof Date ? item.addedAt.toISOString() : item.addedAt
      }))
    });

    const restore=s=>{ if(!s) return; if(el('receita')) el('receita').value=s.receita; if(el('meses') && s.meses!==undefined) el('meses').value=s.meses; if(el('comprasAtual')) el('comprasAtual').value=s.comprasAtual; if(el('comprasNovo')) el('comprasNovo').value=s.comprasNovo; if(el('comprasICMS') && s.comprasICMS!==undefined) el('comprasICMS').value=s.comprasICMS; if(el('baseSeletivo')) el('baseSeletivo').value=s.baseSeletivo; if(el('despesasLucroReal')) el('despesasLucroReal').value=s.despesasReal||'0,00'; if(el('presAtividade') && s.presAt){ el('presAtividade').value=s.presAt; el('presAtividade').dataset.userChoice='true'; }
      const atividadeRestore = s.atividade || DEFAULT_ACTIVITY_ID;
      if(el('atividadeOper')){
        suppressActivitySync=true;
        el('atividadeOper').value=atividadeRestore;
        suppressActivitySync=false;
        applyActivityPreset(atividadeRestore,{silent:true});
      }
      if(el('pis')) el('pis').value=s.pis;
      if(el('cofins')) el('cofins').value=s.cofins;
      if(el('iss')) el('iss').value=s.iss;
      if(el('icms')) el('icms').value=s.icms;
      if(el('ipi')) el('ipi').value=s.ipi;
      if(el('cbs')) el('cbs').value=s.cbs;
      if(el('ibs')) el('ibs').value=s.ibs;
      if(el('seletivo')) el('seletivo').value=s.seletivo;
      if(el('irpj')) el('irpj').value=s.irpj;
      if(el('csll')) el('csll').value=s.csll;
      if(el('cpp') && s.cpp!==undefined) el('cpp').value=s.cpp;
      if(el('aliqOutros') && s.aliqOutros!==undefined) el('aliqOutros').value=s.aliqOutros;
      if(el('presAliqIrpj') && s.presAliqIrpj!==undefined) el('presAliqIrpj').value=s.presAliqIrpj;
      if(el('presAliqCsll') && s.presAliqCsll!==undefined) el('presAliqCsll').value=s.presAliqCsll;
      if(el('consideraCredAtual')) el('consideraCredAtual').checked=!!s.credA;
      if(el('consideraCredNovo')) el('consideraCredNovo').checked=!!s.credN; if(el('consideraCredICMS')) el('consideraCredICMS').checked=!!s.credIcms;
      if(el('tipoOper')){
        suppressTipoOperSync=true;
        el('tipoOper').value=s.tipo;
        suppressTipoOperSync=false;
      }
      if(el('regimeTrib')) el('regimeTrib').value=s.regime;
      if(el('cenario') && s.cenario) el('cenario').value=s.cenario;
      if(el('snRbt12') && s.snRbt!==undefined) el('snRbt12').value=s.snRbt;
      if(el('snAnexo') && s.snAnexo!==undefined) el('snAnexo').value=s.snAnexo;
      if(el('snFatorToggle') && s.snFator!==undefined) el('snFatorToggle').checked=!!s.snFator;
      updateSNControls();
      if(el('optRedPisCof') && s.optPisCof!==undefined){ el('optRedPisCof').value=s.optPisCof; el('optRedPisCof').dispatchEvent(new Event('change')); }
      if(el('optRedIssIcms') && s.optIssIcms!==undefined){ el('optRedIssIcms').value=s.optIssIcms; el('optRedIssIcms').dispatchEvent(new Event('change')); }
      if(el('optRedIPI') && s.optIPI!==undefined){ el('optRedIPI').value=s.optIPI; el('optRedIPI').dispatchEvent(new Event('change')); }
      if(el('optRedCBSIBS') && s.optCBSIBS!==undefined){ el('optRedCBSIBS').value=s.optCBSIBS; el('optRedCBSIBS').dispatchEvent(new Event('change')); }
      if(el('optRedSeletivo') && s.optSeletivo!==undefined){ el('optRedSeletivo').value=s.optSeletivo; el('optRedSeletivo').dispatchEvent(new Event('change')); }
      if(el('optRedIRPJ') && s.optIRPJ!==undefined){ el('optRedIRPJ').value=s.optIRPJ; el('optRedIRPJ').dispatchEvent(new Event('change')); }
      if(el('redPisCof') && s.redPC!==undefined) el('redPisCof').value=s.redPC;
      if(el('redISSICMS') && s.redII!==undefined) el('redISSICMS').value=s.redII;
      if(el('redIPI') && s.redIPI!==undefined) el('redIPI').value=s.redIPI;
      if(el('redCBSIBS') && s.redCB!==undefined) el('redCBSIBS').value=s.redCB;
      if(el('redSeletivo') && s.redSE!==undefined) el('redSeletivo').value=s.redSE;
      if(el('redIRPJ') && s.redIR!==undefined) el('redIRPJ').value=s.redIR;
      refreshReductionUI();
      aplicaCenarioNovo();
      updatePresumidoInfo();
      baseDataset.length=0;
      if(Array.isArray(s.dataset)){
        s.dataset.forEach(item=>{
          const clone={...item};
          if(clone.addedAt) clone.addedAt=new Date(clone.addedAt);
          baseDataset.push(clone);
        });
      }
      renderBaseDataset();
      if(typeof lockGlobalConfigIfHasItems==='function') lockGlobalConfigIfHasItems();
      suppressActivityPreset = true;
      applyContextUI();
      suppressActivityPreset = false;
      calcula();
    };

    
    document.getElementById('btnExport')?.addEventListener('click', ()=>window.print());
    document.getElementById('btnSimularAgora')?.addEventListener('click', ()=>{
      captureBaseDatasetEntry();
      calcula();
      document.getElementById('comparativoWrap')?.scrollIntoView({behavior:'smooth', block:'start'});
    });
    document.getElementById('btnSimularAgoraAlt')?.addEventListener('click', ()=>{
      captureBaseDatasetEntry();
      calcula();
      document.getElementById('comparativoWrap')?.scrollIntoView({behavior:'smooth', block:'start'});
    });
    // Validation helper for activity presets
    window.runActivityPresetValidation = () => {
      const out = { ok:true, issues:[] };
      const toPct = n => Math.round(Number(n||0));
      Object.values(OPERATION_ACTIVITIES).forEach(cfg=>{
        if(!cfg || !cfg.id || cfg.id==='custom') return;
        const pk = cfg.presKey && PRES_ATIVIDADES[cfg.presKey];
        if(pk){
          const expectIR = toPct(pk.irpj*100);
          const expectCS = toPct(pk.csll*100);
          const gotIR = toPct(cfg.presAliqIrpj);
          const gotCS = toPct(cfg.presAliqCsll);
          if(expectIR!==gotIR || expectCS!==gotCS){
            out.ok=false; out.issues.push({ id:cfg.id, field:'pres', expected:{ irpj:expectIR, csll:expectCS }, got:{ irpj:gotIR, csll:gotCS } });
          }
        }
        const validTipo = ['servico','mercadoria','none',null,undefined];
        if(!validTipo.includes(cfg.tipoOper)){
          out.ok=false; out.issues.push({ id:cfg.id, field:'tipoOper', expected:'servico/mercadoria/none', got:String(cfg.tipoOper) });
        }
      });
      if(!out.ok) console.warn('Activity preset validation issues:', out.issues);
      else console.log('Activity preset validation: OK');
      try{ const m=out.ok?'Valida√ß√£o de segmentos: OK':'Valida√ß√£o: itens com diverg√™ncia (veja o console)'; const ok=out.ok; const elx=document.createElement('div'); elx.style.position='fixed'; elx.style.right='1rem'; elx.style.bottom='1rem'; elx.style.zIndex='9999'; elx.style.background= ok? 'rgba(16,185,129,.95)':'rgba(239,68,68,.95)'; elx.style.color='#fff'; elx.style.padding='.65rem .9rem'; elx.style.borderRadius='.65rem'; elx.textContent=m; document.body.appendChild(elx); setTimeout(()=>{ try{ elx.remove(); }catch(_){ } }, 3200); }catch(_){ }
      return out;
    };
    // Auto-run validation with ?qaAct=1
    try{ const u = new URL(location.href); if(u.searchParams.get('qaAct')==='1'){ setTimeout(()=>window.runActivityPresetValidation(), 250); } }catch(_){ }
    // (mantendo layout original; sem reordena√ß√£o din√¢mica)
    // Remover Service Worker para evitar problemas de cache em viewers restritivos (MCP)
    (async () => {
      try{
        if('serviceWorker' in navigator){
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map(r => r.unregister().catch(()=>{})));
        }
        if('caches' in window){
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k).catch(()=>{})));
        }
      }catch(_){ /* ignore */ }
    })();
    init();
    // Restore last snapshot (if any)
    try{
      const saved = localStorage.getItem('fiscalflash:last') || localStorage.getItem('taxasim:last');
      if(saved){
        const parsed = JSON.parse(saved);
        if(parsed) restore(parsed);
      }
    }catch(_){ }
    updateQuickStats();
    // Fallback: se a CDN do Chart.js falhar, tenta carregar a c√≥pia local e recalcular
    (function(){
      if(typeof Chart==='undefined'){
        try{
          var s=document.createElement('script');
          s.src='vendor/chart.umd.min.js';
          s.defer=true;
          s.onload=function(){ try{ window.applyChartTheme(); calcula(); }catch(_){} };
          document.head.appendChild(s);
        }catch(_){ }
      }
    })();

    // UX smoke test runner (optional): run with ?qa=1 or call window.runUXSmokeTest()
    const __makeToast = (html, ok=true) => {
      const elx = document.createElement('div');
      elx.setAttribute('role','status');
      elx.style.position='fixed'; elx.style.right='1rem'; elx.style.bottom='1rem'; elx.style.zIndex='9999';
      elx.style.background = ok ? 'rgba(16,185,129,.95)' : 'rgba(239,68,68,.95)';
      elx.style.color = '#fff'; elx.style.padding='.75rem 1rem'; elx.style.borderRadius='.75rem'; elx.style.boxShadow='var(--shadow-md)';
      elx.innerHTML = html;
      document.body.appendChild(elx);
      setTimeout(()=>{ try{ elx.remove(); }catch(_){} }, 3500);
      return elx;
    };
    window.runUXSmokeTest = async () => {
      const out = { steps:[], pass:true };
      const step = (name, fn) => {
        try{ const r = fn(); out.steps.push({ name, ok:true, info:r }); return r; }
        catch(e){ out.steps.push({ name, ok:false, error:String(e&&e.message||e) }); out.pass=false; }
      };
      step('Chart.js loaded', ()=> typeof Chart !== 'undefined');
      step('Capture item', ()=>{ const before = baseDataset.length; captureBaseDatasetEntry(); calcula(); return baseDataset.length>before; });
      step('Item card present', ()=>{ const card = document.querySelector('#baseDatasetLista article.card'); if(!card) throw new Error('card not found'); return true; });
      step('Section blocks present', ()=>{ const card = document.querySelector('#baseDatasetLista article.card'); const labels = [...card.querySelectorAll('.section-block__label')].map(x=>x.textContent.trim()); const need=['Cen√°rio & Config','Valores','Al√≠quotas','Op√ß√µes','Dedu√ß√µes']; const miss=need.filter(x=>!labels.includes(x)); if(miss.length) throw new Error('missing sections: '+miss.join(', ')); return true; });
      step('Toggle edit on', ()=>{ const btn = document.querySelector('#baseDatasetLista [data-entry-edit]'); if(!btn) throw new Error('edit button not found'); btn.click(); return true; });
      step('Inputs editable', ()=>{ const card = document.querySelector('#baseDatasetLista article.card'); const anyDisabled = !!card.querySelector('.w-input:disabled'); if(anyDisabled) throw new Error('some inputs remain disabled'); return true; });
      step('Toggle edit off', ()=>{ const btn = document.querySelector('#baseDatasetLista [data-entry-edit]'); if(!btn) throw new Error('edit button not found'); btn.click(); return true; });
      step('Inputs readonly style', ()=>{ const card = document.querySelector('#baseDatasetLista article.card'); const ro = card.querySelector('.w-input.opacity-60.bg-slate-100'); if(!ro) throw new Error('readonly style not applied'); return true; });
      console.log('UX smoke test:', out);
      __makeToast(out.pass? 'Teste UX: OK' : 'Teste UX: falhas ‚Äî ver console', out.pass);
      return out;
    };
    try{ const url = new URL(location.href); if(url.searchParams.get('qa')==='1'){ setTimeout(()=>window.runUXSmokeTest(), 300); } }catch(_){ }
  </script>
</main>





  <!-- Script para alternar entre temas claro e escuro.  
       Ele verifica o tema salvo em localStorage ou as prefer√™ncias do sistema 
       e aplica a classe correspondente no elemento raiz. Ao clicar no bot√£o 
       com id="themeToggle", o tema √© alternado e o √≠cone do bot√£o √© atualizado. -->
  <script>
    (function(){
      const toggleBtn = document.getElementById('themeToggle');
      if(!toggleBtn) return;
      const applyTheme = (theme) => {
        document.documentElement.setAttribute('data-theme', theme);
        // Atualiza o √≠cone: lua (üåô) para modo claro, sol (‚òÄÔ∏è) para modo escuro
        toggleBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        // Atualiza a cor do tema para a barra do navegador
        const themeMeta = document.querySelector('meta[name="theme-color"]');
        if(themeMeta){ themeMeta.setAttribute('content', theme === 'dark' ? '#1A2F4A' : '#1E3A8A'); }
        // Atualiza atributos de acessibilidade do bot√£o de tema
        const toLabel = theme === 'dark' ? 'Alternar para modo claro' : 'Alternar para modo escuro';
        toggleBtn.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
        toggleBtn.setAttribute('aria-label', toLabel);
        toggleBtn.setAttribute('title', toLabel);
        try{ window.applyChartTheme(theme); }catch(_){ }
      };
      const storedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initialTheme = storedTheme || (prefersDark ? 'dark' : 'light');
      applyTheme(initialTheme);
      toggleBtn.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
      });
    })();
  </script>
</body></html>
